# 80.16 Ralph Phase 6: Intelligence

This is the Ralph Wiggum task document for Phase 6 - Food intelligence and cost tracking.

---

## Frontmatter

```yaml
phase: 6
name: Intelligence
description: Food analysis, cost tracking, household consumption
test_command: pytest tests/phase6/ -v --tb=short
browser_validation: true
estimated_criteria: 11
```

---

## Overview

Phase 6 adds intelligence features:

- Household member management
- Consumption logging
- Ingredient analysis (allergens, concerns)
- Cost tracking (DCA)
- Purchase history

---

## Acceptance Criteria

### Household Members

- [ ] **[1] [CRITICAL]** People table
  - Test: `\d people` shows name, allergies, dietary_restrictions

- [ ] **[2] [CRITICAL]** Consumption logging
  - Test: `\d consumption_logs` links person, product, quantity
  - Test: `POST /api/v2/consumption` creates log entry

- [ ] **[3] [CORE]** Routines (daily vitamins, etc.)
  - Test: `\d routines` shows schedule, items
  - Test: Routine completion tracked

### Food Analysis

- [ ] **[4] [CORE]** Ingredient parsing from product data
  - Test: `POST /api/v2/products/{id}/analyze` extracts ingredients
  - Test: Allergens detected from ingredient list

- [ ] **[5] [CORE]** Processing concerns detection
  - Test: Seed oils flagged in analysis
  - Test: Artificial colors/flavors detected

- [ ] **[6] [CORE]** Household allergen alerts
  - Test: Product with milk triggers alert for milk-allergic person
  - BrowserMCP: Warning banner shows on product detail

### Cost Tracking

- [ ] **[7] [CRITICAL]** Stores and purchases tables
  - Test: `\d stores` and `\d purchases` exist
  - Test: `\d purchase_items` links to products

- [ ] **[8] [CRITICAL]** Record purchase endpoint
  - Test: `POST /api/v2/purchases` creates purchase with items
  - Test: Product costs updated via DCA

- [ ] **[9] [CORE]** Dollar Cost Averaging calculation
  - Test: Average cost updates on new purchase
  - Test: Cost history maintained

- [ ] **[10] [CORE]** Product cost view
  - BrowserMCP: Product detail shows avg cost, purchase history
  - BrowserMCP: Chart shows price over time

- [ ] **[11] [FLEX]** Spending summary by category/store
  - Test: `GET /api/v2/purchases/summary` returns aggregates

---

## Test Command

```bash
# Run all Phase 6 tests
pytest tests/phase6/ -v --tb=short

# Specific test files
pytest tests/phase6/test_people.py -v
pytest tests/phase6/test_consumption.py -v
pytest tests/phase6/test_food_analysis.py -v
pytest tests/phase6/test_cost_tracking.py -v
```

---

## Dependencies

- Phase 2 complete (products)
- Phase 3 complete (UI)

---

## Files to Create/Modify

```
app/
├── models/
│   ├── person.py            # Household members
│   ├── consumption.py       # Consumption logs
│   ├── routine.py           # Daily routines
│   ├── store.py             # Stores
│   └── purchase.py          # Purchases
├── api/routes/
│   ├── people.py            # People endpoints
│   ├── consumption.py       # Consumption endpoints
│   ├── food_analysis.py     # Analysis endpoints
│   └── purchases.py         # Purchase endpoints
├── services/
│   ├── person.py
│   ├── consumption.py
│   ├── food_analysis/
│   │   ├── __init__.py
│   │   ├── ingredients.py   # Ingredient parsing
│   │   ├── allergens.py     # Allergen detection
│   │   └── concerns.py      # Processing concerns
│   └── cost_tracking.py     # DCA calculations
└── schemas/
    ├── person.py
    ├── consumption.py
    ├── food_analysis.py
    └── purchase.py

frontend/src/
├── pages/
│   ├── HouseholdPage.vue    # People management
│   ├── ConsumptionLog.vue   # Log entries
│   ├── RoutinesPage.vue     # Daily routines
│   └── PurchasesPage.vue    # Purchase history
└── components/
    ├── PersonCard.vue
    ├── AllergenAlert.vue
    ├── CostChart.vue
    └── AddPurchaseDialog.vue

migrations/versions/
├── 012_people.py
├── 013_consumption.py
├── 014_routines.py
├── 015_stores.py
└── 016_purchases.py

tests/phase6/
├── test_people.py
├── test_consumption.py
├── test_routines.py
├── test_food_analysis.py
└── test_cost_tracking.py
```

---

## BrowserMCP Validation Checklist

```markdown
1. [ ] Add household member with allergy
2. [ ] View product, allergen warning appears
3. [ ] Log consumption for person
4. [ ] Create daily routine
5. [ ] Record purchase with items
6. [ ] View product cost history
7. [ ] Check spending summary
```

---

## Navigation

- **Previous:** [Phase 5: Recipes & Lists](80.15-ralph-phase-5-recipes.md)
- **Next:** [Phase 7: Documents & Returns](80.17-ralph-phase-7-documents.md)
- **Back to:** [README](README.md)
