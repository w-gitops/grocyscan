# 70.14 Cost Tracking

This document specifies the cost tracking and Dollar Cost Averaging (DCA) system for Homebot.

---

## 70.14.1 Overview

Track spending and costs per product:

- **Purchase tracking** - Record purchases with prices
- **Dollar Cost Averaging** - Running average cost per unit
- **Store management** - Track where you shop
- **Receipt linking** - Connect to Paperless-ngx documents
- **Price history** - See cost trends over time

---

## 70.14.2 Costing Methods

### Dollar Cost Averaging (DCA)

Default method for consumables:

```
Average Cost = Total Spent / Total Units Purchased

Example:
- Purchase 1: 4 cans @ $1.00 each = $4.00
- Purchase 2: 6 cans @ $1.20 each = $7.20
- Total: 10 cans for $11.20
- DCA = $11.20 / 10 = $1.12 per can
```

### Specific Identification

For tracked instances (LPN):

```
Each instance has its own purchase price.
When consumed, that specific cost is recorded.

Example:
- Instance A (Advil bottle): $12.99
- Instance B (Advil bottle): $14.99 (price went up)
- Consuming from A uses $12.99 cost
```

---

## 70.14.3 Data Model

### Stores

```sql
CREATE TABLE stores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    name VARCHAR(100) NOT NULL,
    store_type VARCHAR(50),  -- grocery, pharmacy, wholesale, online
    
    -- Location
    address TEXT,
    city VARCHAR(100),
    state VARCHAR(50),
    
    -- Online stores
    website_url VARCHAR(255),
    
    -- Return policy link
    return_policy_id UUID REFERENCES return_policies(id),
    
    -- Visual
    logo_url TEXT,
    color VARCHAR(7),
    
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Purchases

```sql
CREATE TABLE purchases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    store_id UUID REFERENCES stores(id),
    
    -- Purchase info
    purchase_date DATE NOT NULL,
    total_amount DECIMAL(10, 2),
    tax_amount DECIMAL(10, 2),
    
    -- Receipt
    receipt_document_id INTEGER,  -- Paperless-ngx document ID
    receipt_image_url TEXT,
    
    -- Order tracking (online)
    order_number VARCHAR(100),
    
    notes TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE purchases ENABLE ROW LEVEL SECURITY;
CREATE POLICY purchases_tenant_isolation ON purchases
    USING (tenant_id = current_setting('app.tenant_id')::uuid);
```

### Purchase Line Items

```sql
CREATE TABLE purchase_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    purchase_id UUID NOT NULL REFERENCES purchases(id),
    
    product_id UUID REFERENCES products(id),
    product_name VARCHAR(255) NOT NULL,  -- Denormalized
    
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10, 2) NOT NULL,
    total_price DECIMAL(10, 2) NOT NULL,
    
    -- Discounts
    discount_amount DECIMAL(10, 2) DEFAULT 0,
    coupon_code VARCHAR(50),
    
    -- For LPN tracking
    instance_id UUID REFERENCES product_instances(id),
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Product Cost Summary

```sql
-- Materialized view for DCA calculations
CREATE MATERIALIZED VIEW product_cost_summary AS
SELECT 
    p.id AS product_id,
    p.tenant_id,
    COUNT(pi.id) AS purchase_count,
    SUM(pi.quantity) AS total_units,
    SUM(pi.total_price) AS total_spent,
    SUM(pi.total_price) / NULLIF(SUM(pi.quantity), 0) AS average_cost,
    MIN(pi.unit_price) AS min_price,
    MAX(pi.unit_price) AS max_price,
    MAX(pu.purchase_date) AS last_purchase_date
FROM products p
LEFT JOIN purchase_items pi ON pi.product_id = p.id
LEFT JOIN purchases pu ON pu.id = pi.purchase_id
GROUP BY p.id, p.tenant_id;

-- Refresh periodically
CREATE INDEX idx_product_cost_product ON product_cost_summary(product_id);
```

---

## 70.14.4 DCA Calculation

```python
from decimal import Decimal
from sqlalchemy import func

async def get_product_dca(product_id: UUID, db: Session) -> Decimal:
    """Calculate Dollar Cost Average for a product."""
    
    result = db.query(
        func.sum(PurchaseItem.quantity).label('total_qty'),
        func.sum(PurchaseItem.total_price).label('total_cost')
    ).filter(
        PurchaseItem.product_id == product_id
    ).first()
    
    if result.total_qty and result.total_qty > 0:
        return result.total_cost / result.total_qty
    return Decimal('0')


async def update_product_dca(product_id: UUID, db: Session):
    """Update the cached DCA on product record."""
    
    dca = await get_product_dca(product_id, db)
    
    db.query(Product).filter(
        Product.id == product_id
    ).update({
        'average_cost': dca,
        'cost_updated_at': datetime.utcnow()
    })
```

---

## 70.14.5 UI Design

### Product Cost View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cheerios (18oz)                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Cost Summary                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Average Cost:     $4.52                                   â”‚  â”‚
â”‚  â”‚ Price Range:      $3.99 - $5.49                           â”‚  â”‚
â”‚  â”‚ Total Purchased:  12 boxes                                â”‚  â”‚
â”‚  â”‚ Total Spent:      $54.24                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Price History                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  $6 â”¤                                                     â”‚  â”‚
â”‚  â”‚     â”‚      â•­â”€â”€â•®                                           â”‚  â”‚
â”‚  â”‚  $5 â”¤   â•­â”€â”€â•¯  â•°â”€â”€â•®                                       â”‚  â”‚
â”‚  â”‚     â”‚ â”€â”€â•¯        â•°â”€â”€â”€â”€â”€â”€                                  â”‚  â”‚
â”‚  â”‚  $4 â”¤                                                     â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  â”‚
â”‚  â”‚       Jan    Feb    Mar    Apr    May                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Recent Purchases                                                â”‚
â”‚  â€¢ Feb 1, 2026 - Target - $4.99                                 â”‚
â”‚  â€¢ Jan 15, 2026 - Costco (2-pack) - $3.99 each                  â”‚
â”‚  â€¢ Jan 2, 2026 - Target - $5.49                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Add Purchase

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Add Purchase                                           [Save]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Store: [Target â–¼]              Date: [Feb 3, 2026    ğŸ“…]       â”‚
â”‚                                                                  â”‚
â”‚  Items:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Product          Qty    Unit Price    Total               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ [Cheerios 18oz]  [2]    [$4.99]       $9.98    [ğŸ—‘ï¸]       â”‚  â”‚
â”‚  â”‚ [Milk 1gal    ]  [1]    [$3.49]       $3.49    [ğŸ—‘ï¸]       â”‚  â”‚
â”‚  â”‚ [Eggs dozen   ]  [2]    [$4.29]       $8.58    [ğŸ—‘ï¸]       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              [+ Add Item]       â”‚
â”‚                                                                  â”‚
â”‚  Subtotal:  $21.05                                              â”‚
â”‚  Tax:       [$1.68        ]                                     â”‚
â”‚  Total:     $22.73                                              â”‚
â”‚                                                                  â”‚
â”‚  Receipt: [Upload] or [Link from Paperless]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.14.6 API Endpoints

### Record Purchase

```http
POST /api/v2/purchases
Content-Type: application/json

{
  "store_id": "...",
  "purchase_date": "2026-02-03",
  "items": [
    {
      "product_id": "...",
      "quantity": 2,
      "unit_price": 4.99
    }
  ],
  "tax_amount": 1.68,
  "receipt_document_id": 12345
}
```

### Get Product Cost History

```http
GET /api/v2/products/{id}/costs

Response:
{
  "product_id": "...",
  "average_cost": 4.52,
  "min_price": 3.99,
  "max_price": 5.49,
  "total_purchased": 12,
  "total_spent": 54.24,
  "price_history": [
    { "date": "2026-02-01", "price": 4.99, "store": "Target" },
    { "date": "2026-01-15", "price": 3.99, "store": "Costco" }
  ]
}
```

### Get Spending Summary

```http
GET /api/v2/spending/summary?period=month

Response:
{
  "period": "2026-02",
  "total_spent": 456.78,
  "by_store": [
    { "store": "Target", "amount": 234.56 },
    { "store": "Costco", "amount": 156.22 }
  ],
  "by_category": [
    { "category": "Groceries", "amount": 312.45 },
    { "category": "Household", "amount": 144.33 }
  ]
}
```

---

## 70.14.7 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-CST-01 | As a user, I want to see the average cost of products I buy | [CRITICAL] |
| US-CST-02 | As a user, I want to record purchases with prices | [CRITICAL] |
| US-CST-03 | As a user, I want to track which stores I shop at | [CORE] |
| US-CST-04 | As a user, I want to see price history for products | [CORE] |
| US-CST-05 | As a user, I want to link receipts to purchases | [FLEX] |
| US-CST-06 | As a user, I want to see monthly spending summaries | [FLEX] |

---

## Navigation

- **Previous:** [Food Intelligence](70.13-food-intelligence.md)
- **Next:** [Paperless Integration](70.15-paperless-integration.md)
- **Back to:** [README](README.md)
