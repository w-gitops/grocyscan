# 60.13 Label Printing

This document specifies the label printing system for Homebot, including Brother QL printer integration and label template design.

---

## 60.13.1 Overview

Homebot supports printing labels for:

- **Products** - Name, barcode, QR code, expiration date
- **Locations** - QR code for scanning into location
- **Containers** - QR code for container tracking
- **Instances** - LPN labels for tracked items

---

## 60.13.2 Supported Hardware

### Primary: Brother QL Series

| Model | Label Width | Connection | Status |
|-------|-------------|------------|--------|
| QL-800 | 12-62mm | USB | Supported |
| QL-810W | 12-62mm | USB, WiFi | Supported |
| QL-820NWB | 12-62mm | USB, WiFi, Bluetooth | Supported |
| QL-1100 | 12-103mm | USB | Supported |

### Integration Library

```python
# Using brother_ql library (Python 3.13 compatible fork)
from brother_ql.raster import BrotherQLRaster
from brother_ql.backends.helpers import send

def print_label(image: Image, printer_url: str, label_size: str = "62"):
    """Print a PIL Image to Brother QL printer."""
    qlr = BrotherQLRaster('QL-810NWB')
    qlr.exception_on_warning = True
    
    instructions = brother_ql.conversion.convert(
        qlr=qlr,
        images=[image],
        label=label_size,
        rotate='auto',
        threshold=70,
        dither=False,
        compress=False,
        red=False,
        dpi_600=False,
        hq=True,
        cut=True
    )
    
    send(instructions=instructions, printer_identifier=printer_url)
```

---

## 60.13.3 Label Templates

### Template Model

```sql
CREATE TABLE label_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    name VARCHAR(100) NOT NULL,
    description TEXT,
    
    -- Template type
    entity_type VARCHAR(50) NOT NULL,  -- product, location, container, instance
    label_size VARCHAR(20) NOT NULL,   -- 62, 62x29, 29, etc.
    
    -- Template definition (JSON)
    template JSONB NOT NULL,
    
    -- Flags
    is_default BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(tenant_id, name)
);
```

### Template Schema

```typescript
interface LabelTemplate {
  // Canvas
  width: number;    // mm
  height: number;   // mm
  dpi: number;      // 300 for Brother QL
  
  // Elements
  elements: LabelElement[];
  
  // Orientation
  rotate: 0 | 90 | 180 | 270;
}

type LabelElement = 
  | TextElement 
  | BarcodeElement 
  | QRCodeElement 
  | ImageElement 
  | LineElement
  | RectangleElement;

interface TextElement {
  type: 'text';
  x: number;
  y: number;
  width: number;
  height: number;
  
  // Content (supports variables)
  content: string;  // e.g., "{{product.name}}"
  
  // Styling
  fontSize: number;
  fontFamily: string;
  fontWeight: 'normal' | 'bold';
  textAlign: 'left' | 'center' | 'right';
  
  // Text fitting
  autoShrink: boolean;
  maxLines: number;
}

interface QRCodeElement {
  type: 'qrcode';
  x: number;
  y: number;
  size: number;  // mm
  
  // Content
  content: string;  // e.g., "{{qr_url}}"
  
  // Error correction
  errorCorrection: 'L' | 'M' | 'Q' | 'H';
}

interface BarcodeElement {
  type: 'barcode';
  x: number;
  y: number;
  width: number;
  height: number;
  
  // Content
  content: string;  // e.g., "{{product.barcode}}"
  
  // Format
  format: 'code128' | 'ean13' | 'upc-a' | 'code39';
  showText: boolean;
}
```

---

## 60.13.4 Template Variables

### Product Labels

| Variable | Description | Example |
|----------|-------------|---------|
| `{{product.name}}` | Product name | "Organic Milk" |
| `{{product.barcode}}` | Barcode | "012345678901" |
| `{{product.brand}}` | Brand name | "Horizon" |
| `{{product.size}}` | Size/weight | "64 oz" |
| `{{qr_url}}` | Full QR routing URL | "https://homebot.example.com/q/K3D-7K3QF-X" |
| `{{qr_code}}` | QR code only | "K3D-7K3QF-X" |
| `{{stock.expiration}}` | Expiration date | "2026-03-15" |
| `{{stock.expiration_short}}` | Short date | "03/15" |
| `{{now}}` | Print date | "2026-02-03" |

### Location Labels

| Variable | Description | Example |
|----------|-------------|---------|
| `{{location.name}}` | Location name | "Kitchen Pantry" |
| `{{location.path}}` | Full path | "Home > Kitchen > Pantry" |
| `{{qr_url}}` | QR routing URL | "https://homebot.example.com/q/LOC-A3BCD-X" |

### Instance Labels (LPN)

| Variable | Description | Example |
|----------|-------------|---------|
| `{{instance.lpn}}` | License plate number | "K3D-7K3QF-X" |
| `{{instance.product_name}}` | Product name | "Advil 200mg" |
| `{{instance.serial}}` | Serial number | "SN-12345" |
| `{{instance.remaining}}` | Remaining units | "93 / 100" |

---

## 60.13.5 Default Templates

### Product Label (62mm)

```json
{
  "width": 62,
  "height": 29,
  "dpi": 300,
  "elements": [
    {
      "type": "text",
      "x": 2,
      "y": 2,
      "width": 38,
      "height": 12,
      "content": "{{product.name}}",
      "fontSize": 14,
      "fontWeight": "bold",
      "autoShrink": true,
      "maxLines": 2
    },
    {
      "type": "text",
      "x": 2,
      "y": 15,
      "width": 38,
      "height": 6,
      "content": "Exp: {{stock.expiration_short}}",
      "fontSize": 10
    },
    {
      "type": "qrcode",
      "x": 42,
      "y": 2,
      "size": 18,
      "content": "{{qr_url}}",
      "errorCorrection": "M"
    },
    {
      "type": "text",
      "x": 2,
      "y": 22,
      "width": 38,
      "height": 5,
      "content": "{{qr_code}}",
      "fontSize": 8,
      "textAlign": "center"
    }
  ]
}
```

### Location Label (62mm)

```json
{
  "width": 62,
  "height": 29,
  "dpi": 300,
  "elements": [
    {
      "type": "qrcode",
      "x": 2,
      "y": 2,
      "size": 25,
      "content": "{{qr_url}}",
      "errorCorrection": "H"
    },
    {
      "type": "text",
      "x": 30,
      "y": 5,
      "width": 30,
      "height": 20,
      "content": "{{location.name}}",
      "fontSize": 16,
      "fontWeight": "bold",
      "autoShrink": true
    }
  ]
}
```

---

## 60.13.6 Label Designer UI

### Basic Editor

```
┌─────────────────────────────────────────────────────────────────┐
│  Label Designer                                    [Save] [Print]│
├─────────────────────────────────────────────────────────────────┤
│ Template: [Product Label 62mm ▼]    Size: [62x29mm ▼]           │
├───────────────────────────────┬─────────────────────────────────┤
│                               │  Elements                       │
│   ┌─────────────────────┐     │  ─────────                      │
│   │ Product Name        │     │  [+] Text                       │
│   │ ──────────────────  │     │  [+] QR Code                    │
│   │ Exp: 03/15          │     │  [+] Barcode                    │
│   │                [QR] │     │  [+] Image                      │
│   │ K3D-7K3QF-X         │     │  [+] Line                       │
│   └─────────────────────┘     │                                 │
│                               │  Selected: Product Name         │
│   Preview (actual size)       │  ─────────────────────          │
│                               │  Font: [14 ▼] [Bold ▼]          │
│                               │  Content: {{product.name}}      │
│                               │  [x] Auto-shrink                │
└───────────────────────────────┴─────────────────────────────────┘
```

---

## 60.13.7 API Endpoints

### Print Label

```http
POST /api/v2/labels/print
Content-Type: application/json

{
  "template_id": "...",
  "entity_type": "product",
  "entity_id": "...",
  "printer_id": "...",
  "copies": 1,
  "data_overrides": {
    "stock.expiration": "2026-03-15"
  }
}
```

### Preview Label

```http
POST /api/v2/labels/preview
Content-Type: application/json

{
  "template_id": "...",
  "entity_type": "product",
  "entity_id": "..."
}

Response: PNG image
```

### Batch Print

```http
POST /api/v2/labels/print/batch
Content-Type: application/json

{
  "template_id": "...",
  "items": [
    { "entity_type": "product", "entity_id": "...", "copies": 2 },
    { "entity_type": "location", "entity_id": "...", "copies": 1 }
  ],
  "printer_id": "..."
}
```

---

## 60.13.8 Printer Management

### Printer Model

```sql
CREATE TABLE printers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    name VARCHAR(100) NOT NULL,
    model VARCHAR(50) NOT NULL,
    
    -- Connection
    connection_type VARCHAR(20) NOT NULL,  -- usb, network, bluetooth
    connection_url VARCHAR(255) NOT NULL,  -- tcp://192.168.1.100:9100
    
    -- Settings
    default_label_size VARCHAR(20) DEFAULT '62',
    is_default BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    
    last_seen_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Connection URLs

| Type | Format | Example |
|------|--------|---------|
| USB | `usb://VID:PID` | `usb://04F9:209B` |
| Network | `tcp://HOST:PORT` | `tcp://192.168.1.100:9100` |
| File (testing) | `file:///path` | `file:///tmp/label.bin` |

---

## 60.13.9 Webhook Triggers

Labels can be printed automatically via webhooks:

```yaml
# On stock add, print expiration label
trigger: stock.added
conditions:
  - product.category IN ['dairy', 'meat', 'produce']
action:
  type: print_label
  template: product_expiration
  printer: kitchen_printer
```

---

## 60.13.10 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-LBL-01 | As a user, I want to print QR labels for my pantry locations | [CRITICAL] |
| US-LBL-02 | As a user, I want to print product labels with expiration dates | [CRITICAL] |
| US-LBL-03 | As a user, I want to design custom label templates | [CORE] |
| US-LBL-04 | As a user, I want to batch print labels for multiple items | [CORE] |
| US-LBL-05 | As a user, I want labels to auto-print when I add perishables | [FLEX] |

---

## Navigation

- **Previous:** [Device Preferences](60.12-device-preferences.md)
- **Next:** [Container Management](60.14-container-management.md)
- **Back to:** [README](README.md)
