# 80.12 Ralph Phase 2: Inventory Core

This is the Ralph Wiggum task document for Phase 2 - Inventory management.

---

## Frontmatter

```yaml
phase: 2
name: Inventory Core
description: Products, locations, stock tracking, and barcode scanning
test_command: pytest tests/phase2/ -v --tb=short
browser_validation: false
estimated_criteria: 12
```

---

## Overview

Phase 2 implements core inventory functionality:

- Product CRUD operations
- Location hierarchy
- Stock tracking (add, consume, transfer)
- Barcode lookup integration
- Basic search

---

## Acceptance Criteria

### Products

- [ ] **[1] [CRITICAL]** Products table with all required fields
  - Test: `\d products` shows name, barcode, category, min_stock, attributes

- [ ] **[2] [CRITICAL]** Product CRUD endpoints
  - Test: `POST /api/v2/products` creates product
  - Test: `GET /api/v2/products/{id}` returns product
  - Test: `PATCH /api/v2/products/{id}` updates product
  - Test: `DELETE /api/v2/products/{id}` soft-deletes

- [ ] **[3] [CORE]** Product search by name, barcode, category
  - Test: `GET /api/v2/products?q=milk` returns matching products
  - Test: `GET /api/v2/products?barcode=123456` returns exact match

### Locations

- [ ] **[4] [CRITICAL]** Locations table with hierarchy support
  - Test: `\d locations` shows parent_id, location_type, path

- [ ] **[5] [CRITICAL]** Location closure table for efficient queries
  - Test: `\d location_closure` shows ancestor_id, descendant_id, depth

- [ ] **[6] [CORE]** Location CRUD with hierarchy management
  - Test: `POST /api/v2/locations` creates location
  - Test: Creating child location updates closure table
  - Test: `GET /api/v2/locations/{id}/descendants` returns tree

### Stock Management

- [ ] **[7] [CRITICAL]** Stock tracking table
  - Test: `\d stock` shows product_id, location_id, quantity, expiration_date

- [ ] **[8] [CRITICAL]** Add stock endpoint
  - Test: `POST /api/v2/stock/add` increases quantity
  - Test: Adding to new location creates stock record

- [ ] **[9] [CRITICAL]** Consume stock endpoint
  - Test: `POST /api/v2/stock/consume` decreases quantity
  - Test: Consuming more than available returns error

- [ ] **[10] [CORE]** Transfer stock between locations
  - Test: `POST /api/v2/stock/transfer` moves stock
  - Test: Transfer creates audit trail

### Barcode Lookup

- [ ] **[11] [CORE]** OpenFoodFacts integration
  - Test: `GET /api/v2/lookup/barcode/{code}` returns product data
  - Test: Unknown barcode returns 404

- [ ] **[12] [FLEX]** UPC Database fallback
  - Test: Product found in UPC when not in OFF

---

## Test Command

```bash
# Run all Phase 2 tests
pytest tests/phase2/ -v --tb=short

# Specific test files
pytest tests/phase2/test_products.py -v
pytest tests/phase2/test_locations.py -v
pytest tests/phase2/test_stock.py -v
pytest tests/phase2/test_lookup.py -v
```

---

## Dependencies

- Phase 1 complete (database, auth)

---

## Files to Create/Modify

```
app/
├── models/
│   ├── product.py          # Product model
│   ├── location.py         # Location + closure
│   └── stock.py            # Stock model
├── api/routes/
│   ├── products.py         # Product endpoints
│   ├── locations.py        # Location endpoints
│   ├── stock.py            # Stock endpoints
│   └── lookup.py           # Barcode lookup
├── services/
│   ├── product.py          # Product service
│   ├── location.py         # Location service
│   ├── stock.py            # Stock service
│   └── lookup/
│       ├── __init__.py
│       ├── openfoodfacts.py
│       └── upc.py
└── schemas/
    ├── product.py
    ├── location.py
    └── stock.py

migrations/versions/
├── 002_products.py
├── 003_locations.py
└── 004_stock.py

tests/phase2/
├── conftest.py
├── test_products.py
├── test_locations.py
├── test_stock.py
└── test_lookup.py
```

---

## Navigation

- **Previous:** [Phase 1: Foundation](80.11-ralph-phase-1-foundation.md)
- **Next:** [Phase 3: Device & UI](80.13-ralph-phase-3-device-ui.md)
- **Back to:** [README](README.md)
