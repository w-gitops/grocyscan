# 70.17 Integrations & Settings

This document specifies the integrations configuration UI, service port management, and URL/CORS settings for Homebot.

---

## 70.17.1 Overview

The Integrations page provides:

- **Service status** - Health of connected services
- **Port configuration** - Internal ports for reverse proxy setup
- **URL settings** - Base URL for link generation
- **CORS configuration** - Allowed origins
- **External integrations** - Grocy, Home Assistant, Paperless-ngx

---

## 70.17.2 Service Ports Reference

| Service | Internal Port | Purpose | Health Endpoint |
|---------|---------------|---------|-----------------|
| Homebot API | 3334 | Main backend | `/health` |
| Homebot UI | 3335 | Vue.js SPA | `/` |
| PostgreSQL | 5432 | Database | N/A |
| Redis | 6379 | Cache/Sessions | `PING` |
| Paperless-ngx | 8001 | Documents | `/api/` |
| Grafana | 3000 | Dashboards | `/api/health` |
| Prometheus | 9090 | Metrics | `/-/healthy` |
| Loki | 3100 | Logs | `/ready` |
| Tempo | 3200 | Traces | `/ready` |

---

## 70.17.3 Settings Data Model

```sql
CREATE TABLE tenant_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) UNIQUE,
    
    -- URL Configuration
    base_url VARCHAR(255),  -- https://homebot.example.com
    
    -- CORS
    cors_origins TEXT[],  -- Allowed origins
    
    -- Grocy Integration
    grocy_enabled BOOLEAN DEFAULT FALSE,
    grocy_url VARCHAR(255),
    grocy_api_key_encrypted BYTEA,
    
    -- Paperless Integration  
    paperless_enabled BOOLEAN DEFAULT FALSE,
    paperless_url VARCHAR(255),
    paperless_token_encrypted BYTEA,
    
    -- Home Assistant Integration
    hass_enabled BOOLEAN DEFAULT FALSE,
    hass_url VARCHAR(255),
    hass_token_encrypted BYTEA,
    
    -- Feature flags
    features JSONB DEFAULT '{}',
    
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE tenant_settings ENABLE ROW LEVEL SECURITY;
CREATE POLICY settings_tenant_isolation ON tenant_settings
    USING (tenant_id = current_setting('app.tenant_id')::uuid);
```

---

## 70.17.4 URL Configuration

### Base URL

The base URL is used for:

- **QR code generation** - Full URLs in printed QR codes
- **Email links** - Password reset, notifications
- **API responses** - Resource URLs in REST responses
- **PWA manifest** - Start URL configuration

```typescript
interface URLConfig {
  // Primary URL for the application
  baseUrl: string;  // https://homebot.example.com
  
  // API URL (if different from base)
  apiUrl?: string;  // https://homebot.example.com/api
  
  // QR routing prefix
  qrPrefix: string;  // https://homebot.example.com/q/
}
```

### Configuration UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  URL Configuration                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Base URL:                                                       â”‚
â”‚  [https://homebot.example.com                              ]    â”‚
â”‚  Used for QR codes, email links, and API URLs                   â”‚
â”‚                                                                  â”‚
â”‚  Example QR URL: https://homebot.example.com/q/K3D-7K3QF-X      â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸  Changing this will invalidate existing printed QR codes    â”‚
â”‚      if the old URL no longer works.                            â”‚
â”‚                                                                  â”‚
â”‚                                                    [Save Changes]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.17.5 CORS Configuration

### Allowed Origins

```typescript
interface CORSConfig {
  // List of allowed origins
  allowedOrigins: string[];
  
  // Allow credentials (cookies, auth headers)
  allowCredentials: boolean;
  
  // Allowed methods
  allowedMethods: string[];  // GET, POST, PUT, DELETE, PATCH
  
  // Max age for preflight cache
  maxAge: number;  // seconds
}
```

### Default Configuration

```python
# Backend CORS settings
CORS_ORIGINS = [
    "https://homebot.example.com",
    "http://localhost:3335",  # Local development
    "capacitor://localhost",   # Mobile app
    "http://localhost",        # Capacitor iOS
]

CORS_ALLOW_CREDENTIALS = True
CORS_ALLOW_METHODS = ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
CORS_MAX_AGE = 600
```

---

## 70.17.6 Integrations UI

### Main Integrations Page

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Integrations                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ“„ Paperless-ngx                              ğŸŸ¢ Connected  â”‚â”‚
â”‚  â”‚ Document management and receipt OCR                         â”‚â”‚
â”‚  â”‚ URL: http://192.168.200.37:8001               [Configure]   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ  Home Assistant                             âšª Not Setup  â”‚â”‚
â”‚  â”‚ Smart home integration                                      â”‚â”‚
â”‚  â”‚                                                [Setup]      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ¥« Grocy (Compatibility)                      âšª Not Setup  â”‚â”‚
â”‚  â”‚ Sync with existing Grocy instance                           â”‚â”‚
â”‚  â”‚                                                [Setup]      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ“Š Grafana                                    ğŸŸ¢ Available  â”‚â”‚
â”‚  â”‚ Observability dashboards                                    â”‚â”‚
â”‚  â”‚ URL: http://192.168.200.37:3000               [Open]        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Integration Configuration Dialog

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Configure Paperless-ngx                              [X Close] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  URL:                                                            â”‚
â”‚  [http://192.168.200.37:8001                               ]    â”‚
â”‚                                                                  â”‚
â”‚  API Token:                                                      â”‚
â”‚  [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                       ]    â”‚
â”‚  Get token from Paperless-ngx Admin â†’ API Tokens                â”‚
â”‚                                                                  â”‚
â”‚  â˜‘ï¸  Enable receipt auto-linking                                â”‚
â”‚  â˜  Auto-import documents tagged "homebot"                      â”‚
â”‚                                                                  â”‚
â”‚  Status: ğŸŸ¢ Connected (last check: 2 minutes ago)               â”‚
â”‚                                                                  â”‚
â”‚                                    [Test Connection] [Save]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.17.7 Service Status API

### Health Check Endpoint

```http
GET /api/v2/integrations/health

Response:
{
  "homebot": {
    "status": "healthy",
    "version": "1.0.0",
    "uptime_seconds": 86400
  },
  "database": {
    "status": "healthy",
    "latency_ms": 2
  },
  "redis": {
    "status": "healthy",
    "latency_ms": 1
  },
  "paperless": {
    "status": "healthy",
    "enabled": true,
    "url": "http://192.168.200.37:8001"
  },
  "grocy": {
    "status": "not_configured",
    "enabled": false
  }
}
```

### Integration Settings

```http
GET /api/v2/settings/integrations

Response:
{
  "base_url": "https://homebot.example.com",
  "cors_origins": ["https://homebot.example.com"],
  "integrations": {
    "paperless": {
      "enabled": true,
      "url": "http://192.168.200.37:8001",
      "features": {
        "receipt_linking": true,
        "auto_import": false
      }
    },
    "grocy": {
      "enabled": false
    },
    "home_assistant": {
      "enabled": false
    }
  }
}
```

### Update Settings

```http
PATCH /api/v2/settings/integrations
Content-Type: application/json

{
  "base_url": "https://homebot.example.com",
  "paperless": {
    "enabled": true,
    "url": "http://192.168.200.37:8001",
    "token": "..."
  }
}
```

---

## 70.17.8 Reverse Proxy Guide

### Service Port Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Reverse Proxy Configuration                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  For nginx, Traefik, or Caddy, route these internal ports:      â”‚
â”‚                                                                  â”‚
â”‚  homebot.example.com                                            â”‚
â”‚    /        â†’ localhost:3335  (Frontend)                        â”‚
â”‚    /api     â†’ localhost:3334  (Backend API)                     â”‚
â”‚    /q/      â†’ localhost:3334  (QR Routing)                      â”‚
â”‚    /ws      â†’ localhost:3334  (WebSocket)                       â”‚
â”‚                                                                  â”‚
â”‚  paperless.example.com                                          â”‚
â”‚    /        â†’ localhost:8001                                    â”‚
â”‚                                                                  â”‚
â”‚  grafana.example.com                                            â”‚
â”‚    /        â†’ localhost:3000                                    â”‚
â”‚                                                                  â”‚
â”‚  Internal only (do not expose):                                 â”‚
â”‚    PostgreSQL:  5432                                            â”‚
â”‚    Redis:       6379                                            â”‚
â”‚    Prometheus:  9090                                            â”‚
â”‚    Loki:        3100                                            â”‚
â”‚    Tempo:       3200                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.17.9 Environment Variables

```bash
# URL Configuration
HOMEBOT_BASE_URL=https://homebot.example.com

# CORS (comma-separated)
CORS_ORIGINS=https://homebot.example.com,http://localhost:3335

# Paperless Integration
PAPERLESS_URL=http://192.168.200.37:8001
PAPERLESS_TOKEN=your-api-token

# Grocy Integration (optional)
GROCY_URL=http://grocy.local
GROCY_API_KEY=your-grocy-key

# Home Assistant (optional)
HASS_URL=http://homeassistant.local:8123
HASS_TOKEN=your-long-lived-token
```

---

## 70.17.10 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-INT-01 | As an admin, I want to see the status of all connected services | [CRITICAL] |
| US-INT-02 | As an admin, I want to configure the base URL for QR codes | [CRITICAL] |
| US-INT-03 | As an admin, I want to connect Homebot to Paperless-ngx | [CORE] |
| US-INT-04 | As an admin, I want to see port numbers for reverse proxy setup | [CORE] |
| US-INT-05 | As an admin, I want to configure CORS for my domain | [FLEX] |
| US-INT-06 | As an admin, I want to connect to my existing Grocy instance | [FUTURE] |

---

## Navigation

- **Previous:** [Return Tracking](70.16-return-tracking.md)
- **Next:** [Ralph Phases Overview](80.10-ralph-phases-overview.md)
- **Back to:** [README](README.md)
