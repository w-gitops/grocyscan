# 80.135 Ralph Phase 3.5: Inventory Parity

This is the Ralph Wiggum task document for Phase 3.5 - Achieving full Grocy inventory parity and beyond.

---

## Frontmatter

```yaml
phase: 3.5
name: Inventory Parity
description: Full Grocy inventory parity - quantity units, stock operations, location UI, undo
test_command: pytest tests/phase3_5/ tests/phase3/ tests/phase2/ -v --tb=short && cd frontend && npm run test
browser_validation: true
browser_url: http://localhost:3335
estimated_criteria: 17
```

---

## Overview

Phase 3.5 brings Homebot inventory management to full Grocy parity and beyond:

- Multiple quantity units per product (purchase, stock, consume) with conversions
- Enhanced product fields (best-before settings, parent products, tare weight)
- Rich stock entries (price, purchased date, open status, notes)
- Advanced stock operations (inventory, open, edit, undo)
- Location management UI (CRUD, hierarchy, reorder)
- Stock entry UI (view, edit, move, batch operations)

---

## Gap Analysis

| Feature Area | Homebot (Current) | Grocy | Gap |
|--------------|-------------------|-------|-----|
| Quantity Units | Single unit per product | Purchase/Stock/Consume/Price units + conversions | Missing |
| Stock Quantity | Integer | Decimal (15,2) | Missing |
| Best-Before Settings | None | Default days, after-open, after-freezing, after-thawing | Missing |
| Stock Entry Fields | expiration_date only | price, purchased_date, open, note, stock_id | Missing |
| Stock Operations | Add, Consume, Transfer | + Inventory, Open, Edit, Undo | Missing |
| Transaction Log | Basic | + user_id, spoiled, correlation_id, undo tracking | Missing |
| Location UI | API only | Full CRUD in UI | Missing |
| Stock Entry UI | None | Edit individual entries, move, inventory | Missing |

---

## Acceptance Criteria

### Database Schema (Migration 0011)

- [ ] **[1] [CRITICAL]** Quantity units table and product quantity unit FKs
  - Create `homebot.quantity_units` table (id, tenant_id, name, name_plural, description)
  - Add to products: `qu_id_purchase`, `qu_id_stock`, `qu_id_consume` (nullable FKs)
  - Create `homebot.quantity_unit_conversions` table (product_id, from_qu_id, to_qu_id, factor)
  - Test: `\d homebot.quantity_units` shows columns
  - Test: Products can reference different units for purchase vs stock

- [ ] **[2] [CRITICAL]** Product best-before settings
  - Add to products: `default_best_before_days` (int, nullable)
  - Add: `default_best_before_days_after_open` (int, nullable)
  - Add: `default_best_before_days_after_freezing` (int, nullable, -1 = never expires)
  - Add: `default_best_before_days_after_thawing` (int, nullable)
  - Add: `due_type` (int, 1=best-before, 2=expiration, default 1)
  - Test: Product with `default_best_before_days=7` auto-calculates expiration on add

- [ ] **[3] [CRITICAL]** Product advanced fields
  - Add: `parent_product_id` (UUID FK to products, nullable)
  - Add: `default_location_id` (UUID FK to locations, nullable)
  - Add: `default_consume_location_id` (UUID FK to locations, nullable)
  - Add: `tare_weight` (decimal, nullable)
  - Add: `enable_tare_weight_handling` (boolean, default false)
  - Add: `calories` (int, nullable)
  - Add: `quick_consume_amount` (decimal, default 1)
  - Add: `move_on_open` (boolean, default false)
  - Add: `should_not_be_frozen` (boolean, default false)
  - Test: Product with `default_location_id` uses it when adding stock without location

- [ ] **[4] [CRITICAL]** Stock entry enhancements
  - Change `quantity` from INTEGER to DECIMAL(15,2)
  - Add: `stock_id` (varchar(36), unique tracking ID for Grocycode)
  - Add: `purchased_date` (date, nullable)
  - Add: `price` (decimal(13,2), nullable)
  - Add: `open` (boolean, default false)
  - Add: `opened_date` (date, nullable)
  - Add: `note` (text, nullable)
  - Add: `shopping_location_id` (UUID FK to locations, nullable)
  - Test: Stock entry created with decimal quantity (e.g., 1.5)
  - Test: Stock entry has unique `stock_id` generated on creation

- [ ] **[5] [CRITICAL]** Transaction log enhancements
  - Add: `user_id` (UUID, nullable)
  - Add: `product_id` (UUID FK, for easier queries)
  - Add: `spoiled` (boolean, default false)
  - Add: `correlation_id` (UUID, links transfer pairs)
  - Add: `transaction_id` (UUID, groups multiple entries in one operation)
  - Add: `undone` (boolean, default false)
  - Add: `undone_timestamp` (datetime, nullable)
  - Test: Transfer creates two log entries with same `correlation_id`
  - Test: Undo sets `undone=true` and `undone_timestamp`

- [ ] **[6] [CORE]** Product groups table
  - Create `homebot.product_groups` table (id, tenant_id, name, description)
  - Add to products: `product_group_id` (UUID FK, nullable)
  - Test: Product can be assigned to a group
  - Test: List products by group works

---

### Stock Operations API

- [ ] **[7] [CRITICAL]** Inventory operation (set stock to specific amount)
  - `POST /api/v2/stock/inventory`
  - Request: `{ product_id, new_amount, location_id?, best_before_date? }`
  - If current stock < new_amount: creates add transaction
  - If current stock > new_amount: creates consume transaction
  - Transaction type: `inventory-correction`
  - Test: Setting stock from 5 to 3 creates consume of 2
  - Test: Setting stock from 2 to 7 creates add of 5

- [ ] **[8] [CRITICAL]** Open product operation
  - `POST /api/v2/stock/open`
  - Request: `{ stock_entry_id, amount? }`
  - Sets `open=true`, `opened_date=today`
  - If product has `default_best_before_days_after_open`: recalculates best_before_date
  - If product has `move_on_open` and `default_consume_location_id`: transfers to that location
  - Creates `product-opened` transaction
  - Test: Opening product with `default_best_before_days_after_open=3` sets new expiration
  - Test: Opening product with `move_on_open=true` transfers to consume location

- [ ] **[9] [CRITICAL]** Edit stock entry
  - `PATCH /api/v2/stock/entries/{entry_id}`
  - Editable fields: amount, best_before_date, location_id, price, note, open
  - Creates `stock-edit-old` transaction (old values) and `stock-edit-new` transaction (new values)
  - Both transactions share same `correlation_id`
  - Test: Editing amount from 5 to 3 creates edit transaction pair
  - Test: Moving entry to different location via edit works

- [ ] **[10] [CORE]** Undo operation
  - `POST /api/v2/stock/undo/{transaction_id}`
  - Reverses the effect of a transaction
  - For transfers: undoes both `transfer_from` and `transfer_to` (via `correlation_id`)
  - Sets `undone=true`, `undone_timestamp=now()` on affected transactions
  - Returns error if transaction already undone
  - Returns error if dependent transactions exist
  - Test: Undo consume restores stock quantity
  - Test: Undo transfer reverses both legs

- [ ] **[11] [CORE]** Freezer auto-adjust best-before dates
  - On transfer TO a freezer location:
    - If product has `default_best_before_days_after_freezing`: set new best_before_date
    - If value is -1: set best_before_date to null (never expires)
  - On transfer FROM a freezer location:
    - If product has `default_best_before_days_after_thawing`: set new best_before_date
  - Respect `should_not_be_frozen` flag (warn or prevent)
  - Test: Transfer to freezer with `after_freezing=-1` clears expiration
  - Test: Transfer from freezer sets new expiration based on thawing days

---

### Location Management UI (Vue/Quasar)

- [ ] **[12] [CRITICAL]** Location list with hierarchy
  - Vue route: `/locations` (LocationsPage.vue)
  - Display locations as indented list or tree view (q-tree or nested q-list)
  - Show: name, type, is_freezer badge (q-badge), stock count
  - Click location to view/edit details
  - Add `data-testid` attributes for Playwright testing
  - Test: Playwright - Navigate to /locations, see location tree
  - Test: Playwright - Location tree shows hierarchy correctly

- [ ] **[13] [CRITICAL]** Location CRUD in UI
  - Create: q-dialog with name, type (room/shelf/drawer/etc), parent dropdown, is_freezer toggle
  - Edit: Same dialog pre-filled with current values
  - Delete: Confirm dialog, warn if location has stock, prevent if has children
  - Add `data-testid` attributes: location-add-btn, location-edit-dialog, location-delete-btn
  - Test: Playwright - Create new location "Garage Freezer" with is_freezer=true
  - Test: Playwright - Edit location name
  - Test: Playwright - Delete empty location

- [ ] **[14] [CORE]** Reorder locations
  - Up/down arrows or drag-and-drop (q-sortable) to change sort_order
  - Move to different parent (change hierarchy)
  - Update closure table on parent change
  - Test: Playwright - Move location up in list
  - Test: Playwright - Change location parent

---

### Stock Entry UI (Vue/Quasar)

- [ ] **[15] [CORE]** View stock entries for product
  - Vue route: `/products/{id}` with stock entries section (ProductDetailPage.vue)
  - List all stock entries: location, quantity, best_before_date, open status, price, note
  - Visual indicators: expiring soon (warning color), expired (negative color), opened (q-icon)
  - Click entry to open edit dialog
  - Add `data-testid` attributes: stock-entry-list, stock-entry-row, stock-entry-edit-btn
  - Test: Playwright - View product, see stock entries listed

- [ ] **[16] [CORE]** Move stock dialog
  - Select one or more stock entries (q-checkbox)
  - Choose destination location from dropdown (q-select)
  - Confirm button executes transfer for each selected entry
  - Add `data-testid` attributes: stock-move-btn, stock-move-dialog, stock-move-confirm
  - Test: Playwright - Select entry, move to different location

- [ ] **[17] [FLEX]** Inventory correction dialog
  - Available from product detail or stock overview
  - Input: "Set total stock to:" with number input (q-input type="number")
  - Shows current stock and calculated adjustment
  - Confirm creates inventory-correction transaction
  - Add `data-testid` attributes: inventory-correction-btn, inventory-correction-dialog
  - Test: Playwright - Set stock to specific amount via dialog

---

## Test Command

```bash
# Run Phase 3.5 tests (includes Phase 2 and 3 regression)
pytest tests/phase3_5/ tests/phase3/ tests/phase2/ -v --tb=short

# Specific test files
pytest tests/phase3_5/test_quantity_units.py -v
pytest tests/phase3_5/test_stock_operations.py -v
pytest tests/phase3_5/test_undo.py -v
pytest tests/phase3_5/test_location_ui.py -v
```

---

## Dependencies

- Phase 1 complete (database, auth)
- Phase 2 complete (products, locations, stock)
- Phase 3 complete (device, Vue/Quasar UI scaffold)

---

## Files to Create/Modify

```
migrations/versions/
└── 20260204_0011_inventory_parity.py    # Schema changes

app/
├── db/
│   └── homebot_models.py                # Updated models
├── api/routes/v2/
│   ├── stock.py                         # New operations (inventory, open, edit, undo)
│   ├── locations.py                     # Location CRUD enhancements
│   └── quantity_units.py                # New router for QU management
├── services/
│   └── stock_service.py                 # Business logic for operations
└── schemas/
    ├── stock.py                         # Updated schemas
    └── quantity_unit.py                 # New schemas

frontend/src/
├── pages/
│   ├── LocationsPage.vue                # Location management UI (enhanced)
│   └── ProductDetailPage.vue            # Stock entries section (new/enhanced)
├── components/
│   ├── LocationTree.vue                 # Hierarchical location display
│   ├── LocationDialog.vue               # Create/edit location dialog
│   ├── StockEntryList.vue               # Stock entries for product
│   ├── StockMoveDialog.vue              # Move stock between locations
│   └── InventoryCorrectionDialog.vue    # Set stock to specific amount
├── stores/
│   ├── locations.js                     # Pinia store for locations
│   └── stock.js                         # Pinia store for stock entries
└── services/
    └── api.js                           # API client (add new endpoints)

frontend/tests/
├── pages/
│   └── locations.page.js                # Page object for locations
├── specs/
│   ├── locations.spec.js                # Playwright tests for location UI
│   └── stock-entries.spec.js            # Playwright tests for stock entry UI
└── fixtures/
    └── stock.fixture.js                 # Test data for stock operations

tests/phase3_5/
├── conftest.py
├── test_quantity_units.py
├── test_stock_operations.py
├── test_undo.py
└── test_freezer_adjust.py
```

---

## Migration Strategy

1. Add new columns as nullable first
2. Generate `stock_id` for existing stock entries (UUID or short code)
3. Set default values for boolean fields
4. No NOT NULL constraints on new optional fields

---

## Playwright Test Coverage

New Vue components require Playwright tests following the project's testing standards:

```markdown
# Phase 3.5 Playwright Tests (localhost:3335)

## Location Management (locations.spec.js)
1. [ ] LOC-TREE-01: Navigate to /locations, tree displays correctly
2. [ ] LOC-CREATE-01: Create new location via dialog
3. [ ] LOC-CREATE-02: Create child location (hierarchy)
4. [ ] LOC-CREATE-03: Create freezer location (is_freezer=true)
5. [ ] LOC-EDIT-01: Edit existing location name
6. [ ] LOC-EDIT-02: Edit location parent (move in hierarchy)
7. [ ] LOC-DELETE-01: Delete empty location
8. [ ] LOC-DELETE-02: Prevent delete of location with stock (warning)
9. [ ] LOC-REORDER-01: Reorder locations via drag or arrows

## Stock Entry Management (stock-entries.spec.js)
10. [ ] STOCK-VIEW-01: View product stock entries list
11. [ ] STOCK-VIEW-02: Visual indicators for expiring/expired/opened
12. [ ] STOCK-EDIT-01: Edit stock entry (amount, price, note)
13. [ ] STOCK-MOVE-01: Move single stock entry to different location
14. [ ] STOCK-MOVE-02: Batch move multiple entries
15. [ ] STOCK-INV-01: Set inventory to specific amount via dialog
16. [ ] STOCK-OPEN-01: Mark product as opened
17. [ ] STOCK-UNDO-01: Undo recent transaction
```

### data-testid Attributes Required

All new components must include `data-testid` attributes per testing standards:

| Component | Required data-testid |
|-----------|---------------------|
| LocationsPage | location-tree, location-add-btn |
| LocationDialog | location-name-input, location-parent-select, location-freezer-toggle, location-save-btn |
| StockEntryList | stock-entry-list, stock-entry-row-{id}, stock-entry-edit-btn |
| StockMoveDialog | stock-move-location-select, stock-move-confirm-btn |
| InventoryCorrectionDialog | inventory-amount-input, inventory-confirm-btn |

---

## Navigation

- **Previous:** [Phase 3: Device & UI](80.13-ralph-phase-3-device-ui.md)
- **Next:** [Phase 4: Labels & QR](80.14-ralph-phase-4-labels-qr.md)
- **Back to:** [Phases Overview](80.10-ralph-phases-overview.md)
