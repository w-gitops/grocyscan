# 40.15 Deployment

This document covers the deployment architecture and procedures for Homebot.

---

## 40.15.1 Target Environment

| Property | Value |
|----------|-------|
| **Host** | `192.168.200.37` |
| **SSH** | `root@192.168.200.37` |
| **OS** | Debian 12 (bookworm) |
| **Install Path** | `/opt/homebot/` |
| **Service** | `homebot` (systemd) |
| **Python** | 3.13+ (via pyenv or deadsnakes) |
| **Node.js** | 20 LTS (for frontend build) |

---

## 40.15.2 Service Architecture

> **Current Implementation Note:** The codebase currently uses **NiceGUI** (Python, server-rendered) integrated with the FastAPI backend on port 3334. There is no separate frontend service yet. The Vue 3 + Quasar frontend on port 3335 is the **target architecture** for Phase 3. Until then, reverse proxy should route all traffic to port 3334. See [DEC-051](91.14-decision-log.md#dec-051-ui-stack-and-pwa-alignment) for details.

### Target Architecture (Phase 3+)

```
┌─────────────────────────────────────────────────────────────────┐
│                        192.168.200.37                            │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                     │
│  │  Homebot API     │  │  Homebot UI      │                     │
│  │  (FastAPI)       │  │  (Vue/Quasar)    │                     │
│  │  Port: 3334      │  │  Port: 3335      │                     │
│  └────────┬─────────┘  └────────┬─────────┘                     │
│           │                     │                                │
│  ┌────────┴─────────────────────┴─────────┐                     │
│  │              PostgreSQL 17              │                     │
│  │              Port: 5432                 │                     │
│  └─────────────────────────────────────────┘                     │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │     Redis       │  │  Paperless-ngx  │  │    Grafana      │  │
│  │   Port: 6379    │  │   Port: 8001    │  │   Port: 3000    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Prometheus    │  │      Loki       │  │     Tempo       │  │
│  │   Port: 9090    │  │   Port: 3100    │  │   Port: 3200    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 40.15.3 Service Ports

| Service | Internal Port | Purpose | Reverse Proxy |
|---------|---------------|---------|---------------|
| Homebot API + NiceGUI (current) | 3334 | Backend + interim UI | `homebot.example.com` (all routes) |
| Homebot API (target) | 3334 | Main backend | `homebot.example.com/api` |
| Homebot UI (target) | 3335 | Vue.js SPA | `homebot.example.com` |
| PostgreSQL | 5432 | Database | Internal only |
| Redis | 6379 | Cache/Sessions | Internal only |
| Paperless-ngx | 8001 | Document management | `paperless.example.com` |
| Grafana | 3000 | Observability | `grafana.example.com` |
| Prometheus | 9090 | Metrics | Internal only |
| Loki | 3100 | Log aggregation | Internal only |
| Tempo | 3200 | Tracing | Internal only |

---

## 40.15.4 Directory Structure

```
/opt/homebot/
├── backend/
│   ├── app/
│   ├── migrations/
│   ├── tests/
│   ├── pyproject.toml
│   └── requirements.txt
├── frontend/
│   ├── dist/          # Built Vue.js app
│   └── src/
├── docker/
│   ├── docker-compose.yml
│   ├── docker-compose.observability.yml
│   └── docker-compose.paperless.yml
├── scripts/
│   ├── deploy.sh
│   └── backup.sh
├── data/
│   ├── photos/        # Product photos
│   └── labels/        # Label templates
├── venv/              # Python virtual environment
├── .env               # Environment configuration
└── logs/
```

---

## 40.15.5 Systemd Service

```ini
# /etc/systemd/system/homebot.service
[Unit]
Description=Homebot API Server
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=homebot
Group=homebot
WorkingDirectory=/opt/homebot/backend
Environment="PATH=/opt/homebot/venv/bin"
EnvironmentFile=/opt/homebot/.env
ExecStart=/opt/homebot/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 3334
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

---

## 40.15.6 Docker Compose Stack

### Main Application

```yaml
# docker/docker-compose.yml
version: "3.8"

services:
  postgres:
    image: postgres:17
    environment:
      POSTGRES_USER: homebot
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: homebot
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

### Paperless-ngx Stack

```yaml
# docker/docker-compose.paperless.yml
version: "3.8"

services:
  paperless-webserver:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    depends_on:
      - paperless-redis
      - paperless-gotenberg
      - paperless-tika
    ports:
      - "8001:8000"
    environment:
      PAPERLESS_REDIS: redis://paperless-redis:6379
      PAPERLESS_DBHOST: postgres  # Use shared PostgreSQL
      PAPERLESS_DBNAME: paperless
      PAPERLESS_DBUSER: paperless
      PAPERLESS_TIKA_ENABLED: 1
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://paperless-gotenberg:3000
      PAPERLESS_TIKA_ENDPOINT: http://paperless-tika:9998
    volumes:
      - paperless_data:/usr/src/paperless/data
      - paperless_media:/usr/src/paperless/media
      - paperless_consume:/usr/src/paperless/consume
    restart: unless-stopped

  paperless-redis:
    image: redis:7-alpine
    restart: unless-stopped

  paperless-gotenberg:
    image: gotenberg/gotenberg:7.10
    restart: unless-stopped

  paperless-tika:
    image: ghcr.io/paperless-ngx/tika:latest
    restart: unless-stopped

volumes:
  paperless_data:
  paperless_media:
  paperless_consume:
```

### Observability Stack

```yaml
# docker/docker-compose.observability.yml
version: "3.8"

services:
  prometheus:
    image: prom/prometheus:v2.49.1
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.4
    ports:
      - "3100:3100"
    volumes:
      - loki_data:/loki
    restart: unless-stopped

  promtail:
    image: grafana/promtail:2.9.4
    volumes:
      - /opt/homebot/logs:/var/log/homebot:ro
      - ./promtail.yml:/etc/promtail/config.yml
    restart: unless-stopped

  tempo:
    image: grafana/tempo:2.3.1
    ports:
      - "3200:3200"
      - "4317:4317"  # OTLP gRPC
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.3.1
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped

volumes:
  prometheus_data:
  loki_data:
  grafana_data:
```

---

## 40.15.7 Deployment Scripts

### Windows PowerShell (Local)

```powershell
# scripts/deploy.ps1

param(
    [string]$Target = "all"  # all, backend, frontend
)

$Server = "root@192.168.200.37"
$RemotePath = "/opt/homebot"

function Deploy-Backend {
    Write-Host "Deploying backend..." -ForegroundColor Cyan
    
    # Sync backend files
    rsync -avz --exclude '__pycache__' --exclude '.pytest_cache' `
        ./backend/ ${Server}:${RemotePath}/backend/
    
    # Install dependencies and restart
    ssh $Server @"
        cd $RemotePath
        source venv/bin/activate
        pip install -r backend/requirements.txt
        alembic upgrade head
        systemctl restart homebot
"@
}

function Deploy-Frontend {
    Write-Host "Deploying frontend..." -ForegroundColor Cyan
    
    # Build locally
    Push-Location frontend
    npm run build
    Pop-Location
    
    # Sync built files
    rsync -avz ./frontend/dist/ ${Server}:${RemotePath}/frontend/dist/
}

switch ($Target) {
    "backend" { Deploy-Backend }
    "frontend" { Deploy-Frontend }
    "all" { Deploy-Backend; Deploy-Frontend }
}

Write-Host "Deployment complete!" -ForegroundColor Green
```

### Quick File Deploy

```powershell
# Deploy single file and restart
$file = "app/api/routes/scan.py"
type "backend\$file" | ssh root@192.168.200.37 "cat > /opt/homebot/backend/$file && systemctl restart homebot"
```

---

## 40.15.8 Database Setup

### Initial Setup

```sql
-- Create databases and users
CREATE USER homebot WITH PASSWORD 'secure_password';
CREATE DATABASE homebot OWNER homebot;

CREATE USER paperless WITH PASSWORD 'secure_password';
CREATE DATABASE paperless OWNER paperless;

-- Enable extensions
\c homebot
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
```

### RLS Configuration

```sql
-- Create app role for RLS
CREATE ROLE homebot_app;
GRANT homebot_app TO homebot;

-- Set tenant context on connection
ALTER DATABASE homebot SET app.tenant_id TO '';
```

---

## 40.15.9 Backup Strategy

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="/opt/backups/homebot"
DATE=$(date +%Y%m%d_%H%M%S)

# Database backup
pg_dump -Fc homebot > "$BACKUP_DIR/db_homebot_$DATE.dump"
pg_dump -Fc paperless > "$BACKUP_DIR/db_paperless_$DATE.dump"

# Photo backup
tar -czf "$BACKUP_DIR/photos_$DATE.tar.gz" /opt/homebot/data/photos

# Keep last 7 days
find "$BACKUP_DIR" -type f -mtime +7 -delete
```

---

## 40.15.10 URL Configuration

### Environment Variables

```bash
# Base URL for link generation (QR codes, emails)
HOMEBOT_BASE_URL=https://homebot.example.com

# CORS allowed origins
CORS_ORIGINS=https://homebot.example.com,https://localhost:3335

# API URL for frontend
VITE_API_URL=https://homebot.example.com/api
```

### Reverse Proxy (Nginx)

```nginx
# /etc/nginx/sites-available/homebot
server {
    listen 443 ssl http2;
    server_name homebot.example.com;

    ssl_certificate /etc/letsencrypt/live/homebot.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/homebot.example.com/privkey.pem;

    # Frontend (Vue.js SPA)
    location / {
        proxy_pass http://localhost:3335;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # API
    location /api {
        proxy_pass http://localhost:3334;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # QR routing
    location /q/ {
        proxy_pass http://localhost:3334;
    }

    # WebSocket for real-time updates
    location /ws {
        proxy_pass http://localhost:3334;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## Navigation

- **Previous:** [Environment Variables](40.14-environment-variables.md)
- **Next:** [Testing Strategy](50.10-testing-strategy.md)
- **Back to:** [README](README.md)
