# 70.16 Return Tracking

This document specifies the return deadline tracking system for managing product returns across various retailers.

---

## 70.16.1 Overview

Track return windows for purchased items:

- **Deadline awareness** - Never miss a return window
- **Store policies** - Configure per-retailer return policies
- **State machine** - Track items through return lifecycle
- **Notifications** - Alert before deadlines expire
- **Integration** - Link to receipts in Paperless-ngx

---

## 70.16.2 Return States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ordered   â”‚  (optional, for pre-arrival tracking)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Received
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Received   â”‚  Return window starts
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                     â”‚
       â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Undecided  â”‚  Still evaluating     â”‚   Keeping   â”‚  Decision made
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Decide to return
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Returning  â”‚  Committed to return
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚              â”‚
       â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Labeled   â”‚ â”‚   Packed    â”‚ â”‚   Shipped   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚              â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  Returned   â”‚  Completed
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Alternative endings:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Missed    â”‚         â”‚   Kept      â”‚
â”‚  Deadline   â”‚         â”‚  (changed)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.16.3 Data Model

### Returnable Items

```sql
CREATE TABLE returnable_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    -- What was purchased
    product_id UUID REFERENCES products(id),
    product_name VARCHAR(255) NOT NULL,  -- Denormalized for deleted products
    
    -- Purchase info
    store_id UUID REFERENCES stores(id),
    purchase_id UUID REFERENCES purchases(id),
    purchase_date DATE NOT NULL,
    purchase_price DECIMAL(10, 2),
    
    -- Return policy
    return_policy_id UUID REFERENCES return_policies(id),
    return_deadline DATE NOT NULL,
    
    -- Current state
    status VARCHAR(20) NOT NULL DEFAULT 'received',
    status_changed_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Return details (when returning)
    return_reason TEXT,
    return_method VARCHAR(50),  -- in_store, mail, pickup
    tracking_number VARCHAR(100),
    refund_amount DECIMAL(10, 2),
    refund_received_at TIMESTAMPTZ,
    
    -- Documents
    receipt_document_id INTEGER,  -- Paperless-ngx document ID
    return_label_document_id INTEGER,
    
    -- Notes
    notes TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_returnable_status ON returnable_items(status);
CREATE INDEX idx_returnable_deadline ON returnable_items(return_deadline) 
    WHERE status IN ('received', 'undecided', 'returning');

-- RLS
ALTER TABLE returnable_items ENABLE ROW LEVEL SECURITY;
CREATE POLICY returnable_tenant_isolation ON returnable_items
    USING (tenant_id = current_setting('app.tenant_id')::uuid);
```

### Return Policies

```sql
CREATE TABLE return_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    store_id UUID NOT NULL REFERENCES stores(id),
    
    name VARCHAR(100) NOT NULL,
    
    -- Policy details
    return_window_days INTEGER NOT NULL,  -- Days from purchase
    requires_receipt BOOLEAN DEFAULT TRUE,
    requires_original_packaging BOOLEAN DEFAULT FALSE,
    restocking_fee_percent DECIMAL(5, 2) DEFAULT 0,
    
    -- Exceptions
    excluded_categories TEXT[],  -- Categories that can't be returned
    extended_holiday_window BOOLEAN DEFAULT FALSE,
    holiday_extension_days INTEGER DEFAULT 0,
    
    -- Return methods
    allows_in_store BOOLEAN DEFAULT TRUE,
    allows_mail BOOLEAN DEFAULT TRUE,
    allows_pickup BOOLEAN DEFAULT FALSE,
    
    is_default BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Status History

```sql
CREATE TABLE returnable_status_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    returnable_id UUID NOT NULL REFERENCES returnable_items(id),
    
    from_status VARCHAR(20),
    to_status VARCHAR(20) NOT NULL,
    changed_by UUID REFERENCES users(id),
    notes TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 70.16.4 Store Policies

### Common Retailers

| Store | Window | Receipt | Notes |
|-------|--------|---------|-------|
| Amazon | 30 days | No | Extended for holidays |
| Costco | 90 days | No | Electronics 90 days |
| Target | 90 days | Yes | RedCard gets 120 days |
| Walmart | 90 days | Yes | Electronics 30 days |
| Best Buy | 15 days | Yes | TotalTech 60 days |
| Home Depot | 90 days | Yes | Plants 1 year |
| IKEA | 365 days | Yes | Unopened only |

### Policy Configuration

```json
{
  "store": "Amazon",
  "default_policy": {
    "return_window_days": 30,
    "requires_receipt": false,
    "allows_mail": true,
    "allows_in_store": false
  },
  "category_overrides": [
    {
      "categories": ["electronics"],
      "return_window_days": 30
    },
    {
      "categories": ["furniture", "mattress"],
      "return_window_days": 30,
      "requires_original_packaging": true
    }
  ],
  "holiday_extension": {
    "enabled": true,
    "start_date": "11-01",
    "end_date": "12-31",
    "extended_deadline": "01-31"
  }
}
```

---

## 70.16.5 Notifications

### Notification Schedule

| Trigger | When | Message |
|---------|------|---------|
| Deadline approaching | 7 days before | "Return window for [item] closes in 7 days" |
| Deadline approaching | 3 days before | "Only 3 days left to return [item]" |
| Deadline approaching | 1 day before | "Last day to return [item]!" |
| Deadline passed | Day after | "[item] return window has closed" |
| Status change | Immediately | "[item] marked as [status]" |

### Notification Settings

```sql
CREATE TABLE return_notification_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    user_id UUID NOT NULL REFERENCES users(id),
    
    -- Notification preferences
    notify_7_days BOOLEAN DEFAULT TRUE,
    notify_3_days BOOLEAN DEFAULT TRUE,
    notify_1_day BOOLEAN DEFAULT TRUE,
    notify_missed BOOLEAN DEFAULT TRUE,
    
    -- Channels
    push_enabled BOOLEAN DEFAULT TRUE,
    email_enabled BOOLEAN DEFAULT FALSE,
    
    UNIQUE(tenant_id, user_id)
);
```

---

## 70.16.6 UI Design

### Returns Dashboard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Returns                                         [+ Add Return] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  âš ï¸ Urgent (expires within 7 days)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ”´ USB-C Hub (Amazon)                                     â”‚  â”‚
â”‚  â”‚    Deadline: Feb 10, 2026 (3 days left)                   â”‚  â”‚
â”‚  â”‚    $49.99 â€¢ Undecided                     [Keep] [Return] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“¦ Active Returns                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸŸ¡ Bluetooth Speaker (Best Buy)                           â”‚  â”‚
â”‚  â”‚    Deadline: Feb 28, 2026 (25 days left)                  â”‚  â”‚
â”‚  â”‚    $79.99 â€¢ Returning â†’ Labeled          [Update Status]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  âœ… Recently Completed                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âœ“ Phone Case (Amazon) - Returned Jan 28                   â”‚  â”‚
â”‚  â”‚ âœ“ Desk Lamp (Target) - Kept Jan 25                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Add Return Item

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Add Returnable Item                                    [Save]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Product: [Search or enter name...               ]              â”‚
â”‚                                                                  â”‚
â”‚  Store:   [Amazon â–¼]                                            â”‚
â”‚                                                                  â”‚
â”‚  Purchase Date: [Feb 3, 2026    ğŸ“…]                             â”‚
â”‚                                                                  â”‚
â”‚  Price: [$49.99        ]                                        â”‚
â”‚                                                                  â”‚
â”‚  Return Deadline: Feb 28, 2026 (auto-calculated)                â”‚
â”‚  Policy: Amazon Standard (30 days)                              â”‚
â”‚                                                                  â”‚
â”‚  Receipt: [Upload] or [Link from Paperless]                     â”‚
â”‚                                                                  â”‚
â”‚  Notes: [                                                    ]  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.16.7 API Endpoints

### Create Returnable

```http
POST /api/v2/returns
Content-Type: application/json

{
  "product_id": "...",
  "product_name": "USB-C Hub",
  "store_id": "...",
  "purchase_date": "2026-02-03",
  "purchase_price": 49.99,
  "receipt_document_id": 12345
}
```

### Update Status

```http
PATCH /api/v2/returns/{id}/status
Content-Type: application/json

{
  "status": "returning",
  "notes": "Defective, getting refund"
}
```

### Get Upcoming Deadlines

```http
GET /api/v2/returns?status=active&deadline_before=2026-02-15

Response:
{
  "items": [
    {
      "id": "...",
      "product_name": "USB-C Hub",
      "store": "Amazon",
      "return_deadline": "2026-02-10",
      "days_remaining": 3,
      "status": "undecided"
    }
  ]
}
```

---

## 70.16.8 Integration with Paperless-ngx

### Receipt Linking

When a receipt is processed in Paperless-ngx:

1. OCR extracts purchase date and store
2. User can link receipt to returnable item
3. Receipt document ID stored for reference
4. Return label can also be stored

### Auto-Detection (Future)

```yaml
# Paperless-ngx workflow rule
trigger: document.added
conditions:
  - document_type = 'receipt'
  - correspondent IN ['Amazon', 'Best Buy', ...]
actions:
  - webhook: homebot/api/v2/returns/from-receipt
    payload:
      document_id: "{{ document.id }}"
      store: "{{ correspondent }}"
      date: "{{ document.created }}"
```

---

## 70.16.9 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-RET-01 | As a user, I want to track return deadlines so I don't miss them | [CRITICAL] |
| US-RET-02 | As a user, I want notifications before return windows expire | [CRITICAL] |
| US-RET-03 | As a user, I want to configure store-specific return policies | [CORE] |
| US-RET-04 | As a user, I want to track the status of items I'm returning | [CORE] |
| US-RET-05 | As a user, I want to link receipts to returnable items | [FLEX] |
| US-RET-06 | As a user, I want auto-calculated deadlines based on store policy | [FLEX] |

---

## Navigation

- **Previous:** [Paperless Integration](70.15-paperless-integration.md)
- **Next:** [Integrations Settings](70.17-integrations-settings.md)
- **Back to:** [README](README.md)
