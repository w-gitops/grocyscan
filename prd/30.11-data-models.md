# 30.11 Data Models

## 30.11.1 Entity Relationship Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              HOMEBOT DATA MODEL                                  │
│                                                                                  │
│  CORE ENTITIES                                                                   │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│  │   tenants   │◄────│   users     │     │  products   │◄────│  barcodes   │   │
│  │─────────────│     │─────────────│     │─────────────│     │─────────────│   │
│  │ id (PK)     │     │ id (PK)     │     │ id (PK)     │     │ id (PK)     │   │
│  │ name        │     │ email       │     │ tenant_id   │────▶│ product_id  │   │
│  │ slug        │     │ password    │     │ name        │     │ barcode     │   │
│  └─────────────┘     │ tenant_id   │     │ category    │     └─────────────┘   │
│        │             └─────────────┘     │ attributes  │                       │
│        │                    │            └─────────────┘                       │
│        ▼                    ▼                   │                              │
│  ┌─────────────┐     ┌─────────────┐           │                              │
│  │tenant_      │     │ qr_         │           │                              │
│  │memberships  │     │ namespaces  │           ▼                              │
│  │─────────────│     │─────────────│     ┌─────────────┐     ┌─────────────┐  │
│  │ user_id     │     │ tenant_id   │     │ product_    │◄────│ qr_tokens   │  │
│  │ tenant_id   │     │ code (3ch)  │     │ instances   │     │─────────────│  │
│  │ role        │     └─────────────┘     │─────────────│     │ namespace   │  │
│  └─────────────┘                         │ product_id  │     │ code        │  │
│                                          │ location_id │     │ state       │  │
│  LOCATION HIERARCHY                      │ remaining   │     │ entity_type │  │
│  ┌─────────────┐     ┌─────────────┐     │ expiration  │     │ entity_id   │  │
│  │  locations  │◄────│ location_   │     └─────────────┘     └─────────────┘  │
│  │─────────────│     │ closure     │                                          │
│  │ id (PK)     │     │─────────────│     CONTAINERS                           │
│  │ parent_id   │     │ ancestor_id │     ┌─────────────┐                      │
│  │ name        │     │ descendant  │     │ containers  │                      │
│  │ type        │     │ depth       │     │─────────────│                      │
│  │ sort_order  │     └─────────────┘     │ location_id │                      │
│  └─────────────┘                         │ parent_id   │                      │
│                                          │ qr_token_id │                      │
│  HOUSEHOLD FEATURES                      └─────────────┘                      │
│  ┌─────────────┐     ┌─────────────┐                                          │
│  │   people    │◄────│ consumption │     RECIPES & PLANNING                   │
│  │─────────────│     │ _logs       │     ┌─────────────┐     ┌─────────────┐  │
│  │ name        │     │─────────────│     │   recipes   │◄────│ recipe_     │  │
│  │ allergies   │     │ person_id   │     │─────────────│     │ ingredients │  │
│  │ dietary     │     │ product_id  │     │ name        │     │─────────────│  │
│  └─────────────┘     │ quantity    │     │ servings    │     │ product_id  │  │
│                      └─────────────┘     │ instructions│     │ quantity    │  │
│        │                                 └─────────────┘     └─────────────┘  │
│        ▼                                        │                             │
│  ┌─────────────┐                               ▼                             │
│  │  routines   │                         ┌─────────────┐     ┌─────────────┐  │
│  │─────────────│                         │ meal_plans  │     │ shopping_   │  │
│  │ person_id   │                         │─────────────│     │ lists       │  │
│  │ schedule    │                         │ recipe_id   │     │─────────────│  │
│  │ items       │                         │ plan_date   │     │ items[]     │  │
│  └─────────────┘                         └─────────────┘     └─────────────┘  │
│                                                                               │
│  COST & RETURNS                                                               │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐  │
│  │   stores    │◄────│ purchases   │◄────│ purchase_   │     │ returnable_ │  │
│  │─────────────│     │─────────────│     │ items       │     │ items       │  │
│  │ name        │     │ store_id    │     │─────────────│     │─────────────│  │
│  │ return_     │     │ date        │     │ product_id  │     │ deadline    │  │
│  │ policy      │     │ receipt_id  │     │ unit_price  │     │ status      │  │
│  └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 30.11.2 Core Entities

### Tenants

```sql
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(50) NOT NULL UNIQUE,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE tenant_memberships (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    role VARCHAR(20) NOT NULL DEFAULT 'member',  -- owner, admin, member
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, tenant_id)
);
```

### Users

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    default_tenant_id UUID REFERENCES tenants(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Products

```sql
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(500) NOT NULL,
    name_normalized VARCHAR(500),
    description TEXT,
    category VARCHAR(255),
    quantity_unit VARCHAR(50),
    min_stock_quantity INTEGER DEFAULT 0,
    image_path VARCHAR(500),
    attributes JSONB DEFAULT '{}',
    enable_lpn_tracking BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
CREATE POLICY products_tenant_isolation ON products
    USING (tenant_id = current_setting('app.tenant_id')::uuid);

-- Indexes
CREATE INDEX idx_products_tenant ON products(tenant_id);
CREATE INDEX idx_products_name ON products(tenant_id, name_normalized);
CREATE INDEX idx_products_category ON products(tenant_id, category);
```

### Barcodes

```sql
CREATE TABLE barcodes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    product_id UUID REFERENCES products(id),
    barcode VARCHAR(100) NOT NULL,
    barcode_type VARCHAR(20),  -- UPC-A, EAN-13, etc.
    is_primary BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, barcode)
);
```

## 30.11.3 Location Hierarchy

### Locations with Closure Table

```sql
CREATE TABLE locations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    parent_id UUID REFERENCES locations(id),
    name VARCHAR(255) NOT NULL,
    location_type VARCHAR(50) NOT NULL,  -- property, building, room, area, shelf, drawer
    description TEXT,
    sort_order INTEGER DEFAULT 0,
    is_freezer BOOLEAN DEFAULT FALSE,
    qr_token_id UUID REFERENCES qr_tokens(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Closure table for efficient hierarchy queries
CREATE TABLE location_closure (
    ancestor_id UUID NOT NULL REFERENCES locations(id),
    descendant_id UUID NOT NULL REFERENCES locations(id),
    depth INTEGER NOT NULL,
    PRIMARY KEY (ancestor_id, descendant_id)
);

-- Indexes
CREATE INDEX idx_location_closure_desc ON location_closure(descendant_id);
CREATE INDEX idx_location_closure_depth ON location_closure(depth);
```

### Containers

```sql
CREATE TABLE containers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    location_id UUID NOT NULL REFERENCES locations(id),
    parent_container_id UUID REFERENCES containers(id),
    name VARCHAR(255) NOT NULL,
    container_type VARCHAR(50) NOT NULL,  -- bin, box, bag, basket, tote
    description TEXT,
    qr_token_id UUID REFERENCES qr_tokens(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 30.11.4 QR Token System

### QR Tokens

```sql
CREATE TABLE qr_namespaces (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    code CHAR(3) NOT NULL UNIQUE,  -- 3-char Crockford Base32
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE qr_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    namespace_id UUID NOT NULL REFERENCES qr_namespaces(id),
    code CHAR(5) NOT NULL,  -- 5-char Crockford Base32
    checksum CHAR(1) NOT NULL,  -- Luhn mod 32
    state VARCHAR(20) NOT NULL DEFAULT 'unassigned',  -- unassigned, assigned, revoked
    entity_type VARCHAR(50),  -- product_instance, container, location
    entity_id UUID,
    assigned_at TIMESTAMPTZ,
    revoked_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(namespace_id, code)
);

-- Full token: NS-CODE-CHECK (e.g., K3D-7K3QF-X)
```

## 30.11.5 LPN Instance Tracking

### Product Instances

```sql
CREATE TABLE product_instances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    product_id UUID NOT NULL REFERENCES products(id),
    location_id UUID REFERENCES locations(id),
    container_id UUID REFERENCES containers(id),
    qr_token_id UUID REFERENCES qr_tokens(id),
    serial_number VARCHAR(100),
    initial_quantity INTEGER NOT NULL DEFAULT 1,
    remaining_quantity INTEGER NOT NULL DEFAULT 1,
    quantity_unit VARCHAR(50),
    expiration_date DATE,
    purchase_id UUID REFERENCES purchases(id),
    unit_cost DECIMAL(10, 2),
    status VARCHAR(20) DEFAULT 'active',  -- active, consumed, disposed
    attributes JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Exactly one of location_id or container_id must be set
    CONSTRAINT instance_placement CHECK (
        (location_id IS NOT NULL AND container_id IS NULL) OR
        (location_id IS NULL AND container_id IS NOT NULL)
    )
);

CREATE TABLE instance_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    instance_id UUID NOT NULL REFERENCES product_instances(id),
    transaction_type VARCHAR(20) NOT NULL,  -- consume, adjust, transfer
    quantity_change INTEGER NOT NULL,
    previous_quantity INTEGER NOT NULL,
    new_quantity INTEGER NOT NULL,
    person_id UUID REFERENCES people(id),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 30.11.6 Stock Tracking (Non-LPN)

```sql
CREATE TABLE stock (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    product_id UUID NOT NULL REFERENCES products(id),
    location_id UUID REFERENCES locations(id),
    container_id UUID REFERENCES containers(id),
    quantity INTEGER NOT NULL DEFAULT 0,
    expiration_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE stock_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    stock_id UUID REFERENCES stock(id),
    transaction_type VARCHAR(20) NOT NULL,  -- add, consume, transfer, adjust
    quantity INTEGER NOT NULL,
    from_location_id UUID REFERENCES locations(id),
    to_location_id UUID REFERENCES locations(id),
    person_id UUID REFERENCES people(id),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 30.11.7 Household Features

### People

```sql
CREATE TABLE people (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    user_id UUID REFERENCES users(id),  -- Optional link to system user
    name VARCHAR(100) NOT NULL,
    nickname VARCHAR(50),
    avatar_url TEXT,
    color VARCHAR(7),  -- Hex color
    dietary_restrictions TEXT[],
    allergies TEXT[],
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE consumption_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    product_id UUID REFERENCES products(id),
    instance_id UUID REFERENCES product_instances(id),
    person_id UUID REFERENCES people(id),
    quantity INTEGER NOT NULL DEFAULT 1,
    quantity_unit VARCHAR(50),
    routine_id UUID REFERENCES routines(id),
    notes TEXT,
    consumed_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE routines (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    person_id UUID REFERENCES people(id),
    schedule_type VARCHAR(20) NOT NULL,  -- daily, weekly, custom
    schedule_time TIME,
    schedule_days INTEGER[],
    items JSONB NOT NULL,  -- [{product_id, quantity, quantity_unit}]
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 30.11.8 Recipes & Planning

```sql
CREATE TABLE recipes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(50),
    cuisine VARCHAR(50),
    tags TEXT[],
    prep_time_minutes INTEGER,
    cook_time_minutes INTEGER,
    servings INTEGER NOT NULL DEFAULT 4,
    instructions JSONB,
    photo_url TEXT,
    source_url TEXT,
    nutrition JSONB,
    is_favorite BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE recipe_ingredients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    recipe_id UUID NOT NULL REFERENCES recipes(id) ON DELETE CASCADE,
    product_id UUID REFERENCES products(id),
    name VARCHAR(255) NOT NULL,
    quantity DECIMAL(10, 3) NOT NULL,
    quantity_unit VARCHAR(50) NOT NULL,
    preparation VARCHAR(100),
    group_name VARCHAR(100),
    sort_order INTEGER DEFAULT 0,
    is_optional BOOLEAN DEFAULT FALSE
);

CREATE TABLE meal_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    plan_date DATE NOT NULL,
    meal_type VARCHAR(20) NOT NULL,  -- breakfast, lunch, dinner, snack
    recipe_id UUID REFERENCES recipes(id),
    custom_meal_name VARCHAR(255),
    servings INTEGER,
    status VARCHAR(20) DEFAULT 'planned',
    for_people UUID[],
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(tenant_id, plan_date, meal_type)
);
```

## 30.11.9 Shopping Lists

```sql
CREATE TABLE shopping_lists (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(100) NOT NULL,
    store_id UUID REFERENCES stores(id),
    status VARCHAR(20) DEFAULT 'active',
    due_date DATE,
    source_type VARCHAR(20),
    source_id UUID,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE shopping_list_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    list_id UUID NOT NULL REFERENCES shopping_lists(id) ON DELETE CASCADE,
    product_id UUID REFERENCES products(id),
    name VARCHAR(255) NOT NULL,
    quantity DECIMAL(10, 3) NOT NULL DEFAULT 1,
    quantity_unit VARCHAR(50),
    category VARCHAR(50),
    is_checked BOOLEAN DEFAULT FALSE,
    checked_at TIMESTAMPTZ,
    estimated_price DECIMAL(10, 2),
    actual_price DECIMAL(10, 2),
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 30.11.10 Cost Tracking

```sql
CREATE TABLE stores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    store_type VARCHAR(50),  -- grocery, warehouse, online
    website_url TEXT,
    notes TEXT,
    return_policy JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE purchases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    store_id UUID REFERENCES stores(id),
    purchase_date DATE NOT NULL,
    total_amount DECIMAL(10, 2),
    tax_amount DECIMAL(10, 2),
    receipt_document_id INTEGER,  -- Paperless-ngx document ID
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE purchase_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    purchase_id UUID NOT NULL REFERENCES purchases(id) ON DELETE CASCADE,
    product_id UUID REFERENCES products(id),
    product_name VARCHAR(255) NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price DECIMAL(10, 2),
    total_price DECIMAL(10, 2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Materialized view for cost summary
CREATE MATERIALIZED VIEW product_cost_summary AS
SELECT 
    p.id AS product_id,
    p.tenant_id,
    COUNT(pi.id) AS purchase_count,
    SUM(pi.quantity) AS total_units,
    SUM(pi.total_price) AS total_spent,
    SUM(pi.total_price) / NULLIF(SUM(pi.quantity), 0) AS average_cost,
    MIN(pi.unit_price) AS min_price,
    MAX(pi.unit_price) AS max_price,
    MAX(pu.purchase_date) AS last_purchase_date
FROM products p
LEFT JOIN purchase_items pi ON pi.product_id = p.id
LEFT JOIN purchases pu ON pu.id = pi.purchase_id
GROUP BY p.id, p.tenant_id;
```

## 30.11.11 Return Tracking

```sql
CREATE TABLE return_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    store_id UUID NOT NULL REFERENCES stores(id),
    return_window_days INTEGER NOT NULL DEFAULT 30,
    requires_receipt BOOLEAN DEFAULT TRUE,
    restocking_fee_percent DECIMAL(5, 2) DEFAULT 0,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE returnable_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    product_id UUID REFERENCES products(id),
    product_name VARCHAR(255) NOT NULL,
    store_id UUID REFERENCES stores(id),
    purchase_date DATE NOT NULL,
    purchase_price DECIMAL(10, 2),
    return_policy_id UUID REFERENCES return_policies(id),
    return_deadline DATE NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'received',
    status_changed_at TIMESTAMPTZ DEFAULT NOW(),
    receipt_document_id INTEGER,
    return_label_document_id INTEGER,
    tracking_number VARCHAR(100),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## Navigation

- **Previous:** [Technical Architecture](30.10-technical-architecture.md)
- **Next:** [API Specification](30.12-api-specification.md)
- **Back to:** [README](README.md)
