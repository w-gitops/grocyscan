# 80.14 Ralph Phase 4: Labels & QR

This is the Ralph Wiggum task document for Phase 4 - Label printing and QR routing.

---

## Frontmatter

```yaml
phase: 4
name: Labels & QR
description: QR code system, label printing, instance tracking
test_command: pytest tests/phase4/ -v --tb=short
browser_validation: true
estimated_criteria: 11
```

---

## Overview

Phase 4 implements labeling and QR functionality:

- QR token generation with namespaces
- QR routing (scan → action)
- Label template system
- Brother QL printer integration
- LPN instance tracking

---

## Acceptance Criteria

### QR Token System

- [ ] **[1] [CRITICAL]** QR tokens table with namespace support
  - Test: `\d qr_tokens` shows namespace, code, checksum, state

- [ ] **[2] [CRITICAL]** Token generation with Crockford Base32
  - Test: Generated token matches `NS-CODE-CHECK` format
  - Test: Checksum validates correctly

- [ ] **[3] [CRITICAL]** QR routing endpoint
  - Test: `GET /q/{token}` redirects to appropriate page
  - Test: Unassigned token shows assignment UI
  - Test: Assigned token shows product/location detail

- [ ] **[4] [CORE]** Token assignment to products/locations/instances
  - Test: `POST /api/v2/qr-tokens/{id}/assign` links to entity
  - Test: Re-assignment revokes old token

### Label Templates

- [ ] **[5] [CRITICAL]** Label templates table
  - Test: `\d label_templates` shows name, template_type, schema

- [ ] **[6] [CORE]** Default product and location templates
  - Test: System templates exist for product, location
  - Test: Template renders with variables

- [ ] **[7] [CORE]** Template preview endpoint
  - Test: `POST /api/v2/labels/preview` returns PNG image
  - BrowserMCP: Preview displays in label designer

### Printing

- [ ] **[8] [CRITICAL]** Print label endpoint
  - Test: `POST /api/v2/labels/print` sends to printer
  - Test: Printer URL configurable per tenant

- [ ] **[9] [CORE]** Brother QL integration
  - Test: Label printed to Brother QL-810NWB
  - Test: Multiple label sizes supported (62mm, 29mm)

### LPN Instances

- [ ] **[10] [CRITICAL]** Product instances table
  - Test: `\d product_instances` shows LPN fields, remaining_quantity

- [ ] **[11] [CORE]** Instance consumption tracking
  - Test: Consuming from instance decrements remaining_quantity
  - Test: FIFO order enforced for expiring items

---

## Test Command

```bash
# Run all Phase 4 tests
pytest tests/phase4/ -v --tb=short

# Specific test files
pytest tests/phase4/test_qr_tokens.py -v
pytest tests/phase4/test_labels.py -v
pytest tests/phase4/test_instances.py -v
```

---

## Dependencies

- Phase 2 complete (products, locations)
- Phase 3 complete (UI for label designer)

---

## Files to Create/Modify

```
app/
├── models/
│   ├── qr_token.py          # QR token model
│   ├── label_template.py    # Template model
│   └── product_instance.py  # LPN instance
├── api/routes/
│   ├── qr.py                # QR routing
│   ├── labels.py            # Label endpoints
│   └── instances.py         # Instance endpoints
├── services/
│   ├── qr/
│   │   ├── __init__.py
│   │   ├── generator.py     # Token generation
│   │   └── router.py        # QR routing logic
│   ├── label/
│   │   ├── __init__.py
│   │   ├── renderer.py      # Template rendering
│   │   └── printer.py       # Brother QL integration
│   └── instance.py          # Instance service
└── schemas/
    ├── qr.py
    ├── label.py
    └── instance.py

frontend/src/
├── pages/
│   ├── QrAssignPage.vue     # Unassigned QR landing
│   └── LabelDesigner.vue    # Label template editor
└── components/
    ├── LabelPreview.vue
    └── InstanceDetail.vue

migrations/versions/
├── 006_qr_tokens.py
├── 007_label_templates.py
└── 008_product_instances.py

tests/phase4/
├── test_qr_tokens.py
├── test_qr_routing.py
├── test_labels.py
└── test_instances.py
```

---

## BrowserMCP Validation Checklist

```markdown
1. [ ] Scan unassigned QR, assignment UI appears
2. [ ] Assign QR to product, confirmation shown
3. [ ] Scan assigned QR, product detail loads
4. [ ] Open label designer, template editor works
5. [ ] Preview label, PNG displays
6. [ ] Print label (if printer available)
7. [ ] Create instance with LPN, shown in product detail
```

---

## Navigation

- **Previous:** [Phase 3: Device & UI](80.13-ralph-phase-3-device-ui.md)
- **Next:** [Phase 5: Recipes & Lists](80.15-ralph-phase-5-recipes.md)
- **Back to:** [README](README.md)
