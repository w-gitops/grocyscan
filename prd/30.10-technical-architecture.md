# 30.10 Technical Architecture

## 30.10.1 System Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   CLIENTS                                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │ Mobile PWA  │  │   Tablet    │  │   Desktop   │  │  USB/Bluetooth Scanner  │ │
│  │  (Camera)   │  │ (Primary)   │  │  (Browser)  │  │   (Keyboard Emulation)  │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────────┬────────────┘ │
└─────────┼────────────────┼────────────────┼──────────────────────┼──────────────┘
          └────────────────┴────────────────┴──────────────────────┘
                                   │
                                   ▼
                        ┌─────────────────────┐
                        │   Reverse Proxy     │
                        │  (Caddy/Traefik)    │
                        │   TLS Termination   │
                        └──────────┬──────────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐
│  HOMEBOT FRONTEND   │ │  HOMEBOT BACKEND    │ │    PAPERLESS-NGX    │
│  (Vue 3 + Quasar)   │ │  (FastAPI)          │ │   (Documents)       │
│                     │ │                     │ │                     │
│  Port: 9000         │ │  Port: 3334         │ │  Port: 8001         │
│                     │ │                     │ │                     │
│  ┌───────────────┐  │ │  ┌───────────────┐  │ │  ┌───────────────┐  │
│  │ Pinia Stores  │  │ │  │  /api/v2/*    │  │ │  │ OCR Engine    │  │
│  │ Vue Router    │  │ │  │  /api/* (compat)│ │ │  │ Tagging       │  │
│  │ Quasar UI     │  │ │  │  /q/{token}   │  │ │  │ Classification│  │
│  └───────────────┘  │ │  └───────────────┘  │ │  └───────────────┘  │
└─────────────────────┘ └──────────┬──────────┘ └─────────────────────┘
                                   │
┌──────────────────────────────────┼──────────────────────────────────┐
│                          SERVICES LAYER                              │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────┐│
│  │  Lookup Service │ │   LLM Service   │ │    Integration Service  ││
│  │  ┌───────────┐  │ │  ┌───────────┐  │ │  ┌───────────────────┐  ││
│  │  │OpenFood   │  │ │  │  LiteLLM  │  │ │  │ Grocy Compat API  │  ││
│  │  │Facts      │  │ │  │  Router   │  │ │  │ Paperless Client  │  ││
│  │  ├───────────┤  │ │  ├───────────┤  │ │  │ Home Assistant    │  ││
│  │  │UPC DB     │  │ │  │  OpenAI   │  │ │  └───────────────────┘  ││
│  │  ├───────────┤  │ │  │  Anthropic│  │ └─────────────────────────┘│
│  │  │Brave      │  │ │  │  Ollama   │  │                            │
│  │  │Search     │  │ │  └───────────┘  │ ┌─────────────────────────┐│
│  │  └───────────┘  │ └─────────────────┘ │    Label Service        ││
│  └─────────────────┘                     │  ┌───────────────────┐  ││
│                                          │  │ Brother QL        │  ││
│  ┌─────────────────────────────────────┐ │  │ Template Renderer │  ││
│  │          QR Token Service           │ │  │ QR Generator      │  ││
│  │  ┌───────────────────────────────┐  │ │  └───────────────────┘  ││
│  │  │ Token Generation (Base32)     │  │ └─────────────────────────┘│
│  │  │ Namespace Management          │  │                            │
│  │  │ QR Routing                    │  │                            │
│  │  └───────────────────────────────┘  │                            │
│  └─────────────────────────────────────┘                            │
└─────────────────────────────────────────────────────────────────────┘
                                   │
┌──────────────────────────────────┼──────────────────────────────────┐
│                       DATA & CACHE LAYER                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐   │
│  │       PostgreSQL 17         │  │           Redis              │   │
│  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐   │   │
│  │  │ tenants               │  │  │  │  Lookup Cache (30d)   │   │   │
│  │  │ users                 │  │  │  │  Session Data         │   │   │
│  │  │ products              │  │  │  │  Rate Limit Counters  │   │   │
│  │  │ locations + closure   │  │  │  └───────────────────────┘   │   │
│  │  │ containers            │  │  └─────────────────────────────┘   │
│  │  │ product_instances     │  │                                    │
│  │  │ qr_tokens             │  │                                    │
│  │  │ recipes, meal_plans   │  │                                    │
│  │  │ shopping_lists        │  │                                    │
│  │  │ people, consumption   │  │                                    │
│  │  │ purchases, returns    │  │                                    │
│  │  │ + RLS policies        │  │                                    │
│  │  └───────────────────────┘  │                                    │
│  └─────────────────────────────┘                                    │
└─────────────────────────────────────────────────────────────────────┘
                                   │
┌──────────────────────────────────┼──────────────────────────────────┐
│                      OBSERVABILITY STACK                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  Grafana    │  │    Loki     │  │  Prometheus │  │    Tempo    │ │
│  │  (Dashboards│  │   (Logs)    │  │  (Metrics)  │  │  (Traces)   │ │
│  │  Port: 3000 │  │  Port: 3100 │  │  Port: 9090 │  │  Port: 4317 │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

## 30.10.2 Technology Stack

### Frontend

| Component | Technology | Purpose |
|-----------|------------|---------|
| Framework | Vue 3 + Composition API | Reactive UI framework |
| UI Library | Quasar v2 | Material Design components |
| State | Pinia | Global state management |
| Router | Vue Router | SPA navigation |
| Build | Vite | Fast development/build |
| PWA | Workbox | Offline support |
| Mobile | Capacitor | Native iOS/Android builds |

> **Current Implementation Note:** The codebase currently uses **NiceGUI** (Python, server-rendered via WebSocket) served by FastAPI on port 3334 as an interim solution for rapid prototyping. The Vue 3 + Quasar stack described above is the **target architecture** for Phase 3. The current NiceGUI UI provides functional scanning, products, locations, and settings pages but does not include PWA features (service worker, manifest, offline support). See [DEC-051](91.14-decision-log.md#dec-051-ui-stack-and-pwa-alignment) for details.

### Backend

| Component | Technology | Purpose |
|-----------|------------|---------|
| Framework | FastAPI | Async Python API |
| ORM | SQLAlchemy 2.0 | Database operations |
| Migrations | Alembic | Schema versioning |
| Validation | Pydantic v2 | Request/response schemas |
| Auth | JWT + API Keys | Authentication |
| Tasks | Background Tasks | Async processing |

### Data

| Component | Technology | Purpose |
|-----------|------------|---------|
| Database | PostgreSQL 17 | Primary data store |
| Cache | Redis | Lookup cache, sessions |
| RLS | PostgreSQL RLS | Tenant isolation |

### Integrations

| Integration | Technology | Purpose |
|-------------|------------|---------|
| Documents | Paperless-ngx | Receipt/document management |
| Grocy | REST API facade | Compatibility layer |
| Labels | brother_ql | Label printing |
| Home Assistant | REST API (future) | Smart home integration |

## 30.10.3 Directory Structure

```
homebot/
├── frontend/                      # Vue 3 + Quasar application
│   ├── package.json
│   ├── quasar.config.js
│   ├── src/
│   │   ├── App.vue
│   │   ├── router/
│   │   │   └── index.ts           # Routes + auth guards
│   │   ├── stores/
│   │   │   ├── auth.ts            # Auth state
│   │   │   ├── device.ts          # Device prefs
│   │   │   ├── products.ts        # Product cache
│   │   │   └── tenant.ts          # Active tenant
│   │   ├── pages/
│   │   │   ├── LoginPage.vue
│   │   │   ├── ScanPage.vue       # Main scanning UI
│   │   │   ├── ProductsPage.vue
│   │   │   ├── ProductDetail.vue
│   │   │   ├── LocationsPage.vue
│   │   │   ├── RecipesPage.vue
│   │   │   ├── MealPlanPage.vue
│   │   │   ├── ShoppingPage.vue
│   │   │   ├── HouseholdPage.vue
│   │   │   ├── ReturnsPage.vue
│   │   │   ├── SettingsPage.vue
│   │   │   └── LabelDesigner.vue
│   │   ├── components/
│   │   │   ├── BarcodeScanner.vue
│   │   │   ├── ActionModeSelector.vue
│   │   │   ├── ProductCard.vue
│   │   │   ├── LocationTree.vue
│   │   │   ├── LabelPreview.vue
│   │   │   └── ...
│   │   └── services/
│   │       ├── api.ts             # API client
│   │       └── device.ts          # Device fingerprint
│   └── public/
│
├── app/                           # FastAPI backend
│   ├── __init__.py
│   ├── main.py                    # Application entry
│   ├── config.py                  # Settings
│   ├── database.py                # SQLAlchemy setup
│   │
│   ├── models/                    # SQLAlchemy models
│   │   ├── tenant.py
│   │   ├── user.py
│   │   ├── product.py
│   │   ├── location.py
│   │   ├── container.py
│   │   ├── product_instance.py
│   │   ├── qr_token.py
│   │   ├── recipe.py
│   │   ├── meal_plan.py
│   │   ├── shopping_list.py
│   │   ├── person.py
│   │   ├── consumption.py
│   │   ├── purchase.py
│   │   └── returnable_item.py
│   │
│   ├── api/
│   │   ├── deps.py                # Dependencies (auth, db)
│   │   └── routes/
│   │       ├── auth.py
│   │       ├── products.py
│   │       ├── locations.py
│   │       ├── stock.py
│   │       ├── qr.py
│   │       ├── labels.py
│   │       ├── recipes.py
│   │       ├── meal_plans.py
│   │       ├── shopping_lists.py
│   │       ├── people.py
│   │       ├── purchases.py
│   │       ├── returns.py
│   │       └── grocy/             # Grocy compat endpoints
│   │           ├── stock.py
│   │           └── objects.py
│   │
│   ├── services/
│   │   ├── lookup/
│   │   │   ├── openfoodfacts.py
│   │   │   ├── upc.py
│   │   │   └── brave.py
│   │   ├── llm/
│   │   │   └── optimizer.py
│   │   ├── qr/
│   │   │   ├── generator.py
│   │   │   └── router.py
│   │   ├── label/
│   │   │   ├── renderer.py
│   │   │   └── printer.py
│   │   ├── grocy_compat.py
│   │   └── paperless.py
│   │
│   └── schemas/                   # Pydantic schemas
│       └── ...
│
├── migrations/                    # Alembic
│   ├── env.py
│   └── versions/
│
├── docker/
│   ├── docker-compose.yml
│   ├── docker-compose.paperless.yml
│   └── docker-compose.observability.yml
│
├── tests/
│   ├── phase1/
│   ├── phase2/
│   └── ...
│
└── prd/                           # This documentation
```

## 30.10.4 Multi-Tenant Architecture

### Tenant Isolation

All data is isolated by `tenant_id` using PostgreSQL Row-Level Security:

```sql
-- Enable RLS on products table
ALTER TABLE products ENABLE ROW LEVEL SECURITY;

-- Policy for tenant isolation
CREATE POLICY products_tenant_isolation ON products
    USING (tenant_id = current_setting('app.tenant_id')::uuid);

-- Set tenant context per request
SET app.tenant_id = 'tenant-uuid-here';
```

### Session Management

```python
# Backend sets tenant context per request
@app.middleware("http")
async def tenant_middleware(request: Request, call_next):
    # Extract tenant from JWT or session
    tenant_id = get_tenant_from_auth(request)
    
    # Set PostgreSQL session variable
    await db.execute(text(f"SET app.tenant_id = '{tenant_id}'"))
    
    response = await call_next(request)
    return response
```

## 30.10.5 API Architecture

### API Layers

| Path | Purpose | Auth |
|------|---------|------|
| `/api/v2/*` | Native Homebot API | Bearer JWT |
| `/api/*` | Grocy-compatible API | GROCY-API-KEY |
| `/q/{token}` | QR routing | Session cookie |
| `/docs` | OpenAPI documentation | Public |

### Authentication Flow

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Browser │────▶│ /login  │────▶│   JWT   │
└─────────┘     └─────────┘     │ + Cookie│
                                └────┬────┘
                                     │
                ┌────────────────────┼────────────────────┐
                │                    │                    │
                ▼                    ▼                    ▼
         ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
         │ /api/v2/*   │     │  /api/*     │     │   /q/*      │
         │ Bearer JWT  │     │ GROCY-API-KEY│    │ Session     │
         └─────────────┘     └─────────────┘     └─────────────┘
```

---

## Navigation

- **Previous:** [Functional Requirements](20.11-functional-requirements.md)
- **Next:** [Data Models](30.11-data-models.md)
- **Back to:** [README](README.md)
