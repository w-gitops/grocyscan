# 80.11 Ralph Phase 1: Foundation

This is the Ralph Wiggum task document for Phase 1 - Foundation setup.

---

## Frontmatter

```yaml
phase: 1
name: Foundation
description: Core infrastructure, authentication, and database setup
test_command: pytest tests/ -v --tb=short
browser_validation: false
estimated_criteria: 10
```

---

## Overview

Phase 1 establishes the foundational infrastructure:

- PostgreSQL database with multi-tenant schema
- FastAPI application skeleton
- Authentication system (JWT + API keys)
- Basic API structure
- Development environment

---

## Acceptance Criteria

### Database & Schema

- [ ] **[1] [CRITICAL]** PostgreSQL database created with `homebot` schema
  - Test: `SELECT current_database()` returns `homebot`

- [ ] **[2] [CRITICAL]** Tenants table with RLS enabled
  - Test: `\d tenants` shows id, name, slug, settings columns
  - Test: RLS policy exists on tenants table

- [ ] **[3] [CRITICAL]** Users table with tenant membership
  - Test: `\d users` shows id, email, password_hash, tenant_id
  - Test: `\d tenant_memberships` exists with user_id, tenant_id, role

- [ ] **[4] [CORE]** Alembic migrations configured
  - Test: `alembic current` shows head revision
  - Test: `alembic upgrade head` runs without error

### Authentication

- [ ] **[5] [CRITICAL]** JWT authentication working
  - Test: `POST /api/v2/auth/login` returns access_token
  - Test: Protected endpoint rejects invalid token

- [ ] **[6] [CRITICAL]** API key authentication for service accounts
  - Test: `HOMEBOT-API-KEY` header authenticates requests
  - Test: Invalid API key returns 401

- [ ] **[7] [CORE]** Password hashing with bcrypt
  - Test: Passwords stored as bcrypt hashes
  - Test: Login verifies password correctly

### API Structure

- [ ] **[8] [CRITICAL]** FastAPI app starts without errors
  - Test: `uvicorn app.main:app` starts on port 3334
  - Test: `GET /health` returns 200

- [ ] **[9] [CORE]** OpenAPI spec generated at `/docs`
  - Test: `GET /docs` returns Swagger UI
  - Test: `GET /openapi.json` returns valid OpenAPI spec

- [ ] **[10] [FLEX]** Basic logging configured
  - Test: Requests logged with correlation ID
  - Test: Log level configurable via env var

---

## Test Command

```bash
# Run all Phase 1 tests
pytest tests/phase1/ -v --tb=short

# Specific test files
pytest tests/phase1/test_database.py -v
pytest tests/phase1/test_auth.py -v
pytest tests/phase1/test_api.py -v
```

---

## Dependencies

- None (this is the foundation phase)

---

## Files to Create/Modify

```
app/
├── main.py                 # FastAPI app entry point
├── config.py               # Settings and environment
├── database.py             # SQLAlchemy setup
├── models/
│   ├── __init__.py
│   ├── tenant.py           # Tenant model
│   └── user.py             # User model
├── api/
│   ├── __init__.py
│   ├── deps.py             # Dependencies (auth, db)
│   └── routes/
│       ├── __init__.py
│       ├── auth.py         # Login, token refresh
│       └── health.py       # Health check
├── services/
│   ├── __init__.py
│   └── auth.py             # Auth service
└── schemas/
    ├── __init__.py
    ├── auth.py             # Login request/response
    └── user.py             # User schemas

migrations/
├── env.py
└── versions/
    └── 001_initial_schema.py

tests/
└── phase1/
    ├── conftest.py         # Test fixtures
    ├── test_database.py
    ├── test_auth.py
    └── test_api.py
```

---

## Environment Variables

```bash
# Required for Phase 1
DATABASE_URL=postgresql://homebot:password@localhost:5432/homebot
SECRET_KEY=your-secret-key-here
HOMEBOT_DEBUG=false
```

---

## Navigation

- **Previous:** [Ralph Phases Overview](80.10-ralph-phases-overview.md)
- **Next:** [Phase 2: Inventory Core](80.12-ralph-phase-2-inventory.md)
- **Back to:** [README](README.md)
