# 60.12 Device Preferences

This document specifies the device registration and preference system for Homebot.

---

## 60.12.1 Overview

Devices (tablets, phones, kiosks) can register with Homebot to receive personalized settings. This enables:

- **Default location** - Scanned items default to device's location
- **Action mode** - What happens after a scan (add stock, consume, lookup only)
- **UI preferences** - Theme, sounds, layout optimizations
- **Scanner configuration** - Camera vs keyboard wedge vs both

---

## 60.12.2 Device Registration

### Registration Flow

```
1. User opens Homebot on new device
2. App generates device fingerprint (localStorage UUID)
3. User logs in and selects tenant
4. Prompt: "Register this device?"
5. User names device (e.g., "Kitchen Tablet")
6. Device associated with user + tenant
```

### Device Identification

| Method | Use Case |
|--------|----------|
| **Browser fingerprint** | PWA on shared devices |
| **localStorage UUID** | PWA on personal devices |
| **Capacitor device ID** | Native mobile apps |
| **MAC address** | Dedicated kiosk hardware |

### PWA and Device Identity

When the app is installed as a PWA (via "Add to Home Screen"), it runs in a separate browser context but shares the same origin storage as the browser.

**Key considerations:**

- **Same fingerprint**: The localStorage UUID remains the same whether the app is accessed via browser or installed PWA. This means the device record is sharedâ€”which is typically the desired behavior.
- **Browser context isolation**: On iOS, PWAs have separate cookies/storage from Safari in some versions; on Android/Chrome, storage is generally shared. Test device recognition on target platforms.
- **Multiple profiles**: If a user uses multiple browser profiles (e.g., personal/work), each profile will generate a different fingerprint and register as a separate device. This is expected behavior.

**Recommendation:**

- Use **localStorage UUID** as the primary fingerprint for all web contexts (browser and PWA).
- Treat browser and installed PWA as the **same device** (same fingerprint = same device record).
- If distinct treatment is needed, add a flag to indicate context (e.g., `display_mode: "browser" | "standalone"`), but this is not required for MVP.

---

## 60.12.3 Data Model

### Device Table

```sql
CREATE TABLE devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    user_id UUID REFERENCES users(id),  -- NULL for shared devices
    
    -- Identification
    name VARCHAR(100) NOT NULL,
    fingerprint VARCHAR(255) NOT NULL,
    device_type VARCHAR(50) NOT NULL,  -- tablet, phone, kiosk, desktop
    
    -- Preferences
    default_location_id UUID REFERENCES locations(id),
    default_action VARCHAR(50) DEFAULT 'add_stock',
    scanner_mode VARCHAR(50) DEFAULT 'camera',
    
    -- Settings JSON
    preferences JSONB DEFAULT '{}',
    
    -- Metadata
    last_seen_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(tenant_id, fingerprint)
);

-- RLS
ALTER TABLE devices ENABLE ROW LEVEL SECURITY;
CREATE POLICY devices_tenant_isolation ON devices
    USING (tenant_id = current_setting('app.tenant_id')::uuid);
```

### Preferences Schema

```typescript
interface DevicePreferences {
  // UI
  theme: 'light' | 'dark' | 'system';
  fontSize: 'small' | 'medium' | 'large';
  soundEnabled: boolean;
  vibrationEnabled: boolean;
  
  // Scanner
  scannerMode: 'camera' | 'keyboard' | 'both';
  cameraFacing: 'back' | 'front';
  continuousScan: boolean;
  scanDelay: number;  // ms between scans
  
  // Actions
  defaultAction: 'add_stock' | 'consume' | 'lookup' | 'transfer';
  autoConfirm: boolean;  // Skip review for known products
  showQuantityPicker: boolean;
  
  // Location
  defaultLocationId: string | null;
  rememberLastLocation: boolean;
}
```

---

## 60.12.4 Action Modes

| Mode | Scan Behavior | Use Case |
|------|---------------|----------|
| **Add Stock** | Scan â†’ add 1 unit to default location | Unpacking groceries |
| **Consume** | Scan â†’ remove 1 unit (FIFO) | Taking item from pantry |
| **Transfer** | Scan â†’ prompt for destination | Moving items |
| **Lookup** | Scan â†’ show product info only | Checking expiration |
| **Inventory** | Scan â†’ show stock levels, edit | Stock taking |

### Action Mode UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kitchen Tablet                    âš™ï¸   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚   ğŸ“¦ Add Stock    ğŸ½ï¸ Consume            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   [SELECTED]                            â”‚
â”‚                                         â”‚
â”‚   ğŸ“‹ Lookup       ğŸ”„ Transfer           â”‚
â”‚                                         â”‚
â”‚   ğŸ“Š Inventory                          â”‚
â”‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Default Location: Kitchen Pantry       â”‚
â”‚  [Change]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 60.12.5 API Endpoints

### Register Device

```http
POST /api/v2/devices
Content-Type: application/json

{
  "name": "Kitchen Tablet",
  "fingerprint": "550e8400-e29b-41d4-a716-446655440000",
  "device_type": "tablet",
  "preferences": {
    "theme": "light",
    "defaultAction": "add_stock"
  }
}
```

### Get Current Device

```http
GET /api/v2/devices/current
X-Device-Fingerprint: 550e8400-e29b-41d4-a716-446655440000

Response:
{
  "id": "...",
  "name": "Kitchen Tablet",
  "default_location": {
    "id": "...",
    "name": "Kitchen Pantry"
  },
  "preferences": { ... }
}
```

### Update Preferences

```http
PATCH /api/v2/devices/{id}/preferences
Content-Type: application/json

{
  "defaultAction": "consume",
  "default_location_id": "..."
}
```

### List Tenant Devices

```http
GET /api/v2/devices

Response:
{
  "devices": [
    {
      "id": "...",
      "name": "Kitchen Tablet",
      "last_seen_at": "2026-02-03T10:30:00Z",
      "user": { "name": "Alex" }
    }
  ]
}
```

---

## 60.12.6 Scanner Modes

### Camera Scanner

- Uses `html5-qrcode` library
- Back camera preferred on mobile
- Continuous scanning with configurable delay
- Supports QR codes and standard barcodes

### Keyboard Wedge

- USB barcode scanner sends keystrokes
- Listens for rapid input followed by Enter
- Works when scan input field is focused
- Kiosk mode keeps focus on input

### Hybrid Mode

- Camera always visible
- Keyboard input also captured
- First successful scan wins

---

## 60.12.7 Kiosk Mode

For dedicated scanning stations:

```typescript
interface KioskConfig {
  // Lock to single tenant (no switching)
  lockedTenantId: string;
  
  // Lock to single location
  lockedLocationId: string;
  
  // Disable navigation
  kioskMode: true;
  
  // Auto-reset after inactivity
  inactivityTimeout: 300;  // seconds
  
  // Restrict to specific action
  allowedActions: ['add_stock'];
}
```

---

## 60.12.8 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-DEV-01 | As a user, I want to register my tablet so it remembers my preferred location | [CRITICAL] |
| US-DEV-02 | As a user, I want to switch action modes quickly without going to settings | [CORE] |
| US-DEV-03 | As a user, I want my phone to use camera scanning and my kiosk to use USB scanner | [CORE] |
| US-DEV-04 | As an admin, I want to see all registered devices and their last activity | [FLEX] |
| US-DEV-05 | As a user, I want the app to work in kiosk mode for my dedicated scanning station | [FLEX] |

---

## Navigation

- **Previous:** [Multi-Tenant](60.11-multi-tenant.md)
- **Next:** [Label Printing](60.13-label-printing.md)
- **Back to:** [README](README.md)
