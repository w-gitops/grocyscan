# 60.14 Container Management

This document specifies the container and location hierarchy system for Homebot.

---

## 60.14.1 Overview

Containers provide flexible organization for inventory:

- **Nested containers** - Boxes within shelves within rooms
- **Location hierarchy** - Home > Kitchen > Pantry > Shelf 3
- **Movable containers** - Track container location changes
- **QR-labeled** - Scan container to see/add contents

---

## 60.14.2 Hierarchy Levels

### Location Hierarchy (5-7 levels)

```
Level 0: Property (Home, Vacation House, Storage Unit)
Level 1: Building/Structure (Main House, Garage, Shed)
Level 2: Floor/Area (First Floor, Basement)
Level 3: Room (Kitchen, Pantry, Garage)
Level 4: Zone (Fridge, Cabinet Section A)
Level 5: Shelf/Drawer (Shelf 3, Top Drawer)
Level 6: Container (Blue Bin, Medication Box)
```

### Container Nesting (2-3 levels)

```
Container Level 1: Large container (Storage Bin)
Container Level 2: Medium container (Organizer Box)
Container Level 3: Small container (Pill Organizer Compartment)
```

---

## 60.14.3 Data Model

### Locations (Closure Table)

```sql
-- Location nodes
CREATE TABLE locations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    name VARCHAR(100) NOT NULL,
    description TEXT,
    location_type VARCHAR(50),  -- property, building, floor, room, zone, shelf
    
    -- Direct parent (for easy traversal)
    parent_id UUID REFERENCES locations(id),
    
    -- QR code
    qr_token_id UUID REFERENCES qr_tokens(id),
    
    -- Metadata
    sort_order INTEGER DEFAULT 0,
    icon VARCHAR(50),
    color VARCHAR(7),  -- Hex color
    
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Closure table for efficient ancestor/descendant queries
CREATE TABLE location_closure (
    ancestor_id UUID NOT NULL REFERENCES locations(id),
    descendant_id UUID NOT NULL REFERENCES locations(id),
    depth INTEGER NOT NULL,
    
    PRIMARY KEY (ancestor_id, descendant_id)
);

-- Indexes
CREATE INDEX idx_locations_parent ON locations(parent_id);
CREATE INDEX idx_location_closure_ancestor ON location_closure(ancestor_id);
CREATE INDEX idx_location_closure_descendant ON location_closure(descendant_id);

-- RLS
ALTER TABLE locations ENABLE ROW LEVEL SECURITY;
CREATE POLICY locations_tenant_isolation ON locations
    USING (tenant_id = current_setting('app.tenant_id')::uuid);
```

### Containers

```sql
CREATE TABLE containers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    name VARCHAR(100) NOT NULL,
    description TEXT,
    container_type VARCHAR(50),  -- bin, box, basket, bag, organizer
    
    -- Current location
    location_id UUID REFERENCES locations(id),
    
    -- Parent container (for nesting)
    parent_container_id UUID REFERENCES containers(id),
    
    -- QR code
    qr_token_id UUID REFERENCES qr_tokens(id),
    
    -- Physical properties
    capacity_liters DECIMAL(10, 2),
    max_weight_kg DECIMAL(10, 2),
    
    -- Visual
    color VARCHAR(50),
    icon VARCHAR(50),
    photo_url TEXT,
    
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE containers ENABLE ROW LEVEL SECURITY;
CREATE POLICY containers_tenant_isolation ON containers
    USING (tenant_id = current_setting('app.tenant_id')::uuid);
```

### Container Movement Log

```sql
CREATE TABLE container_movements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    container_id UUID NOT NULL REFERENCES containers(id),
    
    from_location_id UUID REFERENCES locations(id),
    to_location_id UUID REFERENCES locations(id),
    
    moved_by UUID REFERENCES users(id),
    notes TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 60.14.4 Closure Table Operations

### Insert Location

```sql
-- When inserting a new location with parent
CREATE OR REPLACE FUNCTION insert_location_closure()
RETURNS TRIGGER AS $$
BEGIN
    -- Self-reference
    INSERT INTO location_closure (ancestor_id, descendant_id, depth)
    VALUES (NEW.id, NEW.id, 0);
    
    -- Copy parent's ancestors
    IF NEW.parent_id IS NOT NULL THEN
        INSERT INTO location_closure (ancestor_id, descendant_id, depth)
        SELECT ancestor_id, NEW.id, depth + 1
        FROM location_closure
        WHERE descendant_id = NEW.parent_id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER location_closure_insert
AFTER INSERT ON locations
FOR EACH ROW EXECUTE FUNCTION insert_location_closure();
```

### Query Descendants

```sql
-- Get all locations under "Kitchen"
SELECT l.*
FROM locations l
JOIN location_closure lc ON l.id = lc.descendant_id
WHERE lc.ancestor_id = :kitchen_id
  AND lc.depth > 0
ORDER BY lc.depth, l.sort_order;
```

### Query Ancestors (Breadcrumb)

```sql
-- Get path to location
SELECT l.*, lc.depth
FROM locations l
JOIN location_closure lc ON l.id = lc.ancestor_id
WHERE lc.descendant_id = :location_id
ORDER BY lc.depth DESC;
```

---

## 60.14.5 Stock in Containers

Products can be stored in either locations or containers:

```sql
-- Stock references location OR container
ALTER TABLE stock ADD COLUMN container_id UUID REFERENCES containers(id);

-- Constraint: must have location or container
ALTER TABLE stock ADD CONSTRAINT stock_location_or_container
    CHECK (location_id IS NOT NULL OR container_id IS NOT NULL);
```

### Effective Location

```sql
-- View that resolves container's location
CREATE VIEW stock_with_location AS
SELECT 
    s.*,
    COALESCE(s.location_id, c.location_id) AS effective_location_id
FROM stock s
LEFT JOIN containers c ON s.container_id = c.id;
```

---

## 60.14.6 UI Design

### Location Browser

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Locations                                      [+ Add Location]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Home > Kitchen > Pantry                              [ğŸ” Search]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“ Shelf 1                                           12 items  â”‚
â”‚  ğŸ“ Shelf 2                                            8 items  â”‚
â”‚  ğŸ“ Shelf 3                                           15 items  â”‚
â”‚  ğŸ“¦ Snack Bin (container)                              5 items  â”‚
â”‚  ğŸ“¦ Canned Goods Box (container)                      20 items  â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Recent items in Pantry:                                        â”‚
â”‚  â€¢ Cheerios (Shelf 2) - exp Mar 15                              â”‚
â”‚  â€¢ Black Beans x4 (Canned Goods Box)                            â”‚
â”‚  â€¢ Granola Bars (Snack Bin) - exp Apr 1                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Container Detail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ Snack Bin                                    [Edit] [Move]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Location: Kitchen > Pantry > Shelf 3                           â”‚
â”‚  Type: Plastic Bin                                              â”‚
â”‚  QR: K3D-SNACK-X                                   [Print Label]â”‚
â”‚                                                                  â”‚
â”‚  Contents (5 items):                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Granola Bars (6 pack)           qty: 2     exp: Apr 1     â”‚  â”‚
â”‚  â”‚ Trail Mix                       qty: 1     exp: Jun 15    â”‚  â”‚
â”‚  â”‚ Protein Bars                    qty: 3     exp: May 20    â”‚  â”‚
â”‚  â”‚ Dried Fruit                     qty: 1     exp: Jul 1     â”‚  â”‚
â”‚  â”‚ Crackers                        qty: 1     exp: Mar 30    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚                                              [+ Add to Container]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 60.14.7 API Endpoints

### Create Location

```http
POST /api/v2/locations
Content-Type: application/json

{
  "name": "Shelf 3",
  "location_type": "shelf",
  "parent_id": "...",
  "icon": "shelf",
  "sort_order": 3
}
```

### Get Location Tree

```http
GET /api/v2/locations/tree?root_id=...

Response:
{
  "id": "...",
  "name": "Pantry",
  "children": [
    {
      "id": "...",
      "name": "Shelf 1",
      "item_count": 12,
      "children": []
    }
  ]
}
```

### Move Container

```http
POST /api/v2/containers/{id}/move
Content-Type: application/json

{
  "to_location_id": "...",
  "notes": "Moving to garage for storage"
}
```

### Get Container Contents

```http
GET /api/v2/containers/{id}/contents

Response:
{
  "container": { ... },
  "items": [
    {
      "product": { "name": "Granola Bars" },
      "quantity": 2,
      "expiration_date": "2026-04-01"
    }
  ]
}
```

---

## 60.14.8 Location Types

| Type | Icon | Typical Use |
|------|------|-------------|
| `property` | ğŸ  | Home, Vacation House |
| `building` | ğŸ¢ | Main House, Garage |
| `floor` | â¬†ï¸ | First Floor, Basement |
| `room` | ğŸšª | Kitchen, Bedroom |
| `zone` | ğŸ“ | Fridge, Cabinet |
| `shelf` | ğŸ“š | Shelf 1, Top Drawer |
| `other` | ğŸ“ | Custom |

## 60.14.9 Container Types

| Type | Icon | Example |
|------|------|---------|
| `bin` | ğŸ“¦ | Storage bin |
| `box` | ğŸ—ƒï¸ | Cardboard box |
| `basket` | ğŸ§º | Wire basket |
| `bag` | ğŸ‘œ | Reusable bag |
| `organizer` | ğŸ—„ï¸ | Drawer organizer |
| `jar` | ğŸ«™ | Mason jar |
| `other` | ğŸ“¦ | Custom |

---

## 60.14.10 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-CNT-01 | As a user, I want to organize locations in a hierarchy | [CRITICAL] |
| US-CNT-02 | As a user, I want to create containers that can hold items | [CRITICAL] |
| US-CNT-03 | As a user, I want to move containers between locations | [CORE] |
| US-CNT-04 | As a user, I want to scan a container QR to see its contents | [CORE] |
| US-CNT-05 | As a user, I want to nest containers within each other | [FLEX] |
| US-CNT-06 | As a user, I want to see the full path (breadcrumb) for any location | [FLEX] |

---

## Navigation

- **Previous:** [Label Printing](60.13-label-printing.md)
- **Next:** [LPN Instance Tracking](60.15-lpn-instance-tracking.md)
- **Back to:** [README](README.md)
