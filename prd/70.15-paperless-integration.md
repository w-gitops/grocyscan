# 70.15 Paperless-ngx Integration

This document specifies the integration between Homebot and Paperless-ngx for document management and receipt processing.

---

## 70.15.1 Overview

Paperless-ngx integration provides:

- **Receipt storage** - Upload and OCR receipts
- **Purchase linking** - Connect receipts to purchases
- **Document tagging** - Auto-tag by store, date, category
- **Search** - Find receipts by content
- **Return labels** - Store shipping labels

---

## 70.15.2 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Homebot                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Purchase UI    â”‚  â”‚   Returns UI    â”‚  â”‚   Documents UI  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                    â”‚                    â”‚           â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚  Paperless Service    â”‚                    â”‚
â”‚                    â”‚  (API Client)         â”‚                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ REST API
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Paperless-ngx Stack                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Web Server â”‚  â”‚   Redis     â”‚  â”‚   Gotenberg â”‚              â”‚
â”‚  â”‚  Port 8001  â”‚  â”‚             â”‚  â”‚   (PDF)     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  PostgreSQL â”‚  â”‚   Consume   â”‚  â”‚    Tika     â”‚              â”‚
â”‚  â”‚  (shared)   â”‚  â”‚   Folder    â”‚  â”‚   (OCR)     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.15.3 Paperless Configuration

### Document Types

Create these document types in Paperless:

| Document Type | Description |
|---------------|-------------|
| `receipt` | Store receipts |
| `return_label` | Shipping labels for returns |
| `warranty` | Product warranty documents |
| `manual` | Product manuals |

### Tags

| Tag | Auto-matching | Description |
|-----|---------------|-------------|
| `homebot` | Manual | Linked to Homebot |
| `{store_name}` | By correspondent | Store name |
| `pending_review` | Auto | Needs manual linking |
| `linked` | Auto | Connected to purchase |

### Correspondents

Create correspondents for each store:

- Amazon
- Target  
- Costco
- Walmart
- etc.

---

## 70.15.4 API Integration

### Paperless Client

```python
import httpx
from typing import Optional

class PaperlessClient:
    """Client for Paperless-ngx API."""
    
    def __init__(self, base_url: str, token: str):
        self.base_url = base_url.rstrip('/')
        self.headers = {
            "Authorization": f"Token {token}",
            "Content-Type": "application/json"
        }
    
    async def upload_document(
        self,
        file: bytes,
        filename: str,
        title: Optional[str] = None,
        document_type: Optional[int] = None,
        correspondent: Optional[int] = None,
        tags: Optional[list[int]] = None,
    ) -> dict:
        """Upload a document to Paperless."""
        
        async with httpx.AsyncClient() as client:
            files = {"document": (filename, file)}
            data = {}
            if title:
                data["title"] = title
            if document_type:
                data["document_type"] = document_type
            if correspondent:
                data["correspondent"] = correspondent
            if tags:
                data["tags"] = tags
                
            response = await client.post(
                f"{self.base_url}/api/documents/post_document/",
                headers={"Authorization": self.headers["Authorization"]},
                files=files,
                data=data
            )
            return response.json()
    
    async def get_document(self, doc_id: int) -> dict:
        """Get document metadata."""
        async with httpx.AsyncClient() as client:
            response = await client.get(
                f"{self.base_url}/api/documents/{doc_id}/",
                headers=self.headers
            )
            return response.json()
    
    async def search_documents(
        self,
        query: str,
        document_type: Optional[int] = None
    ) -> list[dict]:
        """Search documents by content."""
        async with httpx.AsyncClient() as client:
            params = {"query": query}
            if document_type:
                params["document_type__id"] = document_type
                
            response = await client.get(
                f"{self.base_url}/api/documents/",
                headers=self.headers,
                params=params
            )
            return response.json()["results"]
```

---

## 70.15.5 Receipt Processing

### Upload Flow

```
1. User uploads receipt image/PDF
2. Homebot sends to Paperless-ngx
3. Paperless OCRs the document
4. Paperless returns document ID
5. Homebot stores reference
6. (Optional) Parse OCR for line items
```

### OCR Parsing (Future)

```python
async def parse_receipt_ocr(document_id: int) -> ReceiptData:
    """Parse OCR text from Paperless document."""
    
    # Get document content
    doc = await paperless.get_document(document_id)
    content = doc.get("content", "")
    
    # Use LLM to extract structured data
    prompt = f"""
    Extract receipt data from this OCR text:
    
    {content}
    
    Return JSON with:
    - store_name
    - date
    - items: [{{name, quantity, price}}]
    - subtotal
    - tax
    - total
    """
    
    result = await llm.generate(prompt)
    return ReceiptData.parse_raw(result)
```

---

## 70.15.6 Document Linking

### Link Receipt to Purchase

```sql
-- Add Paperless document reference to purchases
ALTER TABLE purchases ADD COLUMN receipt_document_id INTEGER;
ALTER TABLE purchases ADD COLUMN receipt_document_url TEXT;

-- Add to returnable items
ALTER TABLE returnable_items ADD COLUMN receipt_document_id INTEGER;
ALTER TABLE returnable_items ADD COLUMN return_label_document_id INTEGER;
```

### Homebot Document Reference

```python
class DocumentReference(BaseModel):
    """Reference to a Paperless-ngx document."""
    
    paperless_id: int
    title: str
    document_type: str
    created_at: datetime
    thumbnail_url: Optional[str]
    download_url: str
```

---

## 70.15.7 UI Design

### Receipt Viewer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Purchase - Target - Feb 3, 2026                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Receipt                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  [Receipt Preview Image]                                  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  [View Full]  [Download]  [Open in Paperless]                   â”‚
â”‚                                                                  â”‚
â”‚  Items on this receipt:                                          â”‚
â”‚  â€¢ Cheerios 18oz Ã— 2 @ $4.99                                    â”‚
â”‚  â€¢ Milk 1gal Ã— 1 @ $3.49                                        â”‚
â”‚  â€¢ Eggs dozen Ã— 2 @ $4.29                                       â”‚
â”‚                                                                  â”‚
â”‚  Total: $22.73                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Upload Receipt

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Upload Receipt                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚              ğŸ“„                                           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚     Drop receipt image or PDF here                        â”‚  â”‚
â”‚  â”‚     or click to browse                                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚     Supports: JPG, PNG, PDF                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Or link existing document from Paperless:                      â”‚
â”‚  [Search Paperless...                                      ğŸ”]  â”‚
â”‚                                                                  â”‚
â”‚                                               [Cancel] [Upload]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.15.8 API Endpoints

### Upload Receipt

```http
POST /api/v2/documents/receipts
Content-Type: multipart/form-data

file: [binary]
purchase_id: "..." (optional)
store_id: "..." (optional)

Response:
{
  "id": "...",
  "paperless_id": 12345,
  "status": "processing",
  "title": "Target Receipt 2026-02-03"
}
```

### Link Document to Purchase

```http
POST /api/v2/purchases/{id}/receipt
Content-Type: application/json

{
  "paperless_document_id": 12345
}
```

### Search Paperless Documents

```http
GET /api/v2/documents/search?q=target+february

Response:
{
  "documents": [
    {
      "paperless_id": 12345,
      "title": "Target Receipt",
      "created": "2026-02-03",
      "thumbnail_url": "..."
    }
  ]
}
```

---

## 70.15.9 Docker Compose

```yaml
# docker/docker-compose.paperless.yml
version: "3.8"

services:
  paperless-webserver:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    depends_on:
      - paperless-redis
      - paperless-gotenberg
      - paperless-tika
    ports:
      - "8001:8000"
    environment:
      PAPERLESS_REDIS: redis://paperless-redis:6379
      PAPERLESS_DBHOST: postgres
      PAPERLESS_DBNAME: paperless
      PAPERLESS_DBUSER: paperless
      PAPERLESS_DBPASS: ${PAPERLESS_DB_PASSWORD}
      PAPERLESS_SECRET_KEY: ${PAPERLESS_SECRET_KEY}
      PAPERLESS_TIKA_ENABLED: 1
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://paperless-gotenberg:3000
      PAPERLESS_TIKA_ENDPOINT: http://paperless-tika:9998
      PAPERLESS_OCR_LANGUAGE: eng
    volumes:
      - paperless_data:/usr/src/paperless/data
      - paperless_media:/usr/src/paperless/media
      - paperless_consume:/usr/src/paperless/consume
    restart: unless-stopped

  paperless-redis:
    image: redis:7-alpine
    restart: unless-stopped

  paperless-gotenberg:
    image: gotenberg/gotenberg:7.10
    restart: unless-stopped

  paperless-tika:
    image: ghcr.io/paperless-ngx/tika:latest
    restart: unless-stopped

volumes:
  paperless_data:
  paperless_media:
  paperless_consume:
```

---

## 70.15.10 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-PLS-01 | As a user, I want to upload receipts and have them OCR'd | [CRITICAL] |
| US-PLS-02 | As a user, I want to link receipts to purchases | [CRITICAL] |
| US-PLS-03 | As a user, I want to search my receipts | [CORE] |
| US-PLS-04 | As a user, I want to store return shipping labels | [CORE] |
| US-PLS-05 | As a user, I want auto-extracted line items from receipts | [FUTURE] |

---

## Navigation

- **Previous:** [Cost Tracking](70.14-cost-tracking.md)
- **Next:** [Return Tracking](70.16-return-tracking.md)
- **Back to:** [README](README.md)
