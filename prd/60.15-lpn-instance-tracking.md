# 60.15 LPN Instance Tracking

This document specifies the License Plate Number (LPN) system for tracking individual product instances in Homebot.

---

## 60.15.1 Overview

LPN tracking enables instance-level inventory management:

- **Track specific units** - Not just "5 bottles of Advil" but "this specific bottle"
- **Remaining quantity** - Track pills remaining, uses left, portions consumed
- **Serial numbers** - Link to manufacturer serial for electronics, appliances
- **FIFO enforcement** - Ensure oldest instances are consumed first
- **Specific identification costing** - Track exact purchase price per instance

---

## 60.15.2 When to Use LPNs

| Category | Use LPN? | Rationale |
|----------|----------|-----------|
| Medications | Yes | Track pills remaining, expiration critical |
| Supplements | Yes | Track doses remaining |
| Electronics | Yes | Serial number, warranty tracking |
| Bulk items | Optional | Track portions/uses remaining |
| Perishables | Optional | Only if tracking specific units matters |
| Commodities | No | Fungible items, just track quantity |

LPN tracking is opt-in per product. Users enable it when needed.

---

## 60.15.3 Data Model

### Product Instance Table

```sql
CREATE TABLE product_instances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    product_id UUID NOT NULL REFERENCES products(id),
    location_id UUID NOT NULL REFERENCES locations(id),
    
    -- LPN (from QR token system)
    qr_token_id UUID REFERENCES qr_tokens(id),
    
    -- Instance details
    serial_number VARCHAR(100),
    batch_number VARCHAR(100),
    
    -- Quantity tracking
    initial_quantity INTEGER NOT NULL DEFAULT 1,
    remaining_quantity INTEGER NOT NULL DEFAULT 1,
    quantity_unit VARCHAR(50),  -- pills, doses, uses, portions
    
    -- Dates
    manufactured_date DATE,
    expiration_date DATE,
    opened_date DATE,
    
    -- Purchase info (for specific identification)
    purchase_id UUID REFERENCES purchases(id),
    unit_cost DECIMAL(10, 2),
    
    -- Status
    status VARCHAR(20) DEFAULT 'active',  -- active, consumed, disposed, returned
    
    -- Custom attributes
    attributes JSONB DEFAULT '{}',
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_instances_product ON product_instances(product_id);
CREATE INDEX idx_instances_location ON product_instances(location_id);
CREATE INDEX idx_instances_expiration ON product_instances(expiration_date);
CREATE INDEX idx_instances_status ON product_instances(status) WHERE status = 'active';

-- RLS
ALTER TABLE product_instances ENABLE ROW LEVEL SECURITY;
CREATE POLICY instances_tenant_isolation ON product_instances
    USING (tenant_id = current_setting('app.tenant_id')::uuid);
```

### Instance Transaction Log

```sql
CREATE TABLE instance_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    instance_id UUID NOT NULL REFERENCES product_instances(id),
    
    transaction_type VARCHAR(20) NOT NULL,  -- consume, adjust, transfer, open
    quantity_change INTEGER NOT NULL,
    quantity_before INTEGER NOT NULL,
    quantity_after INTEGER NOT NULL,
    
    -- Context
    performed_by UUID REFERENCES users(id),
    notes TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 60.15.4 Instance States

```
┌─────────────┐
│   Created   │
└──────┬──────┘
       │ Add to inventory
       ▼
┌─────────────┐      Open
│   Sealed    │ ─────────────┐
└──────┬──────┘              │
       │ Consume             ▼
       │              ┌─────────────┐
       │              │   Opened    │
       │              └──────┬──────┘
       │                     │ Consume
       ▼                     ▼
┌─────────────┐       ┌─────────────┐
│  Consumed   │◄──────│  Partially  │
│  (qty = 0)  │       │  Consumed   │
└─────────────┘       └─────────────┘
       │
       │ Archive
       ▼
┌─────────────┐
│  Archived   │
└─────────────┘
```

---

## 60.15.5 FIFO Enforcement

When consuming a product with LPN tracking enabled:

```python
def consume_product(product_id: UUID, quantity: int, location_id: UUID) -> list[InstanceConsumption]:
    """Consume quantity using FIFO from oldest instances."""
    
    # Get active instances sorted by expiration (FEFO) or created (FIFO)
    instances = db.query(ProductInstance).filter(
        ProductInstance.product_id == product_id,
        ProductInstance.location_id == location_id,
        ProductInstance.status == 'active',
        ProductInstance.remaining_quantity > 0
    ).order_by(
        ProductInstance.expiration_date.asc().nullslast(),
        ProductInstance.created_at.asc()
    ).all()
    
    remaining_to_consume = quantity
    consumptions = []
    
    for instance in instances:
        if remaining_to_consume <= 0:
            break
            
        consume_from_instance = min(instance.remaining_quantity, remaining_to_consume)
        
        instance.remaining_quantity -= consume_from_instance
        if instance.remaining_quantity == 0:
            instance.status = 'consumed'
        
        remaining_to_consume -= consume_from_instance
        consumptions.append(InstanceConsumption(
            instance_id=instance.id,
            quantity=consume_from_instance
        ))
    
    return consumptions
```

---

## 60.15.6 Enabling LPN for a Product

### Product Settings

```sql
-- Add to products table
ALTER TABLE products ADD COLUMN lpn_tracking_enabled BOOLEAN DEFAULT FALSE;
ALTER TABLE products ADD COLUMN lpn_quantity_unit VARCHAR(50);  -- pills, doses, uses
ALTER TABLE products ADD COLUMN lpn_initial_quantity INTEGER;   -- default for new instances
```

### Enable Flow

```
1. User goes to product settings
2. Enables "Track individual instances"
3. Sets quantity unit (pills, doses, uses, portions)
4. Sets default initial quantity (e.g., 100 pills)
5. Existing stock optionally converted to instances
```

---

## 60.15.7 Quantity Tracking UI

### Instance Detail View

```
┌─────────────────────────────────────────────────────────────────┐
│  Advil 200mg - Instance K3D-7K3QF-X                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Remaining: 93 / 100 pills                                 │  │
│  │ ████████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │  │
│  │                                              93%          │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Expires: March 15, 2027                                        │
│  Opened: February 1, 2026                                       │
│  Location: Medicine Cabinet                                     │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   [-] Take 1    │  │   [-] Take 2    │  │   [#] Custom    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                                                                  │
│  Recent Activity:                                                │
│  • Feb 3: Took 2 pills (95 → 93)                                │
│  • Feb 2: Took 1 pill (96 → 95)                                 │
│  • Feb 1: Opened bottle (100 remaining)                         │
│  • Jan 28: Added to inventory                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 60.15.8 API Endpoints

### Create Instance

```http
POST /api/v2/products/{product_id}/instances
Content-Type: application/json

{
  "location_id": "...",
  "initial_quantity": 100,
  "quantity_unit": "pills",
  "expiration_date": "2027-03-15",
  "serial_number": "LOT-2026-001",
  "purchase_id": "...",
  "unit_cost": 12.99
}
```

### Consume from Instance

```http
POST /api/v2/instances/{instance_id}/consume
Content-Type: application/json

{
  "quantity": 2,
  "notes": "Morning dose"
}
```

### Adjust Quantity

```http
POST /api/v2/instances/{instance_id}/adjust
Content-Type: application/json

{
  "new_quantity": 90,
  "reason": "Physical count correction"
}
```

### Get Instance History

```http
GET /api/v2/instances/{instance_id}/transactions

Response:
{
  "transactions": [
    {
      "type": "consume",
      "quantity_change": -2,
      "quantity_before": 95,
      "quantity_after": 93,
      "performed_by": "Alex",
      "created_at": "2026-02-03T08:30:00Z"
    }
  ]
}
```

---

## 60.15.9 Mixed Inventory

A product can have both:
- **Tracked instances** (with LPN)
- **Untracked stock** (traditional quantity)

```sql
-- Stock view combining both
CREATE VIEW product_stock_view AS
SELECT 
    product_id,
    location_id,
    -- Untracked stock
    COALESCE(stock.quantity, 0) AS untracked_quantity,
    -- Tracked instances
    COALESCE(SUM(instances.remaining_quantity), 0) AS tracked_quantity,
    -- Instance count
    COUNT(instances.id) AS instance_count,
    -- Total
    COALESCE(stock.quantity, 0) + COALESCE(SUM(instances.remaining_quantity), 0) AS total_quantity
FROM products p
LEFT JOIN stock ON stock.product_id = p.id
LEFT JOIN product_instances instances 
    ON instances.product_id = p.id 
    AND instances.status = 'active'
GROUP BY product_id, location_id, stock.quantity;
```

---

## 60.15.10 Inventory Reconciliation

When enabling LPN tracking for existing stock:

```
┌─────────────────────────────────────────────────────────────────┐
│  Enable Instance Tracking for: Advil 200mg                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Current Stock: 5 units (untracked)                             │
│                                                                  │
│  How would you like to handle existing stock?                   │
│                                                                  │
│  ○ Convert all to instances                                     │
│    Create 5 instances, each with 100 pills (default)            │
│                                                                  │
│  ○ Keep untracked, track new only                               │
│    New additions will be tracked, existing stays as-is          │
│                                                                  │
│  ○ Enter actual counts now                                      │
│    Specify remaining quantity for each bottle                   │
│                                                                  │
│                                             [Cancel] [Continue]  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 60.15.11 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-LPN-01 | As a user, I want to track pills remaining in my medication bottles | [CRITICAL] |
| US-LPN-02 | As a user, I want the system to use FIFO when consuming tracked products | [CRITICAL] |
| US-LPN-03 | As a user, I want to see a history of consumption for each instance | [CORE] |
| US-LPN-04 | As a user, I want to quickly log "took 2 pills" without full UI | [CORE] |
| US-LPN-05 | As a user, I want to enable tracking for existing stock during reconciliation | [FLEX] |
| US-LPN-06 | As a user, I want to track serial numbers for electronics | [FLEX] |

---

## Navigation

- **Previous:** [Container Management](60.14-container-management.md)
- **Next:** [People & Consumption](70.10-people-consumption.md)
- **Back to:** [README](README.md)
