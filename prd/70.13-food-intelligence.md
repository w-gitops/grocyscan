# 70.13 Food Intelligence

This document specifies the food analysis and intelligence features for Homebot.

---

## 70.13.1 Overview

Intelligent food analysis and safety:

- **Ingredient parsing** - Extract ingredients from product data
- **Processing concerns** - Flag seed oils, artificial ingredients
- **Allergen detection** - Highlight allergens for household members
- **Food safety** - Storage guidelines, temperature requirements
- **Proprietary blends** - Analyze hidden ingredient lists

---

## 70.13.2 Custom Attributes

Products support flexible custom attributes stored as JSONB:

```sql
-- Already exists on products table
ALTER TABLE products ADD COLUMN attributes JSONB DEFAULT '{}';

-- Tenant-level attribute definitions
CREATE TABLE attribute_definitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    
    -- Attribute path (dot notation)
    path VARCHAR(255) NOT NULL,  -- e.g., "nutrition.calories"
    
    -- Schema
    value_type VARCHAR(20) NOT NULL,  -- string, number, boolean, array, object
    enum_values TEXT[],  -- Allowed values for enums
    
    -- UI hints
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    category VARCHAR(50),  -- nutrition, safety, processing
    
    -- Validation
    required BOOLEAN DEFAULT FALSE,
    min_value DECIMAL,
    max_value DECIMAL,
    pattern VARCHAR(255),  -- Regex for strings
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(tenant_id, path)
);
```

### Attribute Operations

```python
# Set attribute using dot path
PATCH /api/v2/products/{id}/attributes
{
  "set": {
    "nutrition.calories": 150,
    "nutrition.protein": 8,
    "concerns.seed_oils": true
  },
  "unset": [
    "old_field"
  ]
}

# Read effective attributes (merged with defaults)
GET /api/v2/products/{id}/attributes
{
  "nutrition": {
    "calories": 150,
    "protein": 8,
    "carbs": null,
    "fat": null
  },
  "concerns": {
    "seed_oils": true,
    "artificial_colors": false
  }
}
```

---

## 70.13.3 Ingredient Parsing

### Extract from Product Data

```python
async def parse_ingredients(product_data: dict) -> ParsedIngredients:
    """Parse and analyze ingredients from product data."""
    
    raw_ingredients = product_data.get("ingredients_text", "")
    
    # Use LLM for complex parsing
    prompt = f"""
    Parse these ingredients into structured data:
    
    {raw_ingredients}
    
    Return JSON with:
    - ingredients: [{{name, amount, unit, is_allergen, concerns}}]
    - allergens: [list of detected allergens]
    - concerns: [processing concerns like seed oils, artificial colors]
    - proprietary_blends: [{{name, total_amount, sub_ingredients}}]
    """
    
    result = await llm.generate(prompt)
    return ParsedIngredients.parse_raw(result)
```

### Ingredient Model

```sql
CREATE TABLE product_ingredients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID NOT NULL REFERENCES products(id),
    
    -- Ingredient info
    name VARCHAR(255) NOT NULL,
    amount DECIMAL(10, 3),
    amount_unit VARCHAR(50),
    
    -- Position in list (earlier = more)
    sort_order INTEGER,
    
    -- Flags
    is_allergen BOOLEAN DEFAULT FALSE,
    allergen_type VARCHAR(50),  -- milk, eggs, peanuts, etc.
    
    -- Parent (for nested ingredients)
    parent_id UUID REFERENCES product_ingredients(id),
    is_proprietary_blend BOOLEAN DEFAULT FALSE
);
```

---

## 70.13.4 Processing Concerns

### Concern Types

| Concern | Description | Examples |
|---------|-------------|----------|
| `seed_oils` | Industrial seed/vegetable oils | Canola, soybean, sunflower oil |
| `artificial_colors` | Synthetic food dyes | Red 40, Yellow 5, Blue 1 |
| `artificial_flavors` | Synthetic flavoring | "Natural flavors" can be included |
| `preservatives` | Chemical preservatives | BHA, BHT, sodium benzoate |
| `added_sugars` | Non-natural sweeteners | High fructose corn syrup |
| `msg` | Monosodium glutamate | MSG, hydrolyzed protein |
| `gums` | Thickening agents | Xanthan gum, carrageenan |
| `bpa` | Packaging concerns | BPA-lined cans |

### Detection

```python
CONCERN_PATTERNS = {
    "seed_oils": [
        r"canola oil", r"soybean oil", r"vegetable oil",
        r"corn oil", r"sunflower oil", r"safflower oil",
        r"cottonseed oil", r"rapeseed oil"
    ],
    "artificial_colors": [
        r"red \d+", r"yellow \d+", r"blue \d+",
        r"fd&c", r"artificial color"
    ],
    "msg": [
        r"monosodium glutamate", r"msg",
        r"hydrolyzed (?:vegetable |soy )?protein",
        r"autolyzed yeast"
    ]
}

def detect_concerns(ingredients_text: str) -> list[str]:
    """Detect processing concerns in ingredients."""
    concerns = []
    text = ingredients_text.lower()
    
    for concern, patterns in CONCERN_PATTERNS.items():
        for pattern in patterns:
            if re.search(pattern, text):
                concerns.append(concern)
                break
    
    return concerns
```

---

## 70.13.5 Allergen Detection

### Major Allergens (FDA Top 9)

| Allergen | Examples |
|----------|----------|
| Milk | Milk, lactose, casein, whey |
| Eggs | Eggs, albumin, lysozyme |
| Fish | Cod, salmon, anchovy |
| Shellfish | Shrimp, crab, lobster |
| Tree Nuts | Almonds, walnuts, cashews |
| Peanuts | Peanuts, peanut oil |
| Wheat | Wheat, flour, gluten |
| Soy | Soy, soybean, tofu |
| Sesame | Sesame seeds, tahini |

### Household Allergen Alerts

```python
async def check_allergens_for_household(
    product_id: UUID,
    tenant_id: UUID,
    db: Session
) -> list[AllergenAlert]:
    """Check product allergens against household members."""
    
    product = db.query(Product).get(product_id)
    allergens = product.detected_allergens or []
    
    people = db.query(Person).filter(
        Person.tenant_id == tenant_id,
        Person.allergies != None
    ).all()
    
    alerts = []
    for person in people:
        matching = set(allergens) & set(person.allergies)
        if matching:
            alerts.append(AllergenAlert(
                person=person.name,
                allergens=list(matching),
                severity="warning"
            ))
    
    return alerts
```

---

## 70.13.6 Food Safety

### Storage Guidelines

```sql
CREATE TABLE food_safety_guidelines (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Matching
    product_category VARCHAR(100),
    product_keywords TEXT[],
    
    -- Storage
    storage_temp_min_f INTEGER,
    storage_temp_max_f INTEGER,
    storage_location VARCHAR(50),  -- pantry, fridge, freezer
    
    -- Shelf life
    unopened_days INTEGER,
    opened_days INTEGER,
    frozen_months INTEGER,
    
    -- Special handling
    keep_refrigerated BOOLEAN DEFAULT FALSE,
    freeze_for_longer BOOLEAN DEFAULT FALSE,
    special_notes TEXT
);

-- Example data
INSERT INTO food_safety_guidelines (product_category, storage_location, unopened_days, opened_days) VALUES
('dairy_milk', 'fridge', 14, 7),
('eggs', 'fridge', 35, 35),
('bread', 'pantry', 7, 7),
('canned_goods', 'pantry', 730, 5),
('frozen_vegetables', 'freezer', 365, 90);
```

### Product Safety View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Milk - Organic Whole                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â„ï¸ Food Safety                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Storage: Refrigerator (35-40Â°F)                           â”‚  â”‚
â”‚  â”‚ Unopened: 14 days                                         â”‚  â”‚
â”‚  â”‚ After Opening: 5-7 days                                   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ âš ï¸ Keep refrigerated at all times                        â”‚  â”‚
â”‚  â”‚ âš ï¸ Do not freeze (texture will change)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  ğŸ§¬ Ingredients Analysis                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Ingredients: Organic whole milk, vitamin D3               â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Allergens: ğŸ¥› Milk                                        â”‚  â”‚
â”‚  â”‚ Concerns: None detected âœ“                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ âš ï¸ Contains allergen for: Sam (milk allergy)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 70.13.7 API Endpoints

### Get Attribute Definitions

```http
GET /api/v2/attribute-definitions

Response:
{
  "definitions": [
    {
      "path": "nutrition.calories",
      "display_name": "Calories",
      "value_type": "number",
      "category": "nutrition"
    },
    {
      "path": "concerns.seed_oils",
      "display_name": "Contains Seed Oils",
      "value_type": "boolean",
      "category": "processing"
    }
  ]
}
```

### Analyze Product

```http
POST /api/v2/products/{id}/analyze
Content-Type: application/json

{
  "analyze": ["ingredients", "allergens", "concerns", "safety"]
}

Response:
{
  "ingredients": [...],
  "allergens": ["milk"],
  "concerns": ["seed_oils"],
  "safety": {
    "storage": "refrigerator",
    "shelf_life_days": 14
  },
  "household_alerts": [
    {
      "person": "Sam",
      "allergens": ["milk"],
      "severity": "warning"
    }
  ]
}
```

### Get Safety Guidelines

```http
GET /api/v2/products/{id}/safety

Response:
{
  "product_id": "...",
  "storage_location": "refrigerator",
  "storage_temp": "35-40Â°F",
  "unopened_days": 14,
  "opened_days": 7,
  "notes": ["Keep refrigerated", "Do not freeze"]
}
```

---

## 70.13.8 User Stories

| ID | Story | Priority |
|----|-------|----------|
| US-FI-01 | As a user, I want to see allergen warnings based on my family's allergies | [CRITICAL] |
| US-FI-02 | As a user, I want to know if products contain seed oils | [CORE] |
| US-FI-03 | As a user, I want food safety guidelines for storage | [CORE] |
| US-FI-04 | As a user, I want to see parsed ingredients list | [CORE] |
| US-FI-05 | As a user, I want to define custom attributes for products | [FLEX] |
| US-FI-06 | As a user, I want processing concern analysis (artificial colors, etc.) | [FLEX] |

---

## Navigation

- **Previous:** [Shopping Lists](70.12-shopping-lists.md)
- **Next:** [Cost Tracking](70.14-cost-tracking.md)
- **Back to:** [README](README.md)
