# 10.10 Standards of Development

This document establishes the development methodology, quality standards, and tooling requirements for Homebot.

---

## 10.10.1 Development Methodology

This project follows the **Ralph Wiggum** autonomous development methodology.

### Core Principles

1. **State in Files** - Progress persists in files and git, not conversation context
2. **Iterative Completion** - One criterion at a time, committed incrementally
3. **Fail Forward** - Learn from failures via guardrails, don't repeat mistakes
4. **Fresh Context** - Each session reads state from files, enabling seamless continuation

### Task Management

All development work is tracked in `RALPH_TASK.md`:

```yaml
---
task: Description of what to build
test_command: "pytest tests/ -v"
browser_validation: true
base_url: "http://localhost:3334"
---

## Success Criteria

1. [ ] [CRITICAL] First criterion - must work for MVP
2. [ ] [CORE] Second criterion - expected functionality
3. [ ] [FLEX] Third criterion - nice to have
4. [ ] [FUTURE] Fourth criterion - defer to later phase
```

### Criticality Tags

| Tag | Meaning | Action |
|-----|---------|--------|
| `[CRITICAL]` | Must work for MVP to ship | Block release if failing |
| `[CORE]` | Expected functionality | Prioritize highly |
| `[FLEX]` | Nice to have | Implement if time allows |
| `[FUTURE]` | Planned for later phase | Skip in current phase |

### State Files

The `.ralph/` directory contains:

| File | Purpose |
|------|---------|
| `progress.md` | Session history and accomplishments |
| `guardrails.md` | Lessons learned from failures |
| `screenshots/` | Browser validation evidence |

---

## 10.10.2 Guardrails ("Signs")

### The Signs Metaphor

> "Ralph is very good at making playgrounds, but he comes home bruised because he fell off the slide, so one then tunes Ralph by adding a sign next to the slide saying 'SLIDE DOWN, DON'T JUMP, LOOK AROUND,' and Ralph is more likely to look and see the sign."

Signs are explicit instructions added to prevent known failure modes.

### Anatomy of a Sign

```markdown
### Sign: [Descriptive Name]
- **Trigger**: When this situation occurs
- **Instruction**: What to do instead
- **Added after**: When/why this was added
- **Example**: Concrete example if helpful
```

### Types of Signs

| Type | Purpose | Example |
|------|---------|---------|
| **Preventive** | Stop problems before they happen | Validate all input |
| **Corrective** | Fix recurring mistakes | Check return values |
| **Process** | Enforce good practices | Test before commit |
| **Architecture** | Guide design decisions | Single responsibility |

### When to Add Signs

Add a sign when:

1. **The same mistake happens twice** - Once is learning, twice is a pattern
2. **A subtle bug is found** - Prevent future occurrences
3. **A best practice is violated** - Reinforce good habits
4. **Context-specific knowledge is needed** - Project-specific conventions

### Example Signs Library

```markdown
### Sign: Sanitize All Input
- **Trigger**: Any user-provided data
- **Instruction**: Use parameterized queries, escape HTML, validate types
- **Example**: `db.query("SELECT * FROM users WHERE id = ?", [userId])`

### Sign: Graceful Degradation
- **Trigger**: External service calls
- **Instruction**: Always have a fallback for when services are unavailable
- **Example**: Cache results, provide default values, show friendly errors

### Sign: Test the Unhappy Path
- **Trigger**: Writing tests for new functionality
- **Instruction**: Include tests for error cases, edge cases, and invalid input
```

---

## 10.10.3 Git Workflow

### Branching Strategy

| Branch | Purpose |
|--------|---------|
| `main` | Production-ready code |
| `dev` | Integration branch for active development |
| `ralph-iteration-N` | Ralph Wiggum cloud agent branches |
| `feature/*` | Manual feature development |

### Ralph Cloud Mode Workflow

When context limits are reached, Ralph spawns cloud agents:

```
(main/dev)  A---B---------------------------G---H---> (local work)
             \
              \
(ralph-iter-1) ---C---D---E---F------------> (cloud agent work)
```

**Handoff Process:**
1. Stop-hook detects context limit ("gutter" situation)
2. Script commits uncommitted changes and pushes to origin
3. Cloud agent creates `ralph-iteration-N` branch
4. Agent works until complete, stuck, or hits limits

**Merge Back (Manual):**
```bash
# Fetch and review
git fetch origin
git checkout ralph-iteration-1
# Review commits, run tests

# Merge with squash
git checkout dev
git merge --squash ralph-iteration-1
git commit -m "feat: Integrate work from Ralph iteration 1"
git push origin dev

# Clean up
git branch -d ralph-iteration-1
git push origin --delete ralph-iteration-1
```

### Commit Protocol

#### During Ralph Sessions

- **Format**: `ralph: [N] Description` where N is criterion number
- **Frequency**: One commit per completed criterion
- **Content**: Each commit should be atomic and reversible

#### General Development (Conventional Commits)

```
<type>(<scope>): <description>

[optional body]

[optional footer]
```

**Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`, `perf`

**Scopes for Homebot:** `api`, `ui`, `db`, `lookup`, `llm`, `grocy`, `scanner`, `cache`, `auth`, `logging`, `tenant`, `qr`, `label`, `container`

**Examples:**
```
feat(lookup): add Brave Search API provider
fix(scanner): handle empty barcode input
docs(readme): add installation instructions
feat(tenant): implement RLS policies
```

---

## 10.10.4 Quality Standards

### Code Quality

| Standard | Requirement |
|----------|-------------|
| **Type Safety** | All code must pass type checking |
| **Linting** | No linting errors in committed code |
| **Formatting** | Consistent formatting (auto-format on save) |
| **Documentation** | Public APIs must have docstrings |

#### Python Backend (FastAPI)

- Python 3.13+
- Follow PEP 8
- Use type hints for all function parameters and returns
- Maximum line length: 100 characters
- Use docstrings for all public functions and classes
- Tools: `black` for formatting, `ruff` for linting

```python
from typing import Optional

async def lookup_item(
    item_id: str,
    include_metadata: bool = True,
) -> Optional[ItemDetail]:
    """
    Look up item information by ID.
    
    Args:
        item_id: The item identifier
        include_metadata: Whether to include additional metadata
    
    Returns:
        Item details if found, None otherwise
    
    Raises:
        LookupError: If the lookup service fails
    """
    pass
```

#### TypeScript Frontend (Vue/Quasar)

- TypeScript strict mode
- Vue 3 Composition API with `<script setup>`
- Pinia for state management
- Tools: ESLint, Prettier

```typescript
// Component example
<script setup lang="ts">
import { ref, computed } from 'vue'
import { useProductStore } from '@/stores/product'

interface Props {
  productId: string
  showDetails?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  showDetails: true
})

const store = useProductStore()
const product = computed(() => store.getById(props.productId))
</script>
```

### Testing Requirements

| Level | Coverage Target | When Required |
|-------|-----------------|---------------|
| Unit Tests | >80% | All business logic |
| Integration Tests | Critical paths | API endpoints, database operations |
| Database Tests | Migrations | Schema changes |
| Browser Tests | UI criteria | Forms, navigation, user flows |

#### Test Structure

```
tests/
├── conftest.py              # Shared fixtures
├── unit/                    # Unit tests
├── integration/             # Integration tests
└── e2e/                     # BrowserMCP end-to-end tests
```

---

## 10.10.5 MCP Browser Validation

For UI-related criteria, MCP browser tools provide validation:

### Workflow (cursor-browser-extension)

```
1. browser_navigate → Open target page (returns snapshot)
2. browser_snapshot → Get page structure with refs (@e1, @e2)
3. [interactions] → click, type, fill using refs
4. browser_take_screenshot → Capture evidence
```

### Key Rules

- ALWAYS call `browser_snapshot` before clicking/typing to get element refs
- Use element refs from snapshot (e.g., `@e3`) for interactions
- Use short waits (2-3s) with snapshot checks, not long waits
- Save screenshots to `.ralph/screenshots/criterion-N.png`
- Reference screenshots in `progress.md`

### Evidence Collection

- Screenshots saved to `.ralph/screenshots/`
- Named: `criterion-N-description.png`
- Referenced in `progress.md`

---

## 10.10.6 Definition of Done

A criterion is complete when:

- [ ] Code implemented and compiles
- [ ] All tests pass (`test_command` succeeds)
- [ ] Browser validation passes (if UI criterion)
- [ ] Changes committed with `ralph: [N]` prefix
- [ ] `RALPH_TASK.md` updated: `[ ]` → `[x]`
- [ ] `.ralph/progress.md` updated with summary

---

## 10.10.7 Failure Handling

When something fails:

1. **Don't Repeat** - Same approach failing twice = add guardrail
2. **Document** - Add to `.ralph/guardrails.md`:
   ```markdown
   ### Sign: [Short description]
   - **Trigger**: When this applies
   - **Instruction**: What to do instead
   - **Added after**: Session N - reason
   ```
3. **Move Forward** - Try different approach or next criterion
4. **Signal if Stuck** - `<ralph>GUTTER</ralph>` after 3 failures

### Ralph Signals

| Signal | When to Use |
|--------|-------------|
| `<ralph>COMPLETE</ralph>` | All criteria are `[x]` |
| `<ralph>BLOCKED</ralph>` | Need human input to proceed |
| `<ralph>GUTTER</ralph>` | Stuck repeating same failure |
| `<ralph>BROWSER_NEEDED</ralph>` | UI validation needed but unavailable |

---

## 10.10.8 Session Protocol

### Starting a Session

1. Read `RALPH_TASK.md` - Find unchecked criteria
2. Read `.ralph/guardrails.md` - Follow all active guardrails
3. Read `.ralph/progress.md` - Understand current state
4. Check `git log` - Review recent commits

### Ending a Session

1. Commit any pending work
2. Update `progress.md` with session summary
3. Push to remote
4. Note any blockers for next session

---

## 10.10.9 Logging Standards

### Log Format (JSON)

All applications should emit structured JSON logs with these fields:

```json
{
  "timestamp": "2026-02-02T00:15:32.123456Z",
  "level": "INFO",
  "message": "Barcode scan completed",
  "logger": "homebot.services.lookup",
  "trace_id": "abc123...",
  "span_id": "def456...",
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "tenant_id": "550e8400-e29b-41d4-a716-446655440001",
  "barcode": "012345678901",
  "provider": "openfoodfacts",
  "duration_ms": 234
}
```

### Log Levels

| Level | Usage |
|-------|-------|
| **DEBUG** | Detailed diagnostic information |
| **INFO** | Normal operations, business events |
| **WARNING** | Unexpected but recoverable situations |
| **ERROR** | Errors that prevented operation completion |
| **CRITICAL** | System-wide failures |

---

## 10.10.10 Observability Standards

### Three Pillars

| Pillar | Tool | Purpose |
|--------|------|---------|
| **Logs** | Loki + Promtail | Structured JSON logs with trace correlation |
| **Metrics** | Prometheus | Counters, histograms, gauges |
| **Traces** | Tempo + OpenTelemetry | Distributed request tracing |

### Custom Metrics Patterns

```python
from prometheus_client import Counter, Histogram, Gauge

# Counters - for events that only increase
SCAN_COUNTER = Counter(
    "homebot_scans_total",
    "Total number of barcode scans",
    ["status", "input_method", "provider", "tenant_id"]
)

# Histograms - for measuring durations/sizes
LOOKUP_DURATION = Histogram(
    "homebot_lookup_duration_seconds",
    "Duration of barcode lookups",
    ["provider"],
    buckets=[0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]
)
```

---

## 10.10.11 Security Standards

### Secrets Management

- Store all secrets in environment variables
- Use `SecretStr` type for secrets in configuration (Pydantic)
- Never log secrets or expose in error messages

```python
from pydantic_settings import BaseSettings
from pydantic import SecretStr

class Settings(BaseSettings):
    SECRET_KEY: SecretStr
    DATABASE_URL: SecretStr
    GROCY_API_KEY: SecretStr
    LLM_API_KEY: SecretStr = SecretStr("")
    BRAVE_API_KEY: SecretStr = SecretStr("")
    
    class Config:
        env_file = ".env"
```

### Security Checklist

- [ ] All secrets stored in environment variables
- [ ] Database credentials use strong passwords
- [ ] API keys have minimum required permissions
- [ ] TLS enabled for all external connections
- [ ] Session cookies marked as HttpOnly and Secure
- [ ] CORS configured to allow only trusted origins
- [ ] Rate limiting enabled on all endpoints
- [ ] Input validation on all user inputs
- [ ] Logs do not contain sensitive data
- [ ] Dependencies scanned for vulnerabilities
- [ ] Tenant isolation enforced via RLS

---

## 10.10.12 Database Migration Standards

### Migration Principles

1. **Never modify existing migrations** - Always create new ones
2. **Always provide rollback** - Every `upgrade()` needs `downgrade()`
3. **Zero-downtime migrations** - Use multi-step approach for breaking changes
4. **Test migrations** - Run against copy of production data
5. **Backup before migration** - Always backup database first

### Zero-Downtime Patterns

**Adding non-nullable column (multi-step):**

```python
# Migration 1: Add column as nullable
def upgrade():
    op.add_column('products', sa.Column('sku', sa.String(100), nullable=True))

# Migration 2: Backfill data
def upgrade():
    op.execute("UPDATE products SET sku = 'SKU-' || id WHERE sku IS NULL")

# Migration 3: Add NOT NULL constraint
def upgrade():
    op.alter_column('products', 'sku', nullable=False)
```

---

## 10.10.13 API Design Standards

### Error Response Format

All API errors should use a consistent format:

```python
class ErrorResponse(BaseModel):
    error: str           # Error code/type
    message: str         # Human-readable message
    details: dict | None # Additional context
    request_id: str | None
```

### Tenant-Aware Exceptions

```python
class HomebotException(Exception):
    """Base exception for Homebot."""
    def __init__(self, message: str, details: dict | None = None):
        self.message = message
        self.details = details

class TenantNotSelectedError(HomebotException):
    """No active tenant in session."""
    pass

class TenantMismatchError(HomebotException):
    """QR code belongs to different tenant."""
    pass

class BarcodeNotFoundError(HomebotException):
    """Barcode not found in any lookup provider."""
    pass
```

---

## 10.10.14 Versioning Standards

### Semantic Versioning: MAJOR.MINOR.PATCH

| Component | When to Increment |
|-----------|-------------------|
| **MAJOR** | Breaking API changes |
| **MINOR** | New features, backwards compatible |
| **PATCH** | Bug fixes, backwards compatible |

### Pre-release Tags

- Alpha: `1.0.0-alpha.1`
- Beta: `1.0.0-beta.1`
- Release Candidate: `1.0.0-rc.1`

---

## 10.10.15 Project Structure

### Homebot Directory Layout

```
homebot/
├── backend/
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                    # FastAPI entry
│   │   ├── config.py                  # Settings from environment
│   │   │
│   │   ├── api/                       # FastAPI REST endpoints
│   │   │   ├── v2/                    # Primary API
│   │   │   │   ├── scan.py
│   │   │   │   ├── products.py
│   │   │   │   └── tenants.py
│   │   │   └── compat/                # Grocy compatibility layer
│   │   │       └── stock.py
│   │   │
│   │   ├── services/                  # Business logic
│   │   │   ├── lookup/                # Barcode lookup providers
│   │   │   ├── llm/                   # LLM optimization
│   │   │   ├── grocy/                 # Grocy API client
│   │   │   └── tenant/                # Multi-tenant operations
│   │   │
│   │   ├── db/                        # Database layer
│   │   │   ├── database.py
│   │   │   ├── models.py
│   │   │   └── rls.py                 # Row-level security
│   │   │
│   │   └── schemas/                   # Pydantic models
│   │
│   ├── migrations/                    # Alembic migrations
│   └── tests/
│
├── frontend/                          # Vue.js 3 + Quasar
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── stores/                    # Pinia stores
│   │   ├── composables/
│   │   └── router/
│   └── quasar.config.js
│
├── docker/
├── scripts/
│
├── .env.example
├── pyproject.toml
├── RALPH_TASK.md
└── README.md
```

---

## 10.10.16 Tips for AI Agents

> **Common Pitfalls to Avoid**

### Logging
- Don't log sensitive data (passwords, API keys, tokens)
- Include correlation IDs (trace_id, request_id, tenant_id) in all logs
- Use structured logging, not string interpolation

### Database
- Never modify existing migration files
- Always test migrations on a data copy first
- Use transactions for multi-step operations
- Always include `tenant_id` in queries (RLS handles this)

### API Design
- Validate all inputs with Pydantic
- Return consistent error formats
- Include request_id in error responses for debugging
- Return 409 for tenant-related errors

### Testing
- Mock external services, don't call them in tests
- Use fixtures for database sessions with automatic rollback
- Keep tests independent - no shared state between tests

### Security
- Use `SecretStr` for sensitive configuration
- Never commit `.env` files
- Validate and sanitize all user inputs
- Test RLS policies with multiple tenant contexts

### Homebot Specific
- Always check Grocy connection before API calls
- Cache lookup results to avoid rate limiting
- Handle offline mode gracefully with job queue
- Set `app.tenant_id` in database session before queries

---

## Navigation

- **Next:** [Executive Summary](10.11-executive-summary.md)
- **Back to:** [README](README.md)
