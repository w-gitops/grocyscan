# 40.11 Observability Stack

## 40.11.1 Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            HOMEBOT APPLICATION                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────────────────┐ │
│  │    Structlog     │  │  OpenTelemetry   │  │  Prometheus Instrumentator │ │
│  │  (JSON Logging)  │  │    (Tracing)     │  │       (Metrics)            │ │
│  └────────┬─────────┘  └────────┬─────────┘  └─────────────┬──────────────┘ │
└───────────┼─────────────────────┼──────────────────────────┼────────────────┘
            │                     │                          │
            ▼                     ▼                          ▼
     ┌──────────────┐     ┌──────────────┐          ┌──────────────┐
     │   Promtail   │     │     OTel     │          │  Prometheus  │
     │  (Log Agent) │     │  Collector   │          │   (Scrape)   │
     └──────┬───────┘     └──────┬───────┘          └──────┬───────┘
            │                    │                         │
            ▼                    ▼                         │
     ┌──────────────┐     ┌──────────────┐                │
     │     Loki     │     │    Tempo     │                │
     │   (Logs)     │     │  (Traces)    │                │
     └──────┬───────┘     └──────┬───────┘                │
            │                    │                         │
            └────────────────────┼─────────────────────────┘
                                 ▼
                          ┌──────────────┐
                          │   Grafana    │
                          │ (Dashboards) │
                          └──────────────┘
```

## 40.11.2 Logging Implementation

### Structlog Configuration

```python
# app/core/logging.py
import structlog
import logging
import sys
from datetime import datetime, timezone
from typing import Any
from opentelemetry import trace


def configure_logging(log_level: str = "INFO", json_output: bool = True):
    """Configure structured logging with structlog."""
    
    shared_processors = [
        structlog.contextvars.merge_contextvars,
        structlog.processors.add_log_level,
        structlog.processors.TimeStamper(fmt="iso", utc=True),
        add_otel_context,  # Inject trace/span IDs
        structlog.processors.StackInfoRenderer(),
        structlog.processors.UnicodeDecoder(),
    ]
    
    if json_output:
        processors = shared_processors + [
            structlog.processors.format_exc_info,
            structlog.processors.JSONRenderer(),
        ]
    else:
        processors = shared_processors + [
            structlog.dev.ConsoleRenderer(colors=True),
        ]
    
    structlog.configure(
        processors=processors,
        wrapper_class=structlog.make_filtering_bound_logger(
            getattr(logging, log_level.upper())
        ),
        context_class=dict,
        logger_factory=structlog.PrintLoggerFactory(),
        cache_logger_on_first_use=True,
    )


def add_otel_context(logger, method_name, event_dict) -> dict[str, Any]:
    """Add OpenTelemetry trace context to every log event."""
    span = trace.get_current_span()
    if span and span.get_span_context().is_valid:
        ctx = span.get_span_context()
        event_dict["trace_id"] = format(ctx.trace_id, "032x")
        event_dict["span_id"] = format(ctx.span_id, "016x")
    return event_dict
```

## 40.11.3 OpenTelemetry Tracing

```python
# app/core/telemetry.py
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor
from opentelemetry.instrumentation.httpx import HTTPXClientInstrumentor
from opentelemetry.instrumentation.sqlalchemy import SQLAlchemyInstrumentor
from opentelemetry.instrumentation.redis import RedisInstrumentor


def configure_telemetry(app, db_engine):
    """Configure OpenTelemetry tracing for the application."""
    
    resource = Resource.create({
        SERVICE_NAME: "homebot",
        SERVICE_VERSION: settings.VERSION,
    })
    
    provider = TracerProvider(resource=resource)
    otlp_exporter = OTLPSpanExporter(endpoint=settings.OTEL_EXPORTER_OTLP_ENDPOINT)
    provider.add_span_processor(BatchSpanProcessor(otlp_exporter))
    trace.set_tracer_provider(provider)
    
    # Instrument everything
    FastAPIInstrumentor.instrument_app(app)
    HTTPXClientInstrumentor().instrument()
    SQLAlchemyInstrumentor().instrument(engine=db_engine)
    RedisInstrumentor().instrument()


tracer = trace.get_tracer("homebot")
```

## 40.11.4 Prometheus Metrics

```python
# app/core/metrics.py
from prometheus_client import Counter, Histogram, Gauge, Info
from prometheus_fastapi_instrumentator import Instrumentator

# Custom metrics
SCAN_COUNTER = Counter(
    "homebot_scans_total",
    "Total number of barcode scans",
    ["status", "input_method", "provider"]
)

LOOKUP_DURATION = Histogram(
    "homebot_lookup_duration_seconds",
    "Duration of barcode lookups",
    ["provider"],
    buckets=[0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]
)

LLM_DURATION = Histogram(
    "homebot_llm_duration_seconds",
    "Duration of LLM optimization calls",
    ["model"],
    buckets=[0.5, 1.0, 2.5, 5.0, 10.0, 30.0]
)

JOB_QUEUE_SIZE = Gauge(
    "homebot_job_queue_size",
    "Current size of the job queue",
    ["status"]
)

CACHE_OPERATIONS = Counter(
    "homebot_cache_operations_total",
    "Cache operations (hits/misses)",
    ["operation", "cache_type"]
)


def configure_metrics(app):
    """Configure Prometheus metrics for FastAPI."""
    instrumentator = Instrumentator(
        should_group_status_codes=False,
        excluded_handlers=["/metrics", "/health"],
    )
    instrumentator.instrument(app).expose(app, endpoint="/metrics")
```

## 40.11.5 Docker Compose Observability Stack

```yaml
# docker/docker-compose.observability.yml
version: "3.8"

services:
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP

  prometheus:
    image: prom/prometheus:v2.49.1
    ports:
      - "9090:9090"

  loki:
    image: grafana/loki:2.9.4
    ports:
      - "3100:3100"

  promtail:
    image: grafana/promtail:2.9.4
    depends_on:
      - loki

  tempo:
    image: grafana/tempo:2.3.1
    ports:
      - "3200:3200"

  grafana:
    image: grafana/grafana:10.3.1
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
```

## 40.11.6 Grafana Dashboards

Key panels for the Homebot Overview dashboard:

| Panel | Type | Query |
|-------|------|-------|
| Scans per Minute | Timeseries | `rate(homebot_scans_total[1m])` |
| Lookup Latency (P95) | Timeseries | `histogram_quantile(0.95, rate(homebot_lookup_duration_seconds_bucket[5m]))` |
| Cache Hit Rate | Gauge | `sum(rate(homebot_cache_operations_total{operation="hit"}[5m])) / sum(rate(homebot_cache_operations_total[5m]))` |
| Job Queue Status | Stat | `homebot_job_queue_size` |
| Error Rate | Timeseries | `rate(http_requests_total{status=~"5.."}[5m])` |
| Recent Logs | Logs | `{service_name="homebot"}` |

---

## Navigation

- **Previous:** [Installation & Operations](40.10-installation-operations.md)
- **Next:** [Security](40.12-security.md)
- **Back to:** [README](README.md)
