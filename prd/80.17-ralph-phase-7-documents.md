# 80.17 Ralph Phase 7: Documents & Returns

This is the Ralph Wiggum task document for Phase 7 - Paperless integration and return tracking.

---

## Frontmatter

```yaml
phase: 7
name: Documents & Returns
description: Paperless-ngx integration, receipt management, return tracking
test_command: pytest tests/phase7/ -v --tb=short
browser_validation: true
estimated_criteria: 10
```

---

## Overview

Phase 7 completes the system with document management:

- Paperless-ngx integration
- Receipt upload and linking
- Return deadline tracking
- Return state machine
- Grocy API compatibility layer

---

## Acceptance Criteria

### Paperless Integration

- [ ] **[1] [CRITICAL]** Paperless client configured
  - Test: `PaperlessClient` connects to Paperless-ngx
  - Test: Document types created (Receipt, Return Label)

- [ ] **[2] [CRITICAL]** Upload receipt endpoint
  - Test: `POST /api/v2/receipts/upload` sends to Paperless
  - Test: Document ID stored in purchase record

- [ ] **[3] [CORE]** Link documents to purchases
  - Test: Purchase shows linked receipt
  - BrowserMCP: Click receipt link, opens in Paperless

- [ ] **[4] [FLEX]** Receipt OCR parsing (future)
  - Test: OCR extracts store, date, items (when implemented)

### Return Tracking

- [ ] **[5] [CRITICAL]** Return policies and returnable items tables
  - Test: `\d return_policies` shows store, days, conditions
  - Test: `\d returnable_items` shows status, deadline

- [ ] **[6] [CRITICAL]** Return state machine
  - Test: Item progresses through states correctly
  - Test: Invalid state transitions rejected

- [ ] **[7] [CORE]** Return deadline notifications
  - Test: Items approaching deadline flagged
  - BrowserMCP: Dashboard shows "Return by..." warnings

- [ ] **[8] [CORE]** Returns dashboard
  - BrowserMCP: View pending returns sorted by deadline
  - BrowserMCP: Update return status

### Grocy Compatibility

- [ ] **[9] [CORE]** Grocy API facade at `/api/`
  - Test: `GET /api/stock` returns Grocy-compatible format
  - Test: `POST /api/stock/products/{id}/add` works

- [ ] **[10] [FLEX]** Grocy API key authentication
  - Test: `GROCY-API-KEY` header authenticates
  - Test: Scoped permissions per key

---

## Test Command

```bash
# Run all Phase 7 tests
pytest tests/phase7/ -v --tb=short

# Specific test files
pytest tests/phase7/test_paperless.py -v
pytest tests/phase7/test_returns.py -v
pytest tests/phase7/test_grocy_compat.py -v
```

---

## Dependencies

- Phase 6 complete (purchases for receipt linking)
- Paperless-ngx running (Docker Compose)

---

## Files to Create/Modify

```
app/
├── models/
│   ├── return_policy.py     # Store return policies
│   └── returnable_item.py   # Return tracking
├── api/routes/
│   ├── receipts.py          # Receipt upload
│   ├── returns.py           # Return endpoints
│   └── grocy/               # Grocy compat layer
│       ├── __init__.py
│       ├── stock.py
│       ├── products.py
│       └── objects.py
├── services/
│   ├── paperless.py         # Paperless client
│   ├── returns.py           # Return state machine
│   └── grocy_compat.py      # Grocy translation
└── schemas/
    ├── receipt.py
    ├── return_item.py
    └── grocy/
        ├── stock.py
        └── product.py

frontend/src/
├── pages/
│   ├── ReceiptsPage.vue     # Receipt management
│   ├── ReturnsPage.vue      # Returns dashboard
│   └── ReturnDetail.vue     # Individual return
└── components/
    ├── ReceiptUpload.vue
    ├── ReturnCard.vue
    └── ReturnStateIndicator.vue

migrations/versions/
├── 017_return_policies.py
└── 018_returnable_items.py

tests/phase7/
├── test_paperless.py
├── test_receipts.py
├── test_returns.py
├── test_return_states.py
└── test_grocy_compat.py
```

---

## BrowserMCP Validation Checklist

```markdown
1. [ ] Upload receipt, appears in Paperless
2. [ ] Link receipt to purchase
3. [ ] Add returnable item
4. [ ] View returns dashboard
5. [ ] Update return status (received → deciding)
6. [ ] See deadline warning for expiring return
7. [ ] Test Grocy API endpoint
```

---

## Integration Testing

### With Paperless-ngx

```bash
# Ensure Paperless is running
docker-compose -f docker/docker-compose.paperless.yml up -d

# Test connection
curl http://localhost:8001/api/documents/ \
  -H "Authorization: Token $PAPERLESS_TOKEN"
```

### With Grocy Clients

```bash
# Test Grocy API compatibility
curl http://localhost:3334/api/stock \
  -H "GROCY-API-KEY: $API_KEY"
```

---

## Completion Criteria

After Phase 7, the system should support:

- ✅ Full inventory management with locations
- ✅ Barcode scanning and product lookup
- ✅ QR code routing and label printing
- ✅ Recipe and meal planning
- ✅ Shopping list generation
- ✅ Household and consumption tracking
- ✅ Cost tracking with DCA
- ✅ Receipt management via Paperless
- ✅ Return deadline tracking
- ✅ Grocy API compatibility

---

## Navigation

- **Previous:** [Phase 6: Intelligence](80.16-ralph-phase-6-intelligence.md)
- **Next:** [README](README.md) (Phase 7 is the final phase)
- **Back to:** [README](README.md)
