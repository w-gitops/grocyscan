# 40.10 Installation & Operations

## 40.10.1 Deployment Overview

Homebot is deployed to a remote development server via SSH. The architecture includes:

- **Backend**: FastAPI running via uvicorn
- **Frontend**: Vue/Quasar SPA (built and served statically)
- **Database**: PostgreSQL 17 (shared instance)
- **Cache**: Redis
- **Documents**: Paperless-ngx (Docker)
- **Observability**: Grafana stack (Docker)

### Target Server

| Property | Value |
|----------|-------|
| Host | `192.168.200.37` |
| User | `root` |
| Install Path | `/opt/homebot` |
| Service Name | `homebot` |
| Port | 3334 |

## 40.10.2 Installation Script

```bash
#!/bin/bash
# scripts/install.sh
# Homebot Installer for Debian/Ubuntu
# Usage: curl -fsSL https://raw.githubusercontent.com/user/homebot/main/scripts/install.sh | bash

set -e

HOMEBOT_USER="homebot"
HOMEBOT_DIR="/opt/homebot"
HOMEBOT_REPO="https://github.com/yourusername/homebot.git"
PYTHON_VERSION="3.11"

echo "╔════════════════════════════════════════╗"
echo "║       Homebot Installer v2.0           ║"
echo "╚════════════════════════════════════════╝"

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "Error: Please run as root or with sudo"
    exit 1
fi

# Install dependencies
apt-get update -qq
apt-get install -y -qq git curl python${PYTHON_VERSION} python${PYTHON_VERSION}-venv nodejs npm

# Create user
useradd -r -s /bin/bash -m -d /home/$HOMEBOT_USER $HOMEBOT_USER 2>/dev/null || true

# Clone repository
if [ -d "$HOMEBOT_DIR" ]; then
    cd $HOMEBOT_DIR && git pull origin main
else
    git clone $HOMEBOT_REPO $HOMEBOT_DIR
fi

# Setup Python virtual environment
cd $HOMEBOT_DIR
python${PYTHON_VERSION} -m venv venv
./venv/bin/pip install -r requirements.txt

# Build frontend
cd $HOMEBOT_DIR/frontend
npm install
npm run build

# Create .env if not exists
if [ ! -f "$HOMEBOT_DIR/.env" ]; then
    cp $HOMEBOT_DIR/.env.example $HOMEBOT_DIR/.env
    SECRET_KEY=$(openssl rand -hex 32)
    sed -i "s/your-secret-key-change-me/$SECRET_KEY/" $HOMEBOT_DIR/.env
fi

# Create systemd service
cat > /etc/systemd/system/homebot.service << EOF
[Unit]
Description=Homebot Home Inventory Manager
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=$HOMEBOT_USER
WorkingDirectory=$HOMEBOT_DIR
Environment="PATH=$HOMEBOT_DIR/venv/bin"
EnvironmentFile=$HOMEBOT_DIR/.env
ExecStart=$HOMEBOT_DIR/venv/bin/python -m uvicorn app.main:app --host 0.0.0.0 --port 3334
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable homebot

chown -R $HOMEBOT_USER:$HOMEBOT_USER $HOMEBOT_DIR

echo ""
echo "Installation complete!"
echo "Next steps:"
echo "  1. Edit configuration: nano $HOMEBOT_DIR/.env"
echo "  2. Run migrations: cd $HOMEBOT_DIR && ./venv/bin/alembic upgrade head"
echo "  3. Start Homebot: systemctl start homebot"
```

## 40.10.3 Deployment Script (Windows PowerShell)

```powershell
# scripts/deploy.ps1
# Deploy Homebot from Windows to remote server

param(
    [string]$Server = "192.168.200.37",
    [string]$User = "root",
    [string]$Path = "/opt/homebot"
)

$LocalPath = "c:\git\grocyscan"

Write-Host "Deploying Homebot to $User@$Server..."

# Deploy backend files
$backendFiles = @(
    "app",
    "migrations",
    "requirements.txt",
    "alembic.ini"
)

foreach ($file in $backendFiles) {
    Write-Host "Deploying $file..."
    # Use rsync or scp equivalent
}

# Restart service
ssh "$User@$Server" "systemctl restart homebot && sleep 3"

# Check status
ssh "$User@$Server" "systemctl status homebot --no-pager"
```

## 40.10.4 Docker Compose Stack

### Main Application

```yaml
# docker/docker-compose.yml
version: "3.8"

services:
  homebot:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: homebot
    env_file: ../.env
    ports:
      - "3334:3334"
    volumes:
      - homebot-data:/app/data
      - homebot-media:/app/media
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3334/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - homebot-network

  postgres:
    image: postgres:17-alpine
    container_name: homebot-postgres
    environment:
      POSTGRES_USER: homebot
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: homebot
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U homebot"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - homebot-network

  redis:
    image: redis:7-alpine
    container_name: homebot-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - homebot-network

networks:
  homebot-network:

volumes:
  homebot-data:
  homebot-media:
  postgres-data:
  redis-data:
```

### Paperless-ngx Stack

```yaml
# docker/docker-compose.paperless.yml
version: "3.8"

services:
  paperless-webserver:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless
    depends_on:
      - paperless-redis
      - paperless-gotenberg
      - paperless-tika
    ports:
      - "8001:8000"
    environment:
      PAPERLESS_REDIS: redis://paperless-redis:6379
      PAPERLESS_DBENGINE: postgresql
      PAPERLESS_DBHOST: homebot-postgres
      PAPERLESS_DBNAME: paperless
      PAPERLESS_DBUSER: paperless
      PAPERLESS_DBPASS: ${PAPERLESS_DB_PASSWORD}
      PAPERLESS_SECRET_KEY: ${PAPERLESS_SECRET_KEY}
      PAPERLESS_URL: https://paperless.example.com
    volumes:
      - paperless-data:/usr/src/paperless/data
      - paperless-media:/usr/src/paperless/media
      - paperless-export:/usr/src/paperless/export
      - paperless-consume:/usr/src/paperless/consume
    restart: unless-stopped
    networks:
      - homebot-network

  paperless-redis:
    image: redis:7-alpine
    container_name: paperless-redis
    volumes:
      - paperless-redis-data:/data
    restart: unless-stopped
    networks:
      - homebot-network

  paperless-gotenberg:
    image: docker.io/gotenberg/gotenberg:8
    container_name: paperless-gotenberg
    command:
      - "gotenberg"
      - "--chromium-disable-javascript=true"
    restart: unless-stopped
    networks:
      - homebot-network

  paperless-tika:
    image: docker.io/apache/tika:latest
    container_name: paperless-tika
    restart: unless-stopped
    networks:
      - homebot-network

volumes:
  paperless-data:
  paperless-media:
  paperless-export:
  paperless-consume:
  paperless-redis-data:
```

## 40.10.5 Management Commands

### Start/Stop/Restart

```bash
# Start Homebot
sudo systemctl start homebot

# Stop Homebot
sudo systemctl stop homebot

# Restart Homebot
sudo systemctl restart homebot

# Check status
systemctl status homebot

# View logs
journalctl -u homebot -f
```

### Database Operations

```bash
# Run migrations
cd /opt/homebot && ./venv/bin/alembic upgrade head

# Create migration
./venv/bin/alembic revision --autogenerate -m "description"

# Database backup
pg_dump -U homebot homebot > backup_$(date +%Y%m%d).sql

# Database restore
psql -U homebot homebot < backup.sql
```

### Upgrade

```bash
#!/bin/bash
# scripts/upgrade.sh
set -e

HOMEBOT_DIR="/opt/homebot"

echo "Stopping Homebot..."
sudo systemctl stop homebot

echo "Backing up database..."
pg_dump -U homebot homebot > /tmp/homebot_backup_$(date +%Y%m%d_%H%M%S).sql

echo "Pulling latest code..."
cd $HOMEBOT_DIR && git pull origin main

echo "Updating dependencies..."
./venv/bin/pip install -r requirements.txt

echo "Building frontend..."
cd frontend && npm install && npm run build && cd ..

echo "Running migrations..."
./venv/bin/alembic upgrade head

echo "Starting Homebot..."
sudo systemctl start homebot

echo "Upgrade complete!"
```

## 40.10.6 Reverse Proxy Configuration

### Caddy

```caddyfile
homebot.example.com {
    reverse_proxy localhost:3334
}

paperless.example.com {
    reverse_proxy localhost:8001
}

grafana.example.com {
    reverse_proxy localhost:3000
}
```

### Nginx

```nginx
server {
    listen 443 ssl http2;
    server_name homebot.example.com;

    ssl_certificate /etc/ssl/certs/homebot.crt;
    ssl_certificate_key /etc/ssl/private/homebot.key;

    location / {
        proxy_pass http://localhost:3334;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## Navigation

- **Previous:** [UI Specification](30.13-ui-specification.md)
- **Next:** [Observability](40.11-observability.md)
- **Back to:** [README](README.md)
