# CI/CD Pipeline & Deployment

## Architecture

The project uses GitHub Actions for CI/CD with a self-hosted runner on Proxmox for preview deployments.

```
Branch push → CI tests → Docker build → Preview deploy (PR) → Production deploy (main merge)
```

## For Cursor Cloud Agents

Cloud agents cannot SSH to local servers. Use these patterns instead:

### Deploying Changes
1. Commit and push to your branch
2. Create a PR if one doesn't exist: `gh pr create --title "..." --body "..."`
3. CI runs automatically (tests, docker build, preview deploy)
4. Check status: `gh run list --branch <branch>`
5. View logs: `gh run view <run-id> --log`

### Checking Preview Deployments
- Preview URLs are posted as PR comments automatically
- Each PR gets port `10000 + PR_NUMBER` on the Proxmox runner
- Credentials: `admin` / `test`
- Check PR: `gh pr view --json comments`

### Triggering Manual Deploys
```bash
# Trigger preview deploy
gh workflow run preview-deploy.yml -f pr_number=<N>

# Trigger production deploy
gh workflow run deploy-production.yml
```

### Using the Helper Script
```bash
./scripts/cursor-deploy.sh deploy    # Auto-detect environment and deploy
./scripts/cursor-deploy.sh status    # Check CI status
./scripts/cursor-deploy.sh preview   # Get preview URL
./scripts/cursor-deploy.sh trigger   # Trigger workflow manually
```

## For Cursor Desktop Agents

Desktop agents on the local network can use direct SSH deployment:

### Quick Deploy (Direct SSH)
```bash
./scripts/deploy.sh          # Full deploy via rsync + systemd
./scripts/cursor-deploy.sh   # Smart deploy (auto-detects environment)
```

### Direct Server Access
```bash
ssh root@192.168.200.37
journalctl -u grocyscan -f
systemctl restart grocyscan
curl -s http://localhost:3334/health
```

## GitHub Actions Workflows

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `tests.yml` | PR to main/dev | Pytest with Postgres |
| `ui-tests.yml` | PR to main/dev | Playwright E2E |
| `docker-build.yml` | Push to main | Build & push GHCR image |
| `preview-deploy.yml` | PR opened/updated | Deploy preview on Proxmox |
| `preview-cleanup.yml` | PR closed | Tear down preview |
| `deploy-production.yml` | Push to main | Deploy to production |

## Docker Images

- Registry: `ghcr.io/w-gitops/grocyscan`
- Tags: `:latest` (main), `:pr-N` (previews), `:<sha>` (every build)
- Multi-stage: Frontend (Node) + Backend (Python) in one image

## Environments

| Environment | URL | Method |
|-------------|-----|--------|
| Production | `https://grocyscan.ssiops.com` | systemd or Docker on `192.168.200.37` |
| Preview PR #N | `http://<runner-ip>:1000N` | Docker on Proxmox runner |
| Local Dev | `http://localhost:3334` / `:3335` | uvicorn + vite dev |

## Required GitHub Secrets

| Secret | Purpose |
|--------|---------|
| `DEPLOY_SSH_KEY` | SSH key for production server |
| `DEPLOY_HOST` | Production server IP (default: 192.168.200.37) |
| `DEPLOY_USER` | SSH user (default: root) |
