name: Preview Deploy

# Deploy a branch to a preview environment on the self-hosted Proxmox runner.
# Each PR gets its own isolated Docker stack with unique ports.

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to deploy (for manual triggers)"
        required: false
        type: string

concurrency:
  # Only one preview deploy per PR at a time
  group: preview-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read
  pull-requests: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # First, build and push the Docker image for this branch
  build-image:
    name: Build Preview Image
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
      full_image: ${{ steps.tag.outputs.full_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute image tag
        id: tag
        run: |
          PR_NUM="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          if [[ -n "$PR_NUM" ]]; then
            TAG="pr-${PR_NUM}"
          else
            # Sanitize branch name for Docker tag
            TAG=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g' | head -c 128)
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "full_image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}" >> "$GITHUB_OUTPUT"
          echo "Image tag: ${TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.tag.outputs.full_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Then, deploy the image on the self-hosted runner
  deploy-preview:
    name: Deploy Preview
    needs: build-image
    if: github.event.pull_request.draft == false
    runs-on: [self-hosted, linux, proxmox]
    env:
      PREVIEW_ID: pr-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
      PREVIEW_PORT: ""  # Computed in step
      POSTGRES_PORT: "" # Computed in step
    steps:
      - name: Checkout (for compose file)
        uses: actions/checkout@v4

      - name: Compute ports
        id: ports
        run: |
          PR_NUM="${{ github.event.pull_request.number || github.event.inputs.pr_number || '99' }}"
          API_PORT=$((10000 + PR_NUM))
          PG_PORT=$((15000 + PR_NUM))
          echo "api_port=${API_PORT}" >> "$GITHUB_OUTPUT"
          echo "pg_port=${PG_PORT}" >> "$GITHUB_OUTPUT"
          echo "Preview ports: API=${API_PORT}, PG=${PG_PORT}"

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull image
        run: docker pull "${{ needs.build-image.outputs.full_image }}"

      - name: Generate auth password hash
        id: auth
        run: |
          # Generate a hash for the default preview password "test"
          HASH=$(docker run --rm "${{ needs.build-image.outputs.full_image }}" \
            python -c "from app.services.auth import hash_password; print(hash_password('test'))" 2>/dev/null || echo "")
          echo "hash=${HASH}" >> "$GITHUB_OUTPUT"

      - name: Deploy preview stack
        env:
          GROCYSCAN_IMAGE: ${{ needs.build-image.outputs.full_image }}
          PREVIEW_PORT: ${{ steps.ports.outputs.api_port }}
          POSTGRES_PORT: ${{ steps.ports.outputs.pg_port }}
          AUTH_PASSWORD_HASH: ${{ steps.auth.outputs.hash }}
        run: |
          # Stop existing preview if running
          docker compose \
            -f docker/docker-compose.preview.yml \
            -p "grocyscan-${PREVIEW_ID}" \
            down --remove-orphans 2>/dev/null || true

          # Start new preview stack
          docker compose \
            -f docker/docker-compose.preview.yml \
            -p "grocyscan-${PREVIEW_ID}" \
            up -d --wait --timeout 120

          echo "Preview deployed: grocyscan-${PREVIEW_ID}"

      - name: Run migrations
        run: |
          docker exec "grocyscan-${PREVIEW_ID}" \
            python -m alembic upgrade head

      - name: Health check
        id: health
        run: |
          PORT="${{ steps.ports.outputs.api_port }}"
          for i in $(seq 1 30); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${PORT}/health" 2>/dev/null || echo "000")
            if [[ "$STATUS" == "200" ]]; then
              echo "Health check passed on port ${PORT}"
              echo "healthy=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Waiting for health... (attempt ${i}, status=${STATUS})"
            sleep 2
          done
          echo "healthy=false" >> "$GITHUB_OUTPUT"
          echo "WARNING: Health check did not pass, but preview may still be starting"

      - name: Get preview URL
        id: url
        run: |
          # Get the runner's IP address (first non-loopback IPv4)
          RUNNER_IP=$(hostname -I | awk '{print $1}')
          PORT="${{ steps.ports.outputs.api_port }}"
          PREVIEW_URL="http://${RUNNER_IP}:${PORT}"
          echo "url=${PREVIEW_URL}" >> "$GITHUB_OUTPUT"
          echo "Preview URL: ${PREVIEW_URL}"

      - name: Comment on PR
        if: github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.url.outputs.url }}';
            const healthy = '${{ steps.health.outputs.healthy }}' === 'true';
            const imageTag = '${{ needs.build-image.outputs.image_tag }}';
            const prNumber = context.payload.pull_request.number;
            const sha = context.sha.substring(0, 8);

            const status = healthy ? 'ðŸŸ¢ Healthy' : 'ðŸŸ¡ Starting...';

            const body = [
              `## ðŸš€ Preview Deployment`,
              ``,
              `| | |`,
              `|---|---|`,
              `| **URL** | [${previewUrl}](${previewUrl}) |`,
              `| **Status** | ${status} |`,
              `| **Image** | \`${imageTag}\` |`,
              `| **Commit** | \`${sha}\` |`,
              `| **Credentials** | \`admin\` / \`test\` |`,
              ``,
              `> Preview environments are ephemeral and will be destroyed when this PR is closed.`,
            ].join('\n');

            // Find and update existing preview comment, or create new one
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existing = comments.data.find(c =>
              c.body.includes('## ðŸš€ Preview Deployment') &&
              c.user.type === 'Bot'
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
