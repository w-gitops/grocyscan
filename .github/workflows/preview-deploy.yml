name: Preview Deploy

# Deploy a branch to a preview environment on the self-hosted Proxmox runner.
# Each PR gets its own isolated Docker stack with unique ports and an HTTPS
# proxy via Nginx Proxy Manager.
#
# Branching model: feature branches â†’ dev â†’ main
# Previews are created for PRs targeting dev (feature work) or main (release).

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [dev, main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to deploy (for manual triggers)"
        required: false
        type: string

concurrency:
  group: preview-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read
  pull-requests: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PREVIEW_DOMAIN_SUFFIX: preview.grocyscan.ssiops.com

jobs:
  # Build and push the Docker image for this branch
  build-image:
    name: Build Preview Image
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
      full_image: ${{ steps.tag.outputs.full_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute image tag
        id: tag
        run: |
          PR_NUM="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          if [[ -n "$PR_NUM" ]]; then
            TAG="pr-${PR_NUM}"
          else
            TAG=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g' | head -c 128)
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "full_image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.tag.outputs.full_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy the image on the self-hosted runner + create NPM proxy
  deploy-preview:
    name: Deploy Preview
    needs: build-image
    if: github.event.pull_request.draft == false
    runs-on: [self-hosted, linux, proxmox]
    env:
      PREVIEW_ID: pr-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute ports and domain
        id: env
        run: |
          PR_NUM="${{ github.event.pull_request.number || github.event.inputs.pr_number || '99' }}"
          API_PORT=$((10000 + PR_NUM))
          PG_PORT=$((15000 + PR_NUM))
          DOMAIN="pr-${PR_NUM}.${{ env.PREVIEW_DOMAIN_SUFFIX }}"
          RUNNER_IP=$(hostname -I | awk '{print $1}')

          echo "api_port=${API_PORT}" >> "$GITHUB_OUTPUT"
          echo "pg_port=${PG_PORT}" >> "$GITHUB_OUTPUT"
          echo "domain=${DOMAIN}" >> "$GITHUB_OUTPUT"
          echo "runner_ip=${RUNNER_IP}" >> "$GITHUB_OUTPUT"
          echo "Preview: ${DOMAIN} â†’ ${RUNNER_IP}:${API_PORT}"

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull image
        run: docker pull "${{ needs.build-image.outputs.full_image }}"

      - name: Generate auth password hash
        id: auth
        run: |
          HASH=$(docker run --rm "${{ needs.build-image.outputs.full_image }}" \
            python -c "from app.services.auth import hash_password; print(hash_password('test'))" 2>/dev/null || echo "")
          echo "hash=${HASH}" >> "$GITHUB_OUTPUT"

      - name: Deploy preview stack
        env:
          GROCYSCAN_IMAGE: ${{ needs.build-image.outputs.full_image }}
          PREVIEW_PORT: ${{ steps.env.outputs.api_port }}
          POSTGRES_PORT: ${{ steps.env.outputs.pg_port }}
          AUTH_PASSWORD_HASH: ${{ steps.auth.outputs.hash }}
        run: |
          # Stop existing preview if running
          docker compose \
            -f docker/docker-compose.preview.yml \
            -p "grocyscan-${PREVIEW_ID}" \
            down --remove-orphans 2>/dev/null || true

          # Start new preview stack
          docker compose \
            -f docker/docker-compose.preview.yml \
            -p "grocyscan-${PREVIEW_ID}" \
            up -d --wait --timeout 120

      - name: Run migrations
        run: |
          docker exec "grocyscan-${PREVIEW_ID}" \
            python -m alembic upgrade head

      - name: Health check
        id: health
        run: |
          PORT="${{ steps.env.outputs.api_port }}"
          for i in $(seq 1 30); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${PORT}/health" 2>/dev/null || echo "000")
            if [[ "$STATUS" == "200" ]]; then
              echo "Health check passed"
              echo "healthy=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep 2
          done
          echo "healthy=false" >> "$GITHUB_OUTPUT"

      - name: Collect debug info on failure
        id: debug
        if: steps.health.outputs.healthy != 'true'
        run: |
          echo "Health check failed â€” collecting debug info..."
          # Use preview-status.sh debug-bundle if available, otherwise inline
          if [[ -f scripts/preview-status.sh ]]; then
            DEBUG=$(bash scripts/preview-status.sh debug-bundle "${PREVIEW_ID}" 2>&1 || echo "debug-bundle failed")
          else
            DEBUG=$(cat << DEBUGEOF
          ### Preview Debug: ${PREVIEW_ID}

          **Container Status:**
          \`\`\`
          $(docker compose -p "grocyscan-${PREVIEW_ID}" ps 2>&1 || echo "stack not found")
          \`\`\`

          **App Logs (last 40 lines):**
          \`\`\`
          $(docker logs "grocyscan-${PREVIEW_ID}" --tail 40 2>&1 || echo "no logs")
          \`\`\`

          **Postgres Logs (last 15 lines):**
          \`\`\`
          $(docker logs "grocyscan-${PREVIEW_ID}-postgres" --tail 15 2>&1 || echo "no logs")
          \`\`\`
          DEBUGEOF
          )
          fi

          # Truncate to 60000 chars (GitHub comment limit is 65536)
          DEBUG="${DEBUG:0:60000}"

          # Write to file for the next step (multi-line output is hard in GITHUB_OUTPUT)
          echo "$DEBUG" > /tmp/preview-debug.md
          echo "has_debug=true" >> "$GITHUB_OUTPUT"

      - name: Post debug info to PR
        if: steps.debug.outputs.has_debug == 'true' && github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const debug = fs.readFileSync('/tmp/preview-debug.md', 'utf8');
            const prNumber = context.payload.pull_request.number;

            const body = [
              `## ðŸ”´ Preview Deploy Failed`,
              ``,
              `Health check did not pass for PR #${prNumber}. Debug info below.`,
              ``,
              debug,
              ``,
              `> To investigate further: \`ssh root@<deploy-ip>\` then \`./preview-status.sh inspect ${process.env.PREVIEW_ID}\``,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body.substring(0, 65000),
            });

      # ---- NPM Proxy (HTTPS) ----
      - name: Create HTTPS proxy via Nginx Proxy Manager
        id: proxy
        if: env.NPM_API_URL != ''
        env:
          NPM_API_URL: ${{ secrets.NPM_API_URL }}
          NPM_API_EMAIL: ${{ secrets.NPM_API_EMAIL }}
          NPM_API_PASSWORD: ${{ secrets.NPM_API_PASSWORD }}
          NPM_CERT_ID: ${{ secrets.NPM_CERT_ID }}
        run: |
          DOMAIN="${{ steps.env.outputs.domain }}"
          FORWARD_HOST="${{ steps.env.outputs.runner_ip }}"
          FORWARD_PORT="${{ steps.env.outputs.api_port }}"

          PROXY_ID=$(bash scripts/npm-proxy.sh create "$DOMAIN" "$FORWARD_HOST" "$FORWARD_PORT" 2>/dev/null || echo "")

          if [[ -n "$PROXY_ID" ]]; then
            echo "proxy_id=${PROXY_ID}" >> "$GITHUB_OUTPUT"
            echo "https_url=https://${DOMAIN}" >> "$GITHUB_OUTPUT"
            echo "has_https=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_https=false" >> "$GITHUB_OUTPUT"
            echo "WARNING: NPM proxy creation failed â€” preview available via HTTP only"
          fi

      - name: Determine preview URL
        id: url
        run: |
          if [[ "${{ steps.proxy.outputs.has_https }}" == "true" ]]; then
            echo "url=${{ steps.proxy.outputs.https_url }}" >> "$GITHUB_OUTPUT"
          else
            echo "url=http://${{ steps.env.outputs.runner_ip }}:${{ steps.env.outputs.api_port }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on PR
        if: github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.url.outputs.url }}';
            const healthy = '${{ steps.health.outputs.healthy }}' === 'true';
            const hasHttps = '${{ steps.proxy.outputs.has_https }}' === 'true';
            const imageTag = '${{ needs.build-image.outputs.image_tag }}';
            const prNumber = context.payload.pull_request.number;
            const sha = context.sha.substring(0, 8);
            const domain = '${{ steps.env.outputs.domain }}';

            const status = healthy ? 'ðŸŸ¢ Healthy' : 'ðŸŸ¡ Starting...';
            const proto = hasHttps ? 'ðŸ”’ HTTPS' : 'ðŸ”“ HTTP';

            const body = [
              `## ðŸš€ Preview Deployment`,
              ``,
              `| | |`,
              `|---|---|`,
              `| **URL** | [${previewUrl}](${previewUrl}) |`,
              `| **Status** | ${status} |`,
              `| **Protocol** | ${proto} |`,
              `| **Image** | \`${imageTag}\` |`,
              `| **Commit** | \`${sha}\` |`,
              `| **Credentials** | \`admin\` / \`test\` |`,
              ``,
              `> Preview environments are ephemeral and will be destroyed when this PR is closed.`,
            ].join('\n');

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existing = comments.data.find(c =>
              c.body.includes('## ðŸš€ Preview Deployment') &&
              c.user.type === 'Bot'
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
